{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///external \"core-js/modules/es.error.to-string.js\"","webpack:///external \"core-js/modules/es.object.define-property.js\"","webpack:///external \"core-js/modules/es.error.cause.js\"","webpack:///external \"core-js/modules/es.object.to-string.js\"","webpack:///external \"core-js/modules/es.array.iterator.js\"","webpack:///external \"core-js/modules/es.string.iterator.js\"","webpack:///external \"core-js/modules/web.dom-collections.iterator.js\"","webpack:///external \"core-js/modules/es.function.name.js\"","webpack:///external \"core-js/modules/es.symbol.js\"","webpack:///external \"core-js/modules/es.symbol.description.js\"","webpack:///external \"core-js/modules/es.symbol.iterator.js\"","webpack:///external \"core-js/modules/es.array.for-each.js\"","webpack:///external \"core-js/modules/es.array.slice.js\"","webpack:///external \"core-js/modules/es.array.push.js\"","webpack:///external \"core-js/modules/web.dom-collections.for-each.js\"","webpack:///external \"core-js/modules/es.object.create.js\"","webpack:///external \"core-js/modules/es.object.get-prototype-of.js\"","webpack:///external \"core-js/modules/es.object.set-prototype-of.js\"","webpack:///external \"core-js/modules/es.object.proto.js\"","webpack:///external \"core-js/modules/es.promise.js\"","webpack:///external \"path\"","webpack:///external \"core-js/modules/es.symbol.async-iterator.js\"","webpack:///external \"core-js/modules/es.symbol.to-string-tag.js\"","webpack:///external \"core-js/modules/es.json.to-string-tag.js\"","webpack:///external \"core-js/modules/es.math.to-string-tag.js\"","webpack:///external \"core-js/modules/es.array.reverse.js\"","webpack:///external \"core-js/modules/es.array.concat.js\"","webpack:///external \"core-js/modules/es.regexp.exec.js\"","webpack:///external \"core-js/modules/es.weak-set.js\"","webpack:///external \"core-js/modules/es.array.is-array.js\"","webpack:///external \"util\"","webpack:///external \"core-js/modules/es.array.from.js\"","webpack:///external \"core-js/modules/es.regexp.test.js\"","webpack:///external \"express\"","webpack:///external \"core-js/modules/es.object.keys.js\"","webpack:///external \"core-js/modules/es.object.assign.js\"","webpack:///external \"core-js/modules/es.date.to-string.js\"","webpack:///external \"core-js/modules/es.array.join.js\"","webpack:///external \"core-js/modules/es.array.includes.js\"","webpack:///external \"core-js/modules/es.string.match.js\"","webpack:///external \"core-js/modules/es.array.map.js\"","webpack:///external \"crypto\"","webpack:///external \"fs\"","webpack:///external \"core-js/modules/es.regexp.to-string.js\"","webpack:///external \"core-js/modules/es.json.stringify.js\"","webpack:///external \"core-js/modules/es.function.bind.js\"","webpack:///external \"core-js/modules/es.string.includes.js\"","webpack:///external \"winston\"","webpack:///external \"core-js/modules/es.string.replace.js\"","webpack:///external \"core-js/modules/es.array.filter.js\"","webpack:///external \"core-js/modules/es.object.get-own-property-descriptor.js\"","webpack:///external \"stream\"","webpack:///external \"uuid\"","webpack:///external \"firebase-admin\"","webpack:///external \"@sentry/node\"","webpack:///external \"core-js/modules/es.object.get-own-property-descriptors.js\"","webpack:///external \"core-js/modules/es.object.define-properties.js\"","webpack:///external \"morgan\"","webpack:///external \"core-js/modules/es.string.trim.js\"","webpack:///external \"core-js/modules/es.object.entries.js\"","webpack:///external \"core-js/modules/es.reflect.to-string-tag.js\"","webpack:///external \"core-js/modules/es.reflect.construct.js\"","webpack:///external \"hbs\"","webpack:///external \"axios\"","webpack:///external \"on-finished\"","webpack:///external \"file-type\"","webpack:///external \"newrelic\"","webpack:///external \"image-size\"","webpack:///external \"core-js/modules/es.parse-float.js\"","webpack:///external \"core-js/modules/web.timers.js\"","webpack:///external \"core-js/modules/es.array.sort.js\"","webpack:///external \"core-js/modules/es.number.to-fixed.js\"","webpack:///external \"core-js/modules/es.weak-map.js\"","webpack:///external \"formidable\"","webpack:///external \"roddeh-i18n\"","webpack:///external \"js-sha256\"","webpack:///external \"@google-cloud/storage\"","webpack:///external \"multer\"","webpack:///external \"ws\"","webpack:///external \"core-js/modules/es.string.starts-with.js\"","webpack:///external \"core-js/modules/es.object.values.js\"","webpack:///external \"cookie-parser\"","webpack:///external \"compression\"","webpack:///external \"helmet\"","webpack:///external \"staticify\"","webpack:///external \"connect-timeout\"","webpack:///external \"js-sha1\"","webpack:///external \"redis\"","webpack:///external \"node-cache\"","webpack:///external \"on-headers\"","webpack:///external \"@sentry/tracing\"","webpack:///external \"debug\"","webpack:///external \"http\"","webpack:///external \"@godaddy/terminus\"","webpack:///external \"url\"","webpack:///external \"http-errors\"","webpack:///external \"core-js/modules/es.string.split.js\"","webpack:///external \"core-js/modules/es.object.from-entries.js\"","webpack:///external \"core-js/modules/es.parse-int.js\"","webpack:///external \"core-js/modules/es.string.replace-all.js\"","webpack:///external \"core-js/modules/es.regexp.constructor.js\"","webpack:///external \"core-js/modules/es.regexp.dot-all.js\"","webpack:///external \"core-js/modules/es.regexp.sticky.js\"","webpack:///external \"core-js/modules/es.array-buffer.constructor.js\"","webpack:///external \"core-js/modules/es.array-buffer.slice.js\"","webpack:///external \"core-js/modules/es.typed-array.uint8-array.js\"","webpack:///external \"core-js/modules/es.typed-array.at.js\"","webpack:///external \"core-js/modules/es.typed-array.copy-within.js\"","webpack:///external \"core-js/modules/es.typed-array.every.js\"","webpack:///external \"core-js/modules/es.typed-array.fill.js\"","webpack:///external \"core-js/modules/es.typed-array.filter.js\"","webpack:///external \"core-js/modules/es.typed-array.find.js\"","webpack:///external \"core-js/modules/es.typed-array.find-index.js\"","webpack:///external \"core-js/modules/es.typed-array.find-last.js\"","webpack:///external \"core-js/modules/es.typed-array.find-last-index.js\"","webpack:///external \"core-js/modules/es.typed-array.for-each.js\"","webpack:///external \"core-js/modules/es.typed-array.includes.js\"","webpack:///external \"core-js/modules/es.typed-array.index-of.js\"","webpack:///external \"core-js/modules/es.typed-array.iterator.js\"","webpack:///external \"core-js/modules/es.typed-array.join.js\"","webpack:///external \"core-js/modules/es.typed-array.last-index-of.js\"","webpack:///external \"core-js/modules/es.typed-array.map.js\"","webpack:///external \"core-js/modules/es.typed-array.reduce.js\"","webpack:///external \"core-js/modules/es.typed-array.reduce-right.js\"","webpack:///external \"core-js/modules/es.typed-array.reverse.js\"","webpack:///external \"core-js/modules/es.typed-array.set.js\"","webpack:///external \"core-js/modules/es.typed-array.slice.js\"","webpack:///external \"core-js/modules/es.typed-array.some.js\"","webpack:///external \"core-js/modules/es.typed-array.sort.js\"","webpack:///external \"core-js/modules/es.typed-array.subarray.js\"","webpack:///external \"core-js/modules/es.typed-array.to-locale-string.js\"","webpack:///external \"core-js/modules/es.typed-array.to-string.js\"","webpack:///external \"core-js/modules/es.array.index-of.js\"","webpack:///external \"core-js/modules/es.map.js\"","webpack:///external \"buffer\"","webpack:///external \"core-js/modules/es.date.now.js\"","webpack:///external \"core-js/modules/es.array.flat-map.js\"","webpack:///external \"core-js/modules/es.array.unscopables.flat-map.js\"","webpack:///external \"core-js/modules/es.number.constructor.js\"","webpack:///external \"core-js/modules/es.array.reduce.js\"","webpack:///external \"core-js/modules/es.reflect.get.js\"","webpack:///./src/routes/index.js","webpack:///./src/shared/i18n.js","webpack:///./src/models/tools/Uri.js","webpack:///./src/shared/envShared.js","webpack:///./src/shared/simpleCrypto.js","webpack:///./src/routes/helpers.js","webpack:///./src/config/envHelpers.js","webpack:///./src/config/env.js","webpack:///./src/instrumentation/logger.js","webpack:///./src/middlewares/expressAsync.js","webpack:///./src/models/redisFactory.js","webpack:///./src/config/redis.js","webpack:///./src/utils/time.js","webpack:///./src/models/database/RateLimit.js","webpack:///./src/utils/TagSet.js","webpack:///./src/utils/RichError.js","webpack:///./src/middlewares/rateLimit.js","webpack:///./src/models/tools/idGenerator.js","webpack:///./src/models/clients/QuickSimulationClient.js","webpack:///./src/models/storage/storageFactory.js","webpack:///./src/models/storage/GcloudPresignedCredentialsProvider.js","webpack:///./src/models/tools/TimeoutManager.js","webpack:///./src/shared/otp.js","webpack:///./src/routes/instant_simulations.js","webpack:///./src/models/database/Database.js","webpack:///./src/models/tools/sanitizer.js","webpack:///./src/models/database/SmileTask.js","webpack:///./src/models/tools/Enum.js","webpack:///./src/shared/signer.js","webpack:///./src/middlewares/smileTaskSecurity.js","webpack:///./src/cache/InMemory.js","webpack:///./src/models/database/ApiClient.js","webpack:///./src/models/database/User.js","webpack:///./src/middlewares/getModel.js","webpack:///./src/models/storage/SmileResourcesGuide.js","webpack:///./src/routes/api/smile_tasks.js","webpack:///./src/models/storage/simulationResultsUploader.js","webpack:///./src/models/tools/normalizer.js","webpack:///./src/models/tools/validator.js","webpack:///./src/models/database/QuickSimulation.js","webpack:///./src/instrumentation/metrics.js","webpack:///./src/middlewares/api.js","webpack:///./src/middlewares/cors.js","webpack:///./src/utils/imgHelpers.js","webpack:///./src/utils/BufferWritable.js","webpack:///./src/middlewares/quickApi.js","webpack:///./src/models/tools/TimeoutManagerV2.js","webpack:///./src/middlewares/timeout.js","webpack:///./src/middlewares/metrics.js","webpack:///./src/routes/router/base.js","webpack:///./src/routes/router/cors.js","webpack:///./src/routes/router/quick.js","webpack:///./src/routes/api/quick_simulations.js","webpack:///./src/models/storage/smileTaskStorage.js","webpack:///./src/routes/internal_api/smile_tasks.js","webpack:///./src/routes/webhooks/smile_tasks.js","webpack:///./src/config/metrics.js","webpack:///./src/config/config.js","webpack:///./src/middlewares/morganLogger.js","webpack:///./src/app.js","webpack:///./src/websockets/Timeout.js","webpack:///./src/websockets/LocalWebsocketServer.js","webpack:///./src/websockets/WebsocketServer.js","webpack:///./src/boot.js"],"names":["installedModules","__webpack_require__","moduleId","exports","module","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","prototype","hasOwnProperty","p","s","require","router","express","Router","req","res","status","send","i18n","translator","add","values","Uri","fullUri","match","this","protocol","user","domainAndPort","path","str","envShared","process","env","DENTRINO_API_SECRET_TOKEN","DENTRINO_MAX_UPLOAD_SIZE_MB","maxUploadSizeMb","DENTRINO_INSTSIM_SECRET_TOKEN","DENTRINO_INSTSIM_RECAPTCHA_CLIENT_KEY","DENTRINO_INSTSIM_FIREBASE_API_KEY","DENTRINO_INSTSIM_FIREBASE_AUTH_DOMAIN","DENTRINO_INSTSIM_FIREBASE_PROJECT_ID","DENTRINO_INSTSIM_FIREBASE_STORAGE_BUCKET","DENTRINO_INSTSIM_FIREBASE_MESSAGING_SENDER_ID","DENTRINO_INSTSIM_FIREBASE_APP_ID","DENTRINO_INSTSIM_FIREBASE_MEASUREMENT_ID","simpleCrypto","params","padding","b64","Buffer","from","toString","replace","encodeURIComponent","base64","base64Decode","decodeURIComponent","s1","_sha1","update","hex","s256","_sha256","pass","hmac","contentBuffer","iv","crypto","randomBytes","salt","secret","scryptSync","cipher","createCipheriv","ciphered","concat","ivStr","saltStr","join","err","console","warn","encrypted","decrypted","split","cipheredStr","decipher","createDecipheriv","m5","createHash","digest","signature","size","uuidChars","uuid","Math","floor","random","length","crypto256Token","uuidToken","helpers","normalizeParamValue","signatureHeader","signatureHeaderName","decoded","data","json","error","normalizedHost","normalizedOriginForCors","allowedHeaders","filter","h","headers","push","setCors","hosts","methods","method","host","getOrigin","normalizeOrigin","defaultProtocol","uri","Array","isArray","set","isSet","form","Promise","resolve","reject","parse","fields","files","binary","mime","parseObjects","entriesListStr","objectKeysOrder","val","entries","map","entry","parts","obj","forEach","inx","FALSE_STRINGS","parseBool","String","trim","toLowerCase","includes","port","NODE_ENV","isTest","isDevelopment","isLocal","DENTRINO_GCLOUD_BUCKET","PORT","parseInt","isNaN","HOST","MASTER_HOST","parsedEntries","googleProjectsEntries","projectId","credentialPath","isAbsolute","credentialCfg","JSON","fs","readFileSync","projectKey","fromEntries","parseGoogleProjects","DENTRINO_GOOGLE_PROJECTS","FIRESTORE_EMULATOR_HOST","undefined","firestoreEmulatorHost","DENTRINO_RATE_LIMIT_DISABLED","DENTRINO_RATE_LIMIT_IGNORE","DENTRINO_RECAPTCHA_IGNORE","SENTRY_DSN","DENTRINO_LOG_LEVEL","DENTRINO_REDIS_HOSTNAME","DENTRINO_REDIS_PORT","db","DENTRINO_REDIS_DB","DENTRINO_REDIS_PUBSUB_DB","amount","parseFloat","DENTRINO_USER_RATE_LIMIT_AMOUNT","timeWindow","DENTRINO_USER_RATE_LIMIT_TIME","DENTRINO_IP_RATE_LIMIT_AMOUNT","DENTRINO_IP_RATE_LIMIT_TIME","DENTRINO_CLIENT_RATE_LIMIT_AMOUNT","DENTRINO_CLIENT_RATE_LIMIT_TIME","DENTRINO_SIMULATION_WORKER_CONTENT_ENCRYPTION_SECRET","DENTRINO_API_RESPONSES_WITH_ALL_DEBUG_DATA","DENTRINO_QAPI_ROUTE_TIMEOUT","DENTRINO_QAPI_SIMULATION_QUEUE_TIMEOUT","DENTRINO_QAPI_INPUT_UPLOAD_TIMEOUT","DENTRINO_QAPI_SIMULATION_TIMEOUT","DENTRINO_QAPI_RECAPTCHA_TIMEOUT","DENTRINO_QAPI_RESULTS_UPLOAD_TIMEOUT","DENTRINO_QAPI_MAX_UPLOAD_SIZE_MB","quickApiMaxUploadSizeMb","DENTRINO_QAPI_RLIMIT_TIME_WINDOW_SECONDS","DENTRINO_QAPI_RLIMIT_CLIENT_SIMULATIONS_PER_SECOND","DENTRINO_QAPI_RLIMIT_CLIENT_REQUESTS_PER_SECOND","DENTRINO_QAPI_RLIMIT_IP_SIMULATIONS_PER_SECOND","DENTRINO_QAPI_RLIMIT_IP_REQUESTS_PER_SECOND","quickApiRateLimit_clientSimulationsPerSecond","quickApiRateLimit_timeWindowSeconds","quickApiRateLimit_clientRequestsPerSecond","quickApiRateLimit_ipSimulationsPerSecond","quickApiRateLimit_ipRequestsPerSecond","DENTRINO_SUPPORTED_IMAGES","supportedImagesStr","replaceAll","RegExp","DENTRINO_INSTSIM_IP_RATE_LIMIT_MINUTELY_AMOUNT","DENTRINO_INSTSIM_IP_RATE_LIMIT_HOURLY_AMOUNT","DENTRINO_INSTSIM_IP_RATE_LIMIT_DAILY_AMOUNT","DENTRINO_INSTSIM_UPLOAD_TIMEOUT","DENTRINO_INSTSIM_ROUTE_TIMEOUT","DENTRINO_INSTSIM_ESTIMATED_DURATION","DENTRINO_INSTSIM_MIX_FACTOR","DENTRINO_INSTSIM_BRIGHTNESS","DENTRINO_INSTSIM_WHITEN","DENTRINO_INSTSIM_POISSON","instSimRouteTimeout","instSimEstimatedDuration","DENTRINO_INSTSIM_ROUTER","DENTRINO_INSTSIM_TOKEN_DISABLED","DENTRINO_INSTSIM_RECAPTCHA_SECRET_KEY","DENTRINO_INSTSIM_DISABLE_X_FORWARDED_FOR_CHECK","logger","winston","createLogger","level","logLevel","levels","info","http","verbose","debug","debugverbose","silly","format","combine","errors","stack","timestamp","printf","message","label","msg","transports","Console","asyncRoute","func","asyncMiddleware","typename","skipNextCallOnSuccess","next","nextCalled","wrappedNext","args","promise","asPromise","then","invokeMiddleware","middleware","arg","invokeMiddlewares","middlewares","f","Error","redisFactory","config","overwriteConfig","finalConfig","assign","redis","client","createClient","on","isOnline","newRedis","redisPubsub","buffersRedis","return_buffers","newRedisPubsub","allSubscribers","promisify","flushall","redisSubscribe","channel","subscriber","duplicate","unsubscribe","quit","subscribe","timeInSeconds","getMultipliers","oneSecond","getNowInSecs","getNowInMillis","Date","getTime","nowReadable","toLocaleString","hour12","seconds","milliseconds","microseconds","nanoseconds","minutes","hours","days","secs","mins","millis","micros","nanos","MILLISECONDS","MICROSECONDS","NANOSECONDS","SECONDS","MINUTES","HOURS","DAYS","SECS","MINS","MILLIS","MICROS","NANOS","zcountAsync","zcount","NAMESPACE","RateLimit","limit","expiresIn","buckets","countNow","rateLimitDisabled","bucketKeys","bucket","bucketKey","id","all","results","allowed","usedSlotsCount","isAvailable","rateLimitIgnore","zadd","pexpire","TagSet","tags","originalLabel","originalValue","keys","isProduction","g1","valType","RichError","subtype","httpCode","debugMessage","publicMessage","subtypeIsPublic","cause","debugDetails","originalCause","debugId","addDebugDetails","nonRichError","code","opts","logText","details","text","logTextFor","stringify","isDebug","allInfo","dt","errorLog","asArray","buffer","ArrayBuffer","Uint8Array","newObj","startsWith","constructor","asStr","simpleTypesCount","areAllNumbers","maxLength","simplified","slice","rateLimit","lookup","ip","onBlocked","countIf","limitObj","countAtBeginning","ids","apply","useSlotFrom","onFinished","manualCountFor","idGenerator","uuidSize","reverseTimestamp","urlSafeBase64","genericUUID","newSecret","readfile","readFile","redisGet","redisSetex","setex","redisDel","del","redisGetSafe","redisDelSafe","QuickSimulationClient","photo","photoPath","expiresAt","options","safe","newOrderedId","photoRedisKey","photoBuffer","pubsubChannel","pubsubResponseKey","result","before","morphed","original","success","photoEncrypted","photo_redis_key","expires_at","publishedMessage","publish","pubsubRequestKey","messageStr","resultRedisKey","beforeRedisKey","morphedRedisKey","content","resultPhoto","beforePhoto","morphedMouth","response","errorObj","decrypt","workerContentEncryptionSecret","encrypt","errorTag","storageFactory","googleProjects","Storage","keyFilename","GcloudPresignedCredentialsProvider","keyName","expiresInSeconds","contentType","contentMD5","maxSizeInMegabytes","extensionHeaders","version","action","expires","now","contentMd5","file","getSignedUrl","url","uploadHeaders","virtualHostedStyle","gcloudBucket","verb","TimeoutManager","externalTimedout","onTimeout","timedout","blownTimeout","behavior","timeoutSecs","timeoutId","race","setTimeout","e","clearTimeout","hasTimedout","otp","epochTime","timeCounter","token","currentToken","previousToken","sha1","epochTimeSecs","round","minutelyIpRateLimit","instSimIpRateLimitMinutely","_","hourlySuccessIpRateLimit","instSimIpRateLimitHourly","statusCode","locals","dentInstSimIsErrorPage","dailyIpRateLimit","instSimIpRateLimitDaily","errorInfo","getErrorInfo","isSimulationError","errorFullMessage","fullMessage","errorPrettyMessage","prettyMessage","originalExt","photoExt","uploadToFirestoreData","simulationParams","error_message","error_code","errorCode","is_simulation_error","render","buildParams","subtitle","simulation","folder","originalKey","resultKey","beforeKey","morphedKey","uploads","upload","prettyJSON","signedUrls","gcloudSigner","build","urlToGet","getBeforeUrl","getResultUrl","filekey","passthroughStream","stream","PassThrough","write","end","pipe","createWriteStream","buildLayoutParams","title","measurementId","instSimFirebaseMeasurementId","synthTransform","maxFileSize","maxUploadSizeBytes","recaptchaClientKey","instSimRecaptchaClientKey","fullErrorMessage","rateLimitPattern","maxSize","tokenIsValid","otpToken","instSimTokenDisabled","verify","getOtpEpoch","instSimSecretToken","validateRecaptcha","axios","post","instSimRecaptchaSecretKey","score","setupCacheGet","query","transform","epoch","setHeader","timeout","instSimUploadTimeout","formidable","multiples","maxFieldsSize","allowEmptyFiles","timeoutManager","pause","exec","parseForm","nowMillis","recaptchaToken","extname","originalFilename","filepath","supportedImagesFilepathRegex","instSimGiveUpStartTimeout","simOpts","brightness","instSimBrightness","whiten","instSimWhiten","poisson","instSimPoisson","ortho","instSimMixFactor","requestSimulation","beforeUrl","resultUrl","errorHandler","Database","connection","objPath","overwrite","attrs","adaptObj","merge","collectionName","collection","rawResults","raw","objsPath","fullPath","COLLECTION_NAME","ref","normalizePath","got","exists","app","databaseURL","firestore","database","instances","instance","date","admin","Timestamp","fromDate","firebaseObj","doc","attr","toDate","part","sanitizer","allowedKeys","sanitized","RequesterType","properties","_properties","REQUESTER_METADATA","patient","pathPattern","inhouseClient","METADATA_WHITELIST","SmileTask","createdAt","imageMD5","userId","clientId","filepathUploaded","filepathResult","filepathPreprocessed","filepathSideBySide","filepathSideBySideSmall","metadata","requester","save","onlyKeys","filename","uploadsDir","requesterType","startQuery","getResults","newId","toTimestamp","type","pattern","k","signer","serialize","sign","clientSecret","apiSecretToken","v","pairs","sort","a","b","serialized","smileTaskSecurity","getSignature","respondError","dentClientId","dentSignature","body","dentImageMD5","dentImageContentType","receivedSignature","dentUser","dentClient","apiVerify","allInstances","InMemory","cache","cacheTTL","staleTTL","keepCache","keepStale","cacheKey","staleKey","flushAll","op","skipCache","cKey","cached","clear","nodeCache","NodeCache","stdTTL","useClones","checkperiod","deleteOnExpire","maxKeys","setCommands","ttl","sKey","mset","staled","Cache","ApiClient","exposedSecret","updatedAt","revoked","apisConfig","default","api","configValue","maxSuccessesPerSecond","rateLimitCfg","minScore","recaptchaCfg","wrap","apiId","clients","flatMap","apiAllowedHosts","idSuffix","User","email","fullName","company","where","getModel","smileTaskId","smileTask","dentSmileTask","SmileResourcesGuide","credentialsProvider","overwriteImageName","jsonToUpload","userRateLimit","ipRateLimit","clientRateLimit","security","getContentType","getImageMD5","verifySignature","manualReview","resources","uploadDescriptorTask","uploadDescriptor","originalPath","resultPath","preprocessedPath","sideBySidePath","sideBySideSmallPath","progressWebsocket","me","googleProjectKey","uploadsConfig","root","folderpath","rawUploadsConfig","cfgKey","cfg","FileType","fromBuffer","extension","ext","extensionPlaceholder","rawCfg","getUrl","isPublic","rawUpload","up","uploadTasks","urlPromises","getUrlSigned","predefinedAcl","publicUrl","simulationResultsUploader","FLOAT_REGEXP","normalizer","validator","addTo","condition","optional","fieldName","min","max","vmin","Number","MIN_VALUE","vmax","MAX_VALUE","hasMin","hasMax","choices","newErrors","allErrors","STYLE_PARAM_MODE_VALUES","PARAM_MODE_VALUES","PARAM_BLEND_VALUES","MDATA_CAPTURE_VALUES","PARAMS_WHITELIST","STORAGE_WHITELIST","QuickSimulation","storage","skipNormalization","skipValidation","source","sourceOf","normalizeData","validationErrors","toChoicesString","toFloat","validateChoices","validateNumber","mix_factor","addStorageData","addMetadata","addParams","orderBy","orderAsc","filters","field","metrics","newrelic","addCustomAttribute","metricName","startSegment","bytes","dimensions","width","height","area","areaSqrt","recordMetric","clientIsFrontend","dentApiId","dentIsFrontendRoute","callbackId","dentCorsOnError","dentApiTags","newTags","allTags","getTags","addedTags","dentApiInfo","extraInfo","getInfo","addedInfo","richError","fromError","addTags","isFrontEndRoute","getId","requestInfo","envInfo","addInfo","request","reqSize","addRequestBytesMeasure","originalTags","toFixed","reduce","callback","cors","setAllowingCors","origin","originNormalized","normalizedAllowedHosts","allowedHost","imageSize","disableFS","disableTypes","EXIF_ROTATING_ORIENTATIONS","imgHelpers","imgBuffer","orientation","TypeError","Writable","MANDATORY_CLAIMS","multerUpload","multer","memoryStorage","limits","fieldSize","fileSize","quickApiMaxUploadSizeBytes","quickApi","enforce","enforceCors","getAllAllowedHosts","allowedHosts","apiIsEnabled","isRevoked","ipLimiting","clientLimiting","timeWindowMillis","ipLimitRequestsPerSecond","quickApiRateLimit_ipRequestsPerTimeWindow","clientLimitRequestsPerSecond","quickApiRateLimit_clientRequestsPerTimeWindow","ipLimitSimulationsPerSecond","quickApiRateLimit_ipSimulationsPerTimeWindow","hasStartedSimulation","clientLimitSimulationsPerSecond","quickApiRateLimit_clientSimulationsPerTimeWindow","fileKey","dataJson","images","dentParsedBody","customizable","force","bodyData","bodyImages","imgFields","quickSimulation","dentQuickSimulation","queryClientId","parsedToken","tokenProcessed","dentParsedToken","claims","apiRecaptcha","recaptchaIgnore","googleResponse","secretKey","claimsJson","verifySignatureHmac","signatureReceived","claimsJsonReceived","bodyDataJson","paramsHashed","hashesKeys","hashedParamsOnTokenClaims","keysReceivedOnBody","keysLength","hash","verificationHash","md5","paramHashReceived","paramHashExpected","dentSimulationWasStarted","rawBodyJson","any","allFiles","originalname","filenameExtension","fieldname","addImageBytesMeasure","receivedFile","multipartData","imgParamsReceived","getExtension","receivedPhotoType","getDimensions","sqrt","addImageDimensionsMeasure","b64Claims","receivedToken","claimKey","receivedClaims","mandatoryClaims","receivedClaimsInBase64","tagValue","len","onBlow","expiredTimeout","timeouts","onBlowCb","callbacks","operation","extraData","blowIfTimedout","start","nowSecs","timeoutObj","startedAt","duration","clearId","clearAll","expiresAtSecs","nextExpiresAtInSeconds","minExpiresAt","blowIfTimedoutSync","waitForTimeout","cb","manager","dentTimeout","overrideHttpCode","onHeaders","getManager","stopwatch","BasicRouter","handlers","kwargs","put","CorsRouter","routeIdKey","setId","ensure","enforcePreflightCors","parseAuthToken","validateClient","validateApiVisibility","validateBodyData","QuickRouter","dataToQuickSimulation","blend","newQuickSimulationRoute","styleMode","mixFactor","simulationId","apiClient","customGoogleProject","dbSimulation","newNotFoundError","simulationAsJson","customBucket","quickApiSimulationTimeout","nextTimeout","queueTimeout","quickApiSimulationQueueTimeout","setSimulationStarted","buildJobOptions","newServerError","quickApiResultsUploadTimeout","uploadResults","resultName","directoryPath","smileTaskStorage","temporaryFilepath","filepathUploadedToReview","permanentFilepath","getFiles","prefix","resultsDirectory","delimiter","items","storageObj","isTransformed","brightnessMatch","mixFactorMatch","whitenMatch","blendMatch","synthBrightness","synthMixFactor","synthWhiten","blending","synthType","luminance","resultId","urlSafeBase64Decode","newFilepath","move","exist","renameReviewedImage","renameUploadedImageToForceRerun","hasFinished","listResultCandidates","candidates","renameChosenResult","statusFromMessage","evt","event","step","addCallback","addTag","Handlebars","registerHelper","databaseConfig","firestoreEmulatorDatabaseUrl","credential","cert","initializeApp","setInstance","truncateEnd","morgan","parsedBody","imgs","dataTokens","valstr","util","inspect","keyTruncated","imgTokens","mimetype","sizeMb","initSize","endSize","truncateMiddle","dataDesc","imgDesc","morganLogger","isNonLocal","Sentry","dsn","sentryDsn","integrations","Http","tracing","Tracing","Express","enable","__dirname","use","disableXForwardedForCheck","header","requestHandler","urlencoded","extended","buf","encoding","compression","helmet","contentSecurityPolicy","crossOriginEmbedderPolicy","cookieParser","instSimRouter","publicDirPath","staticify","buildStaticify","getVersionedPath","nonWwwHost","hostAndPath","redirect","instantSimulations","indexRouter","apiSmileTasks","apiQuickSimulations","internalApiSmileTasks","webhooksSmileTasks","convertToRichError","errLogLevel","apiResponsesWithAllDebugData","Timeout","canceled","onexpiration","restart","expired","executed","scheduleExpiration","timeoutid","LocalWebsocketServer","socket","onTerminate","onReceive","inactiveTimeout","server","setupWebsocketServer","setupRedisPubSub","setupInactiveTimeout","head","handleUpgrade","ws","emit","close","destroy","cancel","WebSocket","Server","noServer","terminate","pubsubKey","sendToClients","onExpiration","readyState","OPEN","WebsocketServer","localServers","generalRedis","pathname","taskId","task","findOrCreateLocalServer","upgradeRequestToWSConnection","wsServer","singleton","onUpgrade","build_debug","createServer","createTerminus","healthChecks","listen","syscall","exit","addr","address","log","upgradeRequestsOn"],"mappings":"aACE,IAAIA,EAAmB,GAGvB,SAASC,EAAoBC,GAG5B,GAAGF,EAAiBE,GACnB,OAAOF,EAAiBE,GAAUC,QAGnC,IAAIC,EAASJ,EAAiBE,GAAY,CACzCG,EAAGH,EACHI,GAAG,EACHH,QAAS,IAUV,OANAI,EAAQL,GAAUM,KAAKJ,EAAOD,QAASC,EAAQA,EAAOD,QAASF,GAG/DG,EAAOE,GAAI,EAGJF,EAAOD,QAKfF,EAAoBQ,EAAIF,EAGxBN,EAAoBS,EAAIV,EAGxBC,EAAoBU,EAAI,SAASR,EAASS,EAAMC,GAC3CZ,EAAoBa,EAAEX,EAASS,IAClCG,OAAOC,eAAeb,EAASS,EAAM,CAAEK,YAAY,EAAMC,IAAKL,KAKhEZ,EAAoBkB,EAAI,SAAShB,GACX,oBAAXiB,QAA0BA,OAAOC,aAC1CN,OAAOC,eAAeb,EAASiB,OAAOC,YAAa,CAAEC,MAAO,WAE7DP,OAAOC,eAAeb,EAAS,aAAc,CAAEmB,OAAO,KAQvDrB,EAAoBsB,EAAI,SAASD,EAAOE,GAEvC,GADU,EAAPA,IAAUF,EAAQrB,EAAoBqB,IAC/B,EAAPE,EAAU,OAAOF,EACpB,GAAW,EAAPE,GAA8B,iBAAVF,GAAsBA,GAASA,EAAMG,WAAY,OAAOH,EAChF,IAAII,EAAKX,OAAOY,OAAO,MAGvB,GAFA1B,EAAoBkB,EAAEO,GACtBX,OAAOC,eAAeU,EAAI,UAAW,CAAET,YAAY,EAAMK,MAAOA,IACtD,EAAPE,GAA4B,iBAATF,EAAmB,IAAI,IAAIM,KAAON,EAAOrB,EAAoBU,EAAEe,EAAIE,EAAK,SAASA,GAAO,OAAON,EAAMM,IAAQC,KAAK,KAAMD,IAC9I,OAAOF,GAIRzB,EAAoB6B,EAAI,SAAS1B,GAChC,IAAIS,EAAST,GAAUA,EAAOqB,WAC7B,WAAwB,OAAOrB,EAAgB,SAC/C,WAA8B,OAAOA,GAEtC,OADAH,EAAoBU,EAAEE,EAAQ,IAAKA,GAC5BA,GAIRZ,EAAoBa,EAAI,SAASiB,EAAQC,GAAY,OAAOjB,OAAOkB,UAAUC,eAAe1B,KAAKuB,EAAQC,IAGzG/B,EAAoBkC,EAAI,GAIjBlC,EAAoBA,EAAoBmC,EAAI,K,gBClFrDhC,EAAOD,QAAUkC,QAAQ,0C,cCAzBjC,EAAOD,QAAUkC,QAAQ,iD,cCAzBjC,EAAOD,QAAUkC,QAAQ,sC,cCAzBjC,EAAOD,QAAUkC,QAAQ,2C,cCAzBjC,EAAOD,QAAUkC,QAAQ,yC,cCAzBjC,EAAOD,QAAUkC,QAAQ,0C,cCAzBjC,EAAOD,QAAUkC,QAAQ,oD,cCAzBjC,EAAOD,QAAUkC,QAAQ,wC,cCAzBjC,EAAOD,QAAUkC,QAAQ,iC,cCAzBjC,EAAOD,QAAUkC,QAAQ,6C,cCAzBjC,EAAOD,QAAUkC,QAAQ,0C,cCAzBjC,EAAOD,QAAUkC,QAAQ,yC,cCAzBjC,EAAOD,QAAUkC,QAAQ,sC,cCAzBjC,EAAOD,QAAUkC,QAAQ,qC,cCAzBjC,EAAOD,QAAUkC,QAAQ,oD,cCAzBjC,EAAOD,QAAUkC,QAAQ,wC,cCAzBjC,EAAOD,QAAUkC,QAAQ,kD,cCAzBjC,EAAOD,QAAUkC,QAAQ,kD,cCAzBjC,EAAOD,QAAUkC,QAAQ,uC,cCAzBjC,EAAOD,QAAUkC,QAAQ,kC,cCAzBjC,EAAOD,QAAUkC,QAAQ,S,cCAzBjC,EAAOD,QAAUkC,QAAQ,gD,cCAzBjC,EAAOD,QAAUkC,QAAQ,+C,cCAzBjC,EAAOD,QAAUkC,QAAQ,6C,cCAzBjC,EAAOD,QAAUkC,QAAQ,6C,cCAzBjC,EAAOD,QAAUkC,QAAQ,wC,cCAzBjC,EAAOD,QAAUkC,QAAQ,uC,cCAzBjC,EAAOD,QAAUkC,QAAQ,sC,cCAzBjC,EAAOD,QAAUkC,QAAQ,mC,cCAzBjC,EAAOD,QAAUkC,QAAQ,yC,cCAzBjC,EAAOD,QAAUkC,QAAQ,S,cCAzBjC,EAAOD,QAAUkC,QAAQ,qC,cCAzBjC,EAAOD,QAAUkC,QAAQ,sC,cCAzBjC,EAAOD,QAAUkC,QAAQ,Y,cCAzBjC,EAAOD,QAAUkC,QAAQ,sC,cCAzBjC,EAAOD,QAAUkC,QAAQ,wC,cCAzBjC,EAAOD,QAAUkC,QAAQ,yC,cCAzBjC,EAAOD,QAAUkC,QAAQ,qC,cCAzBjC,EAAOD,QAAUkC,QAAQ,yC,cCAzBjC,EAAOD,QAAUkC,QAAQ,uC,cCAzBjC,EAAOD,QAAUkC,QAAQ,oC,cCAzBjC,EAAOD,QAAUkC,QAAQ,W,cCAzBjC,EAAOD,QAAUkC,QAAQ,O,cCAzBjC,EAAOD,QAAUkC,QAAQ,2C,cCAzBjC,EAAOD,QAAUkC,QAAQ,yC,cCAzBjC,EAAOD,QAAUkC,QAAQ,wC,cCAzBjC,EAAOD,QAAUkC,QAAQ,0C,cCAzBjC,EAAOD,QAAUkC,QAAQ,Y,cCAzBjC,EAAOD,QAAUkC,QAAQ,yC,cCAzBjC,EAAOD,QAAUkC,QAAQ,uC,cCAzBjC,EAAOD,QAAUkC,QAAQ,6D,cCAzBjC,EAAOD,QAAUkC,QAAQ,W,cCAzBjC,EAAOD,QAAUkC,QAAQ,S,cCAzBjC,EAAOD,QAAUkC,QAAQ,mB,cCAzBjC,EAAOD,QAAUkC,QAAQ,iB,cCAzBjC,EAAOD,QAAUkC,QAAQ,8D,cCAzBjC,EAAOD,QAAUkC,QAAQ,mD,cCAzBjC,EAAOD,QAAUkC,QAAQ,W,cCAzBjC,EAAOD,QAAUkC,QAAQ,sC,cCAzBjC,EAAOD,QAAUkC,QAAQ,yC,cCAzBjC,EAAOD,QAAUkC,QAAQ,gD,cCAzBjC,EAAOD,QAAUkC,QAAQ,4C,cCAzBjC,EAAOD,QAAUkC,QAAQ,Q,cCAzBjC,EAAOD,QAAUkC,QAAQ,U,cCAzBjC,EAAOD,QAAUkC,QAAQ,gB,cCAzBjC,EAAOD,QAAUkC,QAAQ,c,cCAzBjC,EAAOD,QAAUkC,QAAQ,a,cCAzBjC,EAAOD,QAAUkC,QAAQ,e,cCAzBjC,EAAOD,QAAUkC,QAAQ,sC,cCAzBjC,EAAOD,QAAUkC,QAAQ,kC,cCAzBjC,EAAOD,QAAUkC,QAAQ,qC,cCAzBjC,EAAOD,QAAUkC,QAAQ,0C,cCAzBjC,EAAOD,QAAUkC,QAAQ,mC,cCAzBjC,EAAOD,QAAUkC,QAAQ,e,cCAzBjC,EAAOD,QAAUkC,QAAQ,gB,cCAzBjC,EAAOD,QAAUkC,QAAQ,c,cCAzBjC,EAAOD,QAAUkC,QAAQ,0B,cCAzBjC,EAAOD,QAAUkC,QAAQ,W,cCAzBjC,EAAOD,QAAUkC,QAAQ,O,cCAzBjC,EAAOD,QAAUkC,QAAQ,6C,cCAzBjC,EAAOD,QAAUkC,QAAQ,wC,cCAzBjC,EAAOD,QAAUkC,QAAQ,kB,cCAzBjC,EAAOD,QAAUkC,QAAQ,gB,cCAzBjC,EAAOD,QAAUkC,QAAQ,W,cCAzBjC,EAAOD,QAAUkC,QAAQ,c,cCAzBjC,EAAOD,QAAUkC,QAAQ,oB,cCAzBjC,EAAOD,QAAUkC,QAAQ,Y,cCAzBjC,EAAOD,QAAUkC,QAAQ,U,cCAzBjC,EAAOD,QAAUkC,QAAQ,e,cCAzBjC,EAAOD,QAAUkC,QAAQ,e,cCAzBjC,EAAOD,QAAUkC,QAAQ,oB,cCAzBjC,EAAOD,QAAUkC,QAAQ,U,cCAzBjC,EAAOD,QAAUkC,QAAQ,S,cCAzBjC,EAAOD,QAAUkC,QAAQ,sB,cCAzBjC,EAAOD,QAAUkC,QAAQ,Q,cCAzBjC,EAAOD,QAAUkC,QAAQ,gB,cCAzBjC,EAAOD,QAAUkC,QAAQ,uC,cCAzBjC,EAAOD,QAAUkC,QAAQ,8C,cCAzBjC,EAAOD,QAAUkC,QAAQ,oC,cCAzBjC,EAAOD,QAAUkC,QAAQ,6C,cCAzBjC,EAAOD,QAAUkC,QAAQ,6C,cCAzBjC,EAAOD,QAAUkC,QAAQ,yC,cCAzBjC,EAAOD,QAAUkC,QAAQ,wC,cCAzBjC,EAAOD,QAAUkC,QAAQ,mD,cCAzBjC,EAAOD,QAAUkC,QAAQ,6C,cCAzBjC,EAAOD,QAAUkC,QAAQ,kD,cCAzBjC,EAAOD,QAAUkC,QAAQ,yC,cCAzBjC,EAAOD,QAAUkC,QAAQ,kD,cCAzBjC,EAAOD,QAAUkC,QAAQ,4C,cCAzBjC,EAAOD,QAAUkC,QAAQ,2C,cCAzBjC,EAAOD,QAAUkC,QAAQ,6C,cCAzBjC,EAAOD,QAAUkC,QAAQ,2C,cCAzBjC,EAAOD,QAAUkC,QAAQ,iD,cCAzBjC,EAAOD,QAAUkC,QAAQ,gD,cCAzBjC,EAAOD,QAAUkC,QAAQ,sD,cCAzBjC,EAAOD,QAAUkC,QAAQ,+C,cCAzBjC,EAAOD,QAAUkC,QAAQ,+C,cCAzBjC,EAAOD,QAAUkC,QAAQ,+C,cCAzBjC,EAAOD,QAAUkC,QAAQ,+C,cCAzBjC,EAAOD,QAAUkC,QAAQ,2C,cCAzBjC,EAAOD,QAAUkC,QAAQ,oD,cCAzBjC,EAAOD,QAAUkC,QAAQ,0C,cCAzBjC,EAAOD,QAAUkC,QAAQ,6C,cCAzBjC,EAAOD,QAAUkC,QAAQ,mD,cCAzBjC,EAAOD,QAAUkC,QAAQ,8C,cCAzB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","file":"src/start.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 141);\n","module.exports = require(\"core-js/modules/es.error.to-string.js\");","module.exports = require(\"core-js/modules/es.object.define-property.js\");","module.exports = require(\"core-js/modules/es.error.cause.js\");","module.exports = require(\"core-js/modules/es.object.to-string.js\");","module.exports = require(\"core-js/modules/es.array.iterator.js\");","module.exports = require(\"core-js/modules/es.string.iterator.js\");","module.exports = require(\"core-js/modules/web.dom-collections.iterator.js\");","module.exports = require(\"core-js/modules/es.function.name.js\");","module.exports = require(\"core-js/modules/es.symbol.js\");","module.exports = require(\"core-js/modules/es.symbol.description.js\");","module.exports = require(\"core-js/modules/es.symbol.iterator.js\");","module.exports = require(\"core-js/modules/es.array.for-each.js\");","module.exports = require(\"core-js/modules/es.array.slice.js\");","module.exports = require(\"core-js/modules/es.array.push.js\");","module.exports = require(\"core-js/modules/web.dom-collections.for-each.js\");","module.exports = require(\"core-js/modules/es.object.create.js\");","module.exports = require(\"core-js/modules/es.object.get-prototype-of.js\");","module.exports = require(\"core-js/modules/es.object.set-prototype-of.js\");","module.exports = require(\"core-js/modules/es.object.proto.js\");","module.exports = require(\"core-js/modules/es.promise.js\");","module.exports = require(\"path\");","module.exports = require(\"core-js/modules/es.symbol.async-iterator.js\");","module.exports = require(\"core-js/modules/es.symbol.to-string-tag.js\");","module.exports = require(\"core-js/modules/es.json.to-string-tag.js\");","module.exports = require(\"core-js/modules/es.math.to-string-tag.js\");","module.exports = require(\"core-js/modules/es.array.reverse.js\");","module.exports = require(\"core-js/modules/es.array.concat.js\");","module.exports = require(\"core-js/modules/es.regexp.exec.js\");","module.exports = require(\"core-js/modules/es.weak-set.js\");","module.exports = require(\"core-js/modules/es.array.is-array.js\");","module.exports = require(\"util\");","module.exports = require(\"core-js/modules/es.array.from.js\");","module.exports = require(\"core-js/modules/es.regexp.test.js\");","module.exports = require(\"express\");","module.exports = require(\"core-js/modules/es.object.keys.js\");","module.exports = require(\"core-js/modules/es.object.assign.js\");","module.exports = require(\"core-js/modules/es.date.to-string.js\");","module.exports = require(\"core-js/modules/es.array.join.js\");","module.exports = require(\"core-js/modules/es.array.includes.js\");","module.exports = require(\"core-js/modules/es.string.match.js\");","module.exports = require(\"core-js/modules/es.array.map.js\");","module.exports = require(\"crypto\");","module.exports = require(\"fs\");","module.exports = require(\"core-js/modules/es.regexp.to-string.js\");","module.exports = require(\"core-js/modules/es.json.stringify.js\");","module.exports = require(\"core-js/modules/es.function.bind.js\");","module.exports = require(\"core-js/modules/es.string.includes.js\");","module.exports = require(\"winston\");","module.exports = require(\"core-js/modules/es.string.replace.js\");","module.exports = require(\"core-js/modules/es.array.filter.js\");","module.exports = require(\"core-js/modules/es.object.get-own-property-descriptor.js\");","module.exports = require(\"stream\");","module.exports = require(\"uuid\");","module.exports = require(\"firebase-admin\");","module.exports = require(\"@sentry/node\");","module.exports = require(\"core-js/modules/es.object.get-own-property-descriptors.js\");","module.exports = require(\"core-js/modules/es.object.define-properties.js\");","module.exports = require(\"morgan\");","module.exports = require(\"core-js/modules/es.string.trim.js\");","module.exports = require(\"core-js/modules/es.object.entries.js\");","module.exports = require(\"core-js/modules/es.reflect.to-string-tag.js\");","module.exports = require(\"core-js/modules/es.reflect.construct.js\");","module.exports = require(\"hbs\");","module.exports = require(\"axios\");","module.exports = require(\"on-finished\");","module.exports = require(\"file-type\");","module.exports = require(\"newrelic\");","module.exports = require(\"image-size\");","module.exports = require(\"core-js/modules/es.parse-float.js\");","module.exports = require(\"core-js/modules/web.timers.js\");","module.exports = require(\"core-js/modules/es.array.sort.js\");","module.exports = require(\"core-js/modules/es.number.to-fixed.js\");","module.exports = require(\"core-js/modules/es.weak-map.js\");","module.exports = require(\"formidable\");","module.exports = require(\"roddeh-i18n\");","module.exports = require(\"js-sha256\");","module.exports = require(\"@google-cloud/storage\");","module.exports = require(\"multer\");","module.exports = require(\"ws\");","module.exports = require(\"core-js/modules/es.string.starts-with.js\");","module.exports = require(\"core-js/modules/es.object.values.js\");","module.exports = require(\"cookie-parser\");","module.exports = require(\"compression\");","module.exports = require(\"helmet\");","module.exports = require(\"staticify\");","module.exports = require(\"connect-timeout\");","module.exports = require(\"js-sha1\");","module.exports = require(\"redis\");","module.exports = require(\"node-cache\");","module.exports = require(\"on-headers\");","module.exports = require(\"@sentry/tracing\");","module.exports = require(\"debug\");","module.exports = require(\"http\");","module.exports = require(\"@godaddy/terminus\");","module.exports = require(\"url\");","module.exports = require(\"http-errors\");","module.exports = require(\"core-js/modules/es.string.split.js\");","module.exports = require(\"core-js/modules/es.object.from-entries.js\");","module.exports = require(\"core-js/modules/es.parse-int.js\");","module.exports = require(\"core-js/modules/es.string.replace-all.js\");","module.exports = require(\"core-js/modules/es.regexp.constructor.js\");","module.exports = require(\"core-js/modules/es.regexp.dot-all.js\");","module.exports = require(\"core-js/modules/es.regexp.sticky.js\");","module.exports = require(\"core-js/modules/es.array-buffer.constructor.js\");","module.exports = require(\"core-js/modules/es.array-buffer.slice.js\");","module.exports = require(\"core-js/modules/es.typed-array.uint8-array.js\");","module.exports = require(\"core-js/modules/es.typed-array.at.js\");","module.exports = require(\"core-js/modules/es.typed-array.copy-within.js\");","module.exports = require(\"core-js/modules/es.typed-array.every.js\");","module.exports = require(\"core-js/modules/es.typed-array.fill.js\");","module.exports = require(\"core-js/modules/es.typed-array.filter.js\");","module.exports = require(\"core-js/modules/es.typed-array.find.js\");","module.exports = require(\"core-js/modules/es.typed-array.find-index.js\");","module.exports = require(\"core-js/modules/es.typed-array.find-last.js\");","module.exports = require(\"core-js/modules/es.typed-array.find-last-index.js\");","module.exports = require(\"core-js/modules/es.typed-array.for-each.js\");","module.exports = require(\"core-js/modules/es.typed-array.includes.js\");","module.exports = require(\"core-js/modules/es.typed-array.index-of.js\");","module.exports = require(\"core-js/modules/es.typed-array.iterator.js\");","module.exports = require(\"core-js/modules/es.typed-array.join.js\");","module.exports = require(\"core-js/modules/es.typed-array.last-index-of.js\");","module.exports = require(\"core-js/modules/es.typed-array.map.js\");","module.exports = require(\"core-js/modules/es.typed-array.reduce.js\");","module.exports = require(\"core-js/modules/es.typed-array.reduce-right.js\");","module.exports = require(\"core-js/modules/es.typed-array.reverse.js\");","module.exports = require(\"core-js/modules/es.typed-array.set.js\");","module.exports = require(\"core-js/modules/es.typed-array.slice.js\");","module.exports = require(\"core-js/modules/es.typed-array.some.js\");","module.exports = require(\"core-js/modules/es.typed-array.sort.js\");","module.exports = require(\"core-js/modules/es.typed-array.subarray.js\");","module.exports = require(\"core-js/modules/es.typed-array.to-locale-string.js\");","module.exports = require(\"core-js/modules/es.typed-array.to-string.js\");","module.exports = require(\"core-js/modules/es.array.index-of.js\");","module.exports = require(\"core-js/modules/es.map.js\");","module.exports = require(\"buffer\");","module.exports = require(\"core-js/modules/es.date.now.js\");","module.exports = require(\"core-js/modules/es.array.flat-map.js\");","module.exports = require(\"core-js/modules/es.array.unscopables.flat-map.js\");","module.exports = require(\"core-js/modules/es.number.constructor.js\");","module.exports = require(\"core-js/modules/es.array.reduce.js\");","module.exports = require(\"core-js/modules/es.reflect.get.js\");","import express from 'express';\nconst router = express.Router();\n\nrouter.get('/', async (req, res) => {\n  res.status(404).send('Not Found')\n})\n\nrouter.get('/d25e4af/error', async (req, res) => {\n  throw \"Fake Error\"\n})\n\nexport default router\n","import i18n from \"roddeh-i18n\"\n\ni18n.translator.add({\n  values: {\n    'errors:simulations-hourly-limit': 'You have reached your simulations hourly limit, try again in 1 hour.',\n    'errors:simulations-minutely-limit': 'You are sending too much simulations in sequence, please wait 1 minute before trying again.',\n    'errors:simulations-daily-limit': 'You have reached your simulations daily limit, try again tomorrow.',\n    'errors:no-face': \"We couldn't process this photo, please try again with another one.\",\n    'errors:simulation-error': \"An error happened with the simulation, please try again with another photo.\",\n    'errors:unknown-processing-error': 'An error has ocurred, try again later.',\n    'errors:timeout': 'Our servers are busy, please try again in a few minutes.',\n    'errors:upload:image-size-limit': 'Photo exceeds the %{maxSize}mb size limit',\n    'errors:upload:wrong-image-format': 'Photo must be an jpg or png image',\n    'errors:upload:no-file': 'Photo is mandatory',\n    'errors:invalid-recaptcha': 'Invalid recaptcha',\n\n    'errors:simulations-limit': 'You have reached the limit of simulations, try again in 24 hours.',\n    'errors:upload:generic': 'Error on upload, try again later',\n    'progress:polling-fallback': 'Trying to download image. (Retries: %{count}/%{max})',\n    'progress:stages:uploading': 'Uploading',\n    'progress:stages:pre-processing': 'Waiting processing start',\n    'progress:stages:processing-step': 'Processing %{number}/%{maxNumber}',\n    'form:user:name': 'Full Name',\n    'form:user:email': 'Email',\n    'form:user:telephone-number': 'Telephone Number',\n    'form:user:image': 'Photo',\n    'form:label:error': 'Error',\n    'form:submit': 'Start Simulation',\n  }\n})\n\nexport {i18n as i18n}\n","export class Uri {\n    constructor(fullUri) {\n        const match = fullUri.match(/^(([^:]+):\\/\\/)?(([^@\\/]+)@)?([^\\/]+)(\\/.*)?$/)\n        this.protocol = match[2]\n        this.user = match[4]\n        this.domainAndPort = match[5]\n        this.path = match[6] || \"/\"\n\n        this.protocol = typeof(this.protocol) === 'undefined' ? null : this.protocol\n        this.user = typeof(this.user) === 'undefined' ? null : this.user\n        this.path = typeof(this.path) === 'undefined' ? null : this.path\n    }\n\n    toString({protocol=true, user=true, path=true} = {protocol: true, user: true, path: true}) {\n        let str = ''\n        if (protocol && this.protocol) str += `${this.protocol}://`\n        if (user && this.user) str += `${this.user}@`\n        str += this.domainAndPort\n        if (path && this.path) str += this.path\n        return str\n    }\n}","export const envShared = new (class {\n    signatureHeaderName = 'Authorization'\n    deviceIdHeaderName = 'X-DEVICE-ID'\n    apiSecretToken = process.env.DENTRINO_API_SECRET_TOKEN || \"test-api-secret\"\n    maxUploadSizeMb = process.env.DENTRINO_MAX_UPLOAD_SIZE_MB || 15\n    maxUploadSizeBytes = this.maxUploadSizeMb * 1024 * 1024\n    instSimSecretToken = process.env.DENTRINO_INSTSIM_SECRET_TOKEN || \"test-instsim-secret\"\n    instSimRecaptchaClientKey = process.env.DENTRINO_INSTSIM_RECAPTCHA_CLIENT_KEY\n    instSimFirebaseApiKey = process.env.DENTRINO_INSTSIM_FIREBASE_API_KEY\n    instSimFirebaseAuthDomain = process.env.DENTRINO_INSTSIM_FIREBASE_AUTH_DOMAIN\n    instSimFirebaseProjectId = process.env.DENTRINO_INSTSIM_FIREBASE_PROJECT_ID\n    instSimFirebaseStorageBucket = process.env.DENTRINO_INSTSIM_FIREBASE_STORAGE_BUCKET\n    instSimFirebaseMessagingSenderId = process.env.DENTRINO_INSTSIM_FIREBASE_MESSAGING_SENDER_ID\n    instSimFirebaseAppId = process.env.DENTRINO_INSTSIM_FIREBASE_APP_ID\n    instSimFirebaseMeasurementId = process.env.DENTRINO_INSTSIM_FIREBASE_MEASUREMENT_ID\n})()\n","import _sha1 from 'js-sha1'\nimport _sha256 from 'js-sha256'\nimport {v4 as uuid} from 'uuid'\nimport {promisify} from 'util'\nimport crypto from 'crypto'\n\nconst ENCRYPTED_ENCODING = 'base64'\n\nexport const simpleCrypto = new (class {\n    base64(str, params = {padding: true}) {\n        var b64 = Buffer.from(str).toString('base64')\n        return params.padding ? b64 : b64.replace(/=+$/g, '')\n    }\n\n    base64Decode(str) {\n        return Buffer.from(str, 'base64').toString()\n    }\n\n    urlSafeBase64(str) {\n      return encodeURIComponent(\n        this.base64(str, {padding: false})\n        .replace(/\\+/g, '-')\n        .replace(/\\//g, '_')\n      )\n    }\n\n    urlSafeBase64Decode(str) {\n      return this.base64Decode(\n        decodeURIComponent(str)\n          .replace(/-/g, '+')\n          .replace(/_/g, '/')\n      )\n    }\n\n    sha1(str) {\n        const s1 = _sha1.create()\n        s1.update(str)\n        return s1.hex()\n    }\n\n    sha256(str) {\n        const s256 = _sha256.create()\n        s256.update(str)\n        return s256.hex()\n    }\n\n    hmac(str, pass) {\n        const hmac = _sha256.hmac.create(pass)\n        hmac.update(str)\n        return hmac.hex()\n    }\n\n    encrypt(contentBuffer, key) {\n      try {\n        if (typeof(contentBuffer) === 'string') {\n          contentBuffer = Buffer.from(contentBuffer, 'utf8')\n        }\n        const iv = crypto.randomBytes(16)\n        const salt = crypto.randomBytes(32)\n        const secret = crypto.scryptSync(key, salt, 32)\n\n        const cipher = crypto.createCipheriv(\"aes-256-cbc\", secret, iv)\n        const ciphered = Buffer.concat([cipher.update(contentBuffer), cipher.final()])\n        const ivStr = iv.toString(ENCRYPTED_ENCODING)\n        const saltStr = salt.toString(ENCRYPTED_ENCODING)\n        const cipheredStr = ciphered.toString(ENCRYPTED_ENCODING)\n        const encrypted = [cipheredStr, ivStr, saltStr].join(':')\n        return encrypted\n      } catch (err) {\n        console.warn(\"Ignoring encryption error:\", err)\n        return null\n      }\n    }\n\n    decrypt(encrypted, key) {\n      let decrypted = null\n      try {\n        if (typeof(encrypted) !== 'string') {\n          encrypted = encrypted.toString('utf8')\n        }\n        const [cipheredStr, ivStr, saltStr] = encrypted.split(':')\n        const iv = Buffer.from(ivStr, ENCRYPTED_ENCODING)\n        const salt = Buffer.from(saltStr, ENCRYPTED_ENCODING)\n        const ciphered = Buffer.from(cipheredStr, ENCRYPTED_ENCODING)\n        const secret = crypto.scryptSync(key, salt, 32)\n\n        const decipher = crypto.createDecipheriv(\"aes-256-cbc\", secret, iv)\n        decrypted = Buffer.concat([decipher.update(ciphered), decipher.final()])\n      } catch (err) {\n        console.warn(\"Ignoring decryption error:\", err)\n      }\n      return decrypted\n    }\n\n    md5(str) {\n        const m5 = crypto.createHash('md5')\n        m5.update(str)\n        return m5.digest('hex')\n    }\n\n    verifySignatureHmac(signature, str, pass) {\n        return this.hmac(str, pass) == signature\n    }\n\n    genericUUID(size = 10) {\n        const uuidChars = \"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789_-.,!@#$%&*()+=[]{}/\\\\<>;:\".split('')\n        let uuid = \"\"\n        for (let i = 0; i < size; i++) {\n            uuid += uuidChars[Math.floor(Math.random()*uuidChars.length)]\n        }\n        return uuid\n    }\n\n    uuid() {\n      return uuid()\n    }\n\n    newSecret() {\n      const crypto256Token = crypto.randomBytes(32).toString('hex')\n      const uuidToken = uuid()\n      return this.hmac(crypto256Token, uuidToken)\n    }\n})()\n","import formidable from 'formidable'\n\nimport {Uri} from '../models/tools/Uri'\nimport {envShared} from '../shared/envShared'\nimport {simpleCrypto} from '../shared/simpleCrypto'\n\nexport const helpers = new (class {\n  getOrigin(req) {\n    return this.normalizeParamValue(req.get('Origin') || req.get('Referer'))\n  }\n\n  getSignature(req) {\n    const signatureHeader = this.normalizeParamValue(req.get(envShared.signatureHeaderName))\n    if (!signatureHeader) return null\n\n    const match = signatureHeader.match(/^Bearer\\s+(.*)\\s*$/)\n    if (!match) return null;\n\n    const decoded = simpleCrypto.base64Decode(match[1])\n    if (!decoded) return null;\n\n    return decoded;\n  }\n\n  respondError(res, status, data) {\n    return res.status(status).json({error: data})\n  }\n\n  setAllowingCors(req, res) {\n    const normalizedHost = helpers.normalizedOriginForCors(req)\n    if (!normalizedHost) return\n    const allowedHeaders = ['authorization'].filter((h) => req.headers[h])\n    allowedHeaders.push('*')\n    return helpers.setCors(res, {\n      hosts: normalizedHost,\n      methods: req.method,\n      headers: allowedHeaders,\n    })\n  }\n\n  normalizedOriginForCors(req) {\n    const host = helpers.getOrigin(req)\n    if (!host) return undefined\n    return helpers.normalizeOrigin(host, req.protocol)\n  }\n\n  normalizeOrigin(host, defaultProtocol) {\n    if (!host) return\n    const uri = new Uri(host)\n    if (!uri.protocol) uri.protocol = defaultProtocol\n    return uri.toString({path: false})\n  }\n\n  setCors(res, {hosts, methods, headers}) {\n    if (Array.isArray(hosts)) hosts = hosts.join(', ')\n    if (Array.isArray(methods)) methods = methods.join(', ')\n    if (Array.isArray(headers)) headers = headers.join(', ')\n    res.set({\n      \"Access-Control-Allow-Origin\": hosts,\n      \"Access-Control-Allow-Methods\": methods,\n      \"Access-Control-Allow-Headers\": headers,\n    })\n  }\n\n  normalizeParamValue(value) {\n    return this.isSet(value) ? value : null\n  }\n\n  isSet(value) {\n    return typeof(value) === 'string' && value !== '' && typeof(value) !== 'undefined'\n  }\n\n  async parseForm(form, req) {\n    return new Promise((resolve, reject) => {\n      form.parse(req, (err, fields, files) => {\n        if (err) reject(err)\n        else resolve({fields, files})\n      })\n    })\n  }\n\n  toDataUrl(binary, mime) {\n    return `data:${mime};base64,${simpleCrypto.base64(binary)}`\n  }\n})()\n","import fs from 'fs'\nimport path from 'path'\n\nexport function parseObjects(entriesListStr, objectKeysOrder) {\n  const entries = parseList(entriesListStr)\n  if (!entries) return []\n  return entries.map((entry) => {\n    const parts = entry.split(/\\s*[;]\\s*/)\n    const obj = {}\n    parts.forEach((value, inx) => {\n      const key = objectKeysOrder[inx]\n      obj[key] = value\n    })\n    return obj\n  })\n}\n\nexport function parseGoogleProjects(entriesListStr) {\n  const parsedEntries = parseObjects(entriesListStr, ['projectKey', 'projectId', 'credentialPath'])\n  if (!parsedEntries) return {}\n  const googleProjectsEntries = parsedEntries.map((entry) => {\n    if (!entry.projectId) projectId = 'dentrino-local'\n    if (entry.credentialPath) {\n      if (!path.isAbsolute(entry.credentialPath)) {\n        entry.credentialPath = path.resolve(entry.credentialPath)\n      }\n      entry.credentialCfg = JSON.parse(fs.readFileSync(entry.credentialPath))\n    }\n    return [entry.projectKey, entry]\n  })\n\n  return Object.fromEntries(googleProjectsEntries)\n}\n\nexport function normalizePort(val) {\n  var port = parseInt(val, 10);\n\n  if (isNaN(port)) {\n    // named pipe\n    return val;\n  }\n\n  if (port >= 0) {\n    // port number\n    return port;\n  }\n\n  return false;\n}\n\nconst FALSE_STRINGS = ['', 'false', 'undefined', 'null', '0', 'no', '-1']\nexport function parseBool(val) {\n  if (!val) return false\n  val = String(val).trim().toLowerCase()\n  if (!val || FALSE_STRINGS.includes(val)) return false\n  return true\n}\n\nexport function parseList(val) {\n  if (!val) return []\n  if (Array.isArray(val)) return val\n  return val.split(/\\s*[|]\\s*/g)\n}\n\nexport function toFilepathRegex(str) {\n  if (typeof(str) !== 'string') return str\n  str = str.replaceAll(/,/g, '|').replaceAll(/\\s/g, '')\n  return new RegExp(`^(.*\\\\.)?(?<ext>${str})$`, 'i')\n}\n","import {normalizePort, parseBool, parseGoogleProjects, parseList, toFilepathRegex} from './envHelpers'\n\nexport const env = new (class {\n  name = process.env.NODE_ENV || 'development'\n  isProduction = () => this.name === 'production'\n  isStaging = () => this.name === 'staging'\n  isTest = () => this.name === 'test'\n  isDevelopment = () => this.name === 'development'\n  isLocal = () => this.isTest() || this.isDevelopment()\n  isNonLocal = () => !this.isLocal()\n\n  gcloudBucket = process.env.DENTRINO_GCLOUD_BUCKET || 'dentrino-test.appspot.com'\n  port = normalizePort(process.env.PORT || '3000')\n  host = process.env.HOST || '0.0.0.0'\n  masterHost = process.env.MASTER_HOST\n  googleProjects = parseGoogleProjects(process.env.DENTRINO_GOOGLE_PROJECTS || \"default;dentrino-local\")\n  firestoreEmulatorHost = process.env.FIRESTORE_EMULATOR_HOST || (this.isTest() ? 'localhost:8080' : undefined)\n  firestoreEmulatorDatabaseUrl = this.firestoreEmulatorHost ? `http://${this.firestoreEmulatorHost}` : undefined\n  rateLimitDisabled = parseBool(process.env.DENTRINO_RATE_LIMIT_DISABLED)\n  rateLimitIgnore = parseBool(process.env.DENTRINO_RATE_LIMIT_IGNORE)\n  recaptchaIgnore = parseBool(process.env.DENTRINO_RECAPTCHA_IGNORE)\n  sentryDsn = process.env.SENTRY_DSN\n  logLevel = process.env.DENTRINO_LOG_LEVEL\n  redis = {\n      host: process.env.DENTRINO_REDIS_HOSTNAME,\n      port: process.env.DENTRINO_REDIS_PORT,\n      db: process.env.DENTRINO_REDIS_DB,\n  }\n  redisPubsub = {\n      host: process.env.DENTRINO_REDIS_HOSTNAME,\n      port: process.env.DENTRINO_REDIS_PORT,\n      db: process.env.DENTRINO_REDIS_PUBSUB_DB,\n  }\n  userRateLimit = {\n    amount:     parseFloat(process.env.DENTRINO_USER_RATE_LIMIT_AMOUNT || 5),\n    timeWindow: parseFloat(process.env.DENTRINO_USER_RATE_LIMIT_TIME || 1 * 60 * 1000),\n  }\n  ipRateLimit = {\n    amount:     parseFloat(process.env.DENTRINO_IP_RATE_LIMIT_AMOUNT || 20),\n    timeWindow: parseFloat(process.env.DENTRINO_IP_RATE_LIMIT_TIME || 1 * 60 * 60 * 1000),\n  }\n  clientRateLimit = {\n    amount:     parseFloat(process.env.DENTRINO_CLIENT_RATE_LIMIT_AMOUNT || 100),\n    timeWindow: parseFloat(process.env.DENTRINO_CLIENT_RATE_LIMIT_TIME || 1 * 60 * 1000),\n  }\n  workerContentEncryptionSecret = process.env.DENTRINO_SIMULATION_WORKER_CONTENT_ENCRYPTION_SECRET || 'dev-worker-secret'\n  apiResponsesWithAllDebugData = parseBool(process.env.DENTRINO_API_RESPONSES_WITH_ALL_DEBUG_DATA)\n  quickApiRouteTimeout = parseFloat(process.env.DENTRINO_QAPI_ROUTE_TIMEOUT || 60)\n  quickApiSimulationQueueTimeout = parseFloat(process.env.DENTRINO_QAPI_SIMULATION_QUEUE_TIMEOUT || 15)\n  quickApiInputUploadTimeout = parseFloat(process.env.DENTRINO_QAPI_INPUT_UPLOAD_TIMEOUT || 15)\n  quickApiSimulationTimeout = parseFloat(process.env.DENTRINO_QAPI_SIMULATION_TIMEOUT || 15)\n  quickApiRecaptchaTimeout = parseFloat(process.env.DENTRINO_QAPI_RECAPTCHA_TIMEOUT || 15)\n  quickApiResultsUploadTimeout = parseFloat(process.env.DENTRINO_QAPI_RESULTS_UPLOAD_TIMEOUT || 15)\n  quickApiMaxUploadSizeMb = process.env.DENTRINO_QAPI_MAX_UPLOAD_SIZE_MB || 15\n  quickApiMaxUploadSizeBytes = this.quickApiMaxUploadSizeMb * 1024 * 1024\n\n\n  // Rate limiting timeWindow\n  quickApiRateLimit_timeWindowSeconds = parseFloat(process.env.DENTRINO_QAPI_RLIMIT_TIME_WINDOW_SECONDS || 10)\n  // Client rate limiting\n  quickApiRateLimit_clientSimulationsPerSecond = parseFloat(process.env.DENTRINO_QAPI_RLIMIT_CLIENT_SIMULATIONS_PER_SECOND || 6.0)\n  quickApiRateLimit_clientRequestsPerSecond = parseFloat(process.env.DENTRINO_QAPI_RLIMIT_CLIENT_REQUESTS_PER_SECOND || 25.0)\n\n  // IP rate limiting\n  quickApiRateLimit_ipSimulationsPerSecond = parseFloat(process.env.DENTRINO_QAPI_RLIMIT_IP_SIMULATIONS_PER_SECOND || 1.0/3.0)\n  quickApiRateLimit_ipRequestsPerSecond = parseFloat(process.env.DENTRINO_QAPI_RLIMIT_IP_REQUESTS_PER_SECOND || 1.0)\n\n  // On timeWindow amount\n  quickApiRateLimit_clientSimulationsPerTimeWindow = this.quickApiRateLimit_clientSimulationsPerSecond * this.quickApiRateLimit_timeWindowSeconds\n  quickApiRateLimit_clientRequestsPerTimeWindow = this.quickApiRateLimit_clientRequestsPerSecond * this.quickApiRateLimit_timeWindowSeconds\n  quickApiRateLimit_ipSimulationsPerTimeWindow = this.quickApiRateLimit_ipSimulationsPerSecond * this.quickApiRateLimit_timeWindowSeconds\n  quickApiRateLimit_ipRequestsPerTimeWindow = this.quickApiRateLimit_ipRequestsPerSecond * this.quickApiRateLimit_timeWindowSeconds\n\n  supportedImagesStr = process.env.DENTRINO_SUPPORTED_IMAGES || 'jpg,jpeg,png,heic,heif,avif'\n  supportedImagesFilepathRegex = toFilepathRegex(this.supportedImagesStr)\n\n  instSimIpRateLimitMinutely = {\n    amount:     parseFloat(process.env.DENTRINO_INSTSIM_IP_RATE_LIMIT_MINUTELY_AMOUNT || 3),\n    timeWindow: parseFloat(1 * 60 * 1000),\n  }\n  instSimIpRateLimitHourly = {\n    amount:     parseFloat(process.env.DENTRINO_INSTSIM_IP_RATE_LIMIT_HOURLY_AMOUNT || 5),\n    timeWindow: parseFloat(1 * 60 * 60 * 1000),\n  }\n  instSimIpRateLimitDaily = {\n    amount:     parseFloat(process.env.DENTRINO_INSTSIM_IP_RATE_LIMIT_DAILY_AMOUNT || 20),\n    timeWindow: parseFloat(24 * 60 * 60 * 1000),\n  }\n  instSimUploadTimeout = parseFloat(process.env.DENTRINO_INSTSIM_UPLOAD_TIMEOUT || 15)\n  instSimRouteTimeout = parseFloat(process.env.DENTRINO_INSTSIM_ROUTE_TIMEOUT || 60)\n  instSimEstimatedDuration = parseFloat(process.env.DENTRINO_INSTSIM_ESTIMATED_DURATION || 5)\n  instSimMixFactor = parseFloat(process.env.DENTRINO_INSTSIM_MIX_FACTOR || 0.1)\n  instSimBrightness = parseFloat(process.env.DENTRINO_INSTSIM_BRIGHTNESS || 1.0)\n  instSimWhiten = parseFloat(process.env.DENTRINO_INSTSIM_WHITEN || 0.3)\n  instSimPoisson = parseBool(process.env.DENTRINO_INSTSIM_POISSON)\n  instSimGiveUpStartTimeout = this.instSimRouteTimeout - this.instSimEstimatedDuration\n  instSimRouter = parseBool(process.env.DENTRINO_INSTSIM_ROUTER)\n  instSimTokenDisabled = parseBool(process.env.DENTRINO_INSTSIM_TOKEN_DISABLED)\n  instSimRecaptchaSecretKey = process.env.DENTRINO_INSTSIM_RECAPTCHA_SECRET_KEY\n  disableXForwardedForCheck = parseBool(process.env.DENTRINO_INSTSIM_DISABLE_X_FORWARDED_FOR_CHECK)\n})()\n","import winston from 'winston'\nimport {env} from '../config/env'\n\nconst levels = {\n  error: 0,\n  warn: 1,\n  info: 2,\n  http: 3,\n  verbose: 4,\n  debug: 5,\n  debugverbose: 6,\n  silly: 7,\n}\n\nexport const logger = winston.createLogger({\n  level: env.logLevel || 'info',\n  levels: levels,\n  format: winston.format.combine(\n    winston.format.errors({ stack: true }),\n    winston.format.timestamp(),\n    winston.format.printf(({ level, message, label, timestamp, stack}) => {\n      let msg = `${timestamp} [${level}] ${message}`\n      if (stack) msg = `${msg} - ${stack}`\n      return msg\n    })\n  ),\n  transports: [new winston.transports.Console()]\n})\n","import {logger} from '../instrumentation/logger'\n\nexport function asyncRoute(func) {\n  return asyncMiddleware('route', func, {typename: 'async', skipNextCallOnSuccess: true})\n}\n\nexport function asyncMiddleware(name, func, {typename='asyncMiddleware', skipNextCallOnSuccess=false}={}) {\n  return async (req, res, next) => {\n    logger.debugverbose(`[${typename}:${name}] Starting`)\n    let nextCalled = false\n    const wrappedNext = (...args) => {\n      if (nextCalled) {\n        logger.debugverbose(`[asyncMiddleware:${name}] next was called already. skipping call`)\n        return\n      }\n      nextCalled = true\n      if (skipNextCallOnSuccess && args.length === 0) {\n        logger.debugverbose(`[asyncMiddleware:${name}] skip next call on success is enabled. skipping call`)\n        return\n      }\n      logger.debugverbose(`[${typename}:${name}] Calling Next: ${args}`)\n      next(...args)\n      logger.debugverbose(`[${typename}:${name}] After Next`)\n    }\n    const promise = asPromise(async () => {\n      return func(req, res, wrappedNext)\n    })\n    return await promise.then(() => wrappedNext()).catch(wrappedNext)\n  }\n}\n\nexport async function invokeMiddleware(middleware, req, res) {\n  return new Promise((resolve, reject) => {\n    const next = (arg) => {\n      asPromise(arg).then(resolve).catch(reject)\n    }\n    asPromise(async () => middleware(req, res, next))\n  })\n}\n\nexport async function invokeMiddlewares(middlewares, req, res) {\n  for (let i = 0; i < middlewares.length; i++) {\n    const middleware = middlewares[i]\n    await invokeMiddleware(middleware, req, res)\n  }\n}\n\nasync function asPromise(obj) {\n  if (typeof(obj) === 'function') {\n    const f = async () => obj()\n    obj = f()\n  }\n  if (obj instanceof Error) {\n    return Promise.reject(obj)\n  } else if (obj && !!obj.error) {\n    return Promise.reject(obj.error)\n  } else {\n    return Promise.resolve(obj)\n  }\n}\n","import redis from 'redis'\nimport {logger} from '../instrumentation/logger'\nimport {env} from '../config/env'\n\nexport const redisFactory = new (class {\n  newRedis(config = {}, overwriteConfig = false) {\n    const finalConfig = overwriteConfig ? config : Object.assign({}, env.redis, config)\n    const client = redis.createClient(finalConfig)\n    client.on('error', (err) => {\n      logger.error('Error on Redis', err)\n      client.isOnline = false\n    })\n    client.on('ready', () => {\n      client.isOnline = true\n    })\n    return client\n  }\n\n  newRedisPubsub(config = {}) {\n    return this.newRedis(Object.assign({}, env.redisPubsub, config), true)\n  }\n})()\n","import {redisFactory} from '../models/redisFactory'\nimport {promisify} from \"util\"\nimport {logger} from '../instrumentation/logger'\n\nexport const redis = redisFactory.newRedis()\nexport const buffersRedis = redisFactory.newRedis({return_buffers: true})\nexport const redisPubsub = redisFactory.newRedisPubsub()\nexport const clearRedis = promisify(redis.flushall).bind(redis)\nconst allSubscribers = {}\nexport function redisSubscribe(channel) {\n  if (!allSubscribers[channel]) allSubscribers[channel] = []\n  return new Promise((resolve, reject) => {\n    try {\n      const subscriber = redisPubsub.duplicate()\n      allSubscribers[channel].push(subscriber)\n      subscriber.on('message', (channel, message) => {\n        logger.verbose(`MESSAGE RECEIVED ${message}`)\n        subscriber.unsubscribe()\n        subscriber.quit()\n        resolve(message)\n      })\n      subscriber.on('error', (error) => {\n        //logger.verbose('Unhandled redis error', err)\n        reject(error)\n      })\n      subscriber.subscribe(channel)\n    } catch (error) {\n      reject(error)\n    }\n  })\n}\n\nexport function redisUnsubscribeAll({channel}) {\n  if (channel) {\n    const subscribers = allSubscribers[channel]\n    if (subscribers) {\n      subscribers.forEach(subscriber => {\n        subscriber.unsubscribe()\n        subscriber.quit()\n      })\n      delete allSubscribers[channel]\n    }\n  } else {\n    Object.keys(allSubscribers).forEach(channel => redisUnsubscribeAll({channel}))\n  }\n}\n","export const timeInSeconds = getMultipliers({oneSecond: 1.0})\nexport const timeInMillis = getMultipliers({oneSecond: 1000.0})\nexport const timeInMicros = getMultipliers({oneSecond: 1000000.0})\nexport const timeInNanos = getMultipliers({oneSecond: 1000000000.0})\n\nexport function getNowInSecs() {\n  return getNowInMillis() / 1000.0\n}\n\nexport function getNowInMillis() {\n  return new Date().getTime()\n}\n\nexport function nowReadable() {\n  return new Date().toLocaleString('en-US', {hour12: false});\n}\n\nfunction getMultipliers({oneSecond}) {\n  const m = {}\n  m.seconds = oneSecond\n\n  // below seconds\n  m.milliseconds = m.seconds / 1000.0\n  m.microseconds = m.milliseconds / 1000.0\n  m.nanoseconds = m.microseconds / 1000.0\n\n  // above seconds\n  m.minutes = m.seconds * 60.0\n  m.hours = m.minutes * 60.0\n  m.days = m.hours * 24.0\n\n  // shortcuts\n  m.secs = m.seconds\n  m.mins = m.minutes\n  m.millis = m.milliseconds\n  m.micros = m.microseconds\n  m.nanos = m.nanoseconds\n\n  // uppercase\n  m.MILLISECONDS = m.milliseconds\n  m.MICROSECONDS = m.microseconds\n  m.NANOSECONDS = m.nanoseconds\n\n  m.SECONDS = m.seconds\n\n  m.MINUTES = m.minutes\n  m.HOURS = m.hours\n  m.DAYS = m.days\n\n  m.SECS = m.secs\n  m.MINS = m.mins\n  m.MILLIS = m.millis\n  m.MICROS = m.micros\n  m.NANOS = m.nanos\n  return m\n}\n","import {logger} from '../../instrumentation/logger'\nimport {env} from \"../../config/env\"\nimport {redis} from \"../../config/redis\"\nimport {promisify} from \"util\"\nimport {v4 as uuid} from 'uuid'\nimport {getNowInMillis} from '../../utils/time'\n\nconst zcountAsync = promisify(redis.zcount).bind(redis)\n\nconst NAMESPACE = 'dent-rl'\nexport class RateLimit {\n    constructor({limit, expiresIn}) {\n        this.limit = limit\n        this.expiresIn = expiresIn\n    }\n\n    async useSlotFrom(buckets, countNow=true) {\n        if (env.rateLimitDisabled) return true\n        if (typeof(buckets) === 'string') buckets = [buckets]\n        const bucketKeys = buckets.map(bucket => this.#buildBucketKey(bucket))\n        return this.#addSlotInBuckets(bucketKeys, countNow)\n    }\n\n    async manualCountFor(buckets) {\n        if (env.rateLimitDisabled) return true\n        if (typeof(buckets) === 'string') buckets = [buckets]\n        const bucketKeys = buckets.map(bucket => this.#buildBucketKey(bucket))\n        bucketKeys.forEach(bucketKey => this.#addSlotIn(bucketKey))\n    }\n\n    #buildBucketKey(id) {\n        return [NAMESPACE, id].join(':')\n    }\n\n    async #addSlotInBuckets(bucketKeys, countNow=true) {\n        const results = await Promise.all(bucketKeys.map(bucketKey => this.#haveAvailableSlotsIn(bucketKey)))\n        const allowed = !results.includes(false)\n        if (allowed && countNow) {\n            bucketKeys.forEach(bucketKey => this.#addSlotIn(bucketKey))\n        }\n        return allowed\n    }\n\n    async #haveAvailableSlotsIn(bucketKey) {\n      const usedSlotsCount = await zcountAsync(bucketKey, getNowInMillis()-this.expiresIn, '+inf')\n      const isAvailable = usedSlotsCount < this.limit\n      return env.rateLimitIgnore ? true : isAvailable\n    }\n\n    async #addSlotIn(bucketKey) {\n      redis.zadd(bucketKey, getNowInMillis(), uuid())\n      redis.pexpire(bucketKey, this.expiresIn)\n    }\n}\n","import {logger} from '../instrumentation/logger'\nimport {env} from '../config/env'\n\nexport class TagSet {\n  constructor(tags={}) {\n    this.tags = {}\n    this.add(tags)\n  }\n\n  add(label, value) {\n    const originalLabel = label\n    const originalValue = value\n    try {\n      if (typeof(value) === 'undefined' && typeof(label) !== 'string') {\n        let tags = undefined\n        if (label instanceof TagSet) tags = label.tags\n        else if (typeof(label) === 'object' && label !== null) tags = label\n        if (tags) {\n          Object.keys(tags).forEach((l) => this.add(l, tags[l]))\n          return\n        }\n      }\n      label = this.#normalizeLabel(label)\n      value = this.#normalizeValue(value, label)\n      if (!label) throw new Error(`Invalid tag label: ${originalLabel}`)\n      this.tags[label] = value\n    } catch(err) {\n      logger.error(`(ignored on production) Couldn't Add tag pair ${originalLabel}:${originalValue}`)\n      if (!env.isProduction()) {\n        throw err\n      } else {\n        logger.error(err)\n      }\n    }\n  }\n\n  labels() { return Object.keys(this.tags) }\n  values() { return Object.values(this.tags) }\n\n  #normalizeLabel(str) {\n    if (typeof(str) !== 'string') return null\n    str = str.trim()\n    str = str.replace(/[_\\s]/g, '-')\n    str = str.replace(/[^a-zA-Z0-9.:-]/g, '')\n    str = str.replace(/^([A-Z][A-Z]+)/g, (m,g1) => `${g1.toLowerCase()}`)\n    str = str.replace(/(?!^)-*([A-Z]+)/g, (m,g1) => `-${g1.toLowerCase()}`)\n    return str.toLowerCase()\n  }\n\n  #normalizeValue(value, label) {\n    const valType = typeof(value)\n    if (['boolean', 'undefined'].includes(valType) || value === null) return String(value)\n    if (valType !== 'string') throw new Error(`Invalid tag value: ${label}:${value} : Value should be string, boolean, undefined or null`)\n    return value\n  }\n}\n","import util from 'util'\nimport {TagSet} from './TagSet'\nimport {Blob, Buffer} from 'buffer'\n\nexport class RichError extends Error {\n  constructor({id='internal-error', subtype, httpCode, debugMessage, publicMessage, subtypeIsPublic=false, cause, debugDetails={}, tags={}, logLevel='error'}) {\n    debugMessage = debugMessage || publicMessage\n    if (cause) {\n      super(debugMessage)\n      this.originalCause = cause\n      Object.assign(this, cause)\n      this.stack = cause.stack\n    } else {\n      super(debugMessage)\n    }\n    this.debugMessage = debugMessage\n    this.id = id\n    this.subtype = subtype\n    this.subtypeIsPublic = subtypeIsPublic\n    this.debugId = this.id + (this.subtype ? `:${this.subtype}` : '')\n    this.httpCode = httpCode || 500\n    this.debugDetails = {}\n    this.addDebugDetails(debugDetails)\n    this.publicMessage = publicMessage\n    this.logLevel = logLevel\n\n    this.tags = new TagSet()\n    this.tags.add('error:id', this.id)\n    if (this.subtype) {\n      this.tags.add('error:subtype', this.subtype)\n    }\n    this.tags.add('error:is-rich', true)\n    this.tags.add(tags)\n  }\n\n  static fromError(error) {\n    if (error instanceof RichError) return error\n    let debugDetails = { nonRichError: true }\n    if (error && error.error) {\n      const msg = error.error\n      delete error.error\n      Object.assign(debugDetails, error)\n      error = msg\n    }\n    if (typeof(error) === 'string') error = new Error(error)\n    if (!error instanceof Error) return null\n    const richError = new RichError({\n      id: 'nodejs-error',\n      subtype: String(error.code),\n      debugMessage: error.message,\n      cause: error,\n      httpCode: error.status || error.httpCode,\n      tags: {\n        'error:is-rich': false,\n        'error:non-rich:code': String(error.code),\n      },\n      debugDetails: debugDetails,\n    })\n    return richError\n  }\n\n  addTag(label, value) {\n    this.tags.add(label, value)\n  }\n\n  addTags(tags) {\n    this.tags.add(tags)\n  }\n\n  addDebugDetails(details) {\n    Object.assign(this.debugDetails, this.#simplify(details))\n  }\n\n  #simplify(obj) {\n    const t = typeof(obj)\n    if (!obj || (t !== 'string' && t !== 'object')) {\n      return obj\n    }\n\n    const asArray = this.#asArray(obj)\n    if (asArray) {\n      return this.#simplifiedArray(obj, asArray)\n    } else if (t === 'string') {\n      return this.#simplifyString(obj)\n    } else if (t === 'object') {\n      return this.#simplifiedObject(obj)\n    } else {\n      return obj\n    }\n  }\n\n  #asArray(obj) {\n    let asArray = undefined\n    if (obj.buffer instanceof ArrayBuffer) {\n      asArray = [...obj]\n    } else if (obj instanceof ArrayBuffer) {\n      asArray = [...new Uint8Array(obj)]\n    } else if (Array.isArray(obj)) {\n      asArray = obj\n    }\n    return asArray\n  }\n\n  #isTypedArray(obj) {\n    return obj instanceof ArrayBuffer || obj.buffer instanceof ArrayBuffer\n  }\n\n  #simplifiedObject(obj) {\n    const newObj = Object.assign({}, obj)\n\n    Object.entries(obj).forEach(([key, val]) => {\n      if (key.startsWith('_')) {\n        delete newObj[key]\n      } else {\n        newObj[key] = this.#simplify(val)\n      }\n    })\n\n    if (obj.constructor !== Object) {\n      let constructor = obj.constructor ? obj.constructor.name : undefined\n      newObj['[!]CONSTRUCTOR'] = constructor\n    }\n\n    if (Object.keys(obj).length > 25) {\n      let asStr = null\n      try {\n        asStr = JSON.stringify(newObj)\n      } catch {\n        asStr = String(newObj)\n      }\n      return `[!] ${this.#simplify(asStr)}`\n    } else {\n      return newObj\n    }\n  }\n\n  #simplifiedArray(obj, asArray) {\n    if (obj.constructor !== Array) {\n      return this.#simplify({\n        \"[!] CONSTRUCTOR\": obj.constructor.name,\n        \"[!] values\": asArray,\n      })\n    }\n\n    const simpleTypesCount = {\n      'null': 0,\n      'number': 0,\n      'string': 0,\n      'boolean': 0,\n      'undefined': 0,\n      'all': 0,\n    }\n    obj.forEach((val) => {\n      const t = val === null ? 'null' : typeof(val)\n      if (t in simpleTypesCount) {\n        simpleTypesCount[t]++\n        simpleTypesCount['all']++\n      }\n    })\n    //const areAllSimple = simpleTypesCount['all'] === obj.length\n    const areAllNumbers = simpleTypesCount['number'] === obj.length\n    let maxLength = 7\n    if (areAllNumbers) {\n      maxLength = 20\n    }\n    const simplified = obj.slice(0, maxLength).map((val) => this.#simplify(val))\n    if (simplified.length != obj.length) {\n      simplified.push('[!]...')\n    }\n    if (areAllNumbers) {\n      return `[!] ${this.#simplify(JSON.stringify(simplified))}`\n    } else {\n      return simplified\n    }\n  }\n\n  #hasSize(obj) {\n    const t = typeof(obj)\n    return (t === 'object' && (typeof(obj['size']) !== 'undefined' || typeof(obj['length']) !== 'undefined'))\n  }\n\n  #simplifyString(obj) {\n    let simplified = obj.slice(0, 150)\n    if (simplified.length !== obj.length) {\n      simplified += ' [!]...'\n    }\n    return simplified\n  }\n\n  logText({details=true}={}) {\n    let text = `[${this.debugId}]: ${this.debugMessage}`\n    text += `\\n${this.stack}`\n    if (this.cause) {\n      text += `\\n[cause] ${RichError.logTextFor(this.cause, {details})}`\n    }\n    if (details) {\n      text += `\\nDETAILS: ${JSON.stringify(this.debugDetails || {})}`\n    }\n    return text\n  }\n\n  static logTextFor(err, opts={}) {\n    if (err.logText) return err.logText(opts)\n    else return `${err.message}\\n${err.stack}`\n  }\n\n  data({isDebug=false, allInfo=false}) {\n    const dt = {\n      id: this.id || 'internal-error',\n      subtype: this.subtype,\n      message: this.publicMessage || 'Unexpected Internal Error',\n    }\n    if (isDebug || allInfo) {\n      dt.debug = {\n        \"__ALERT__\": \"THIS DEBUG OBJECT WILL NOT EXIST IN PRODUCTION\",\n        debugId: this.debugId,\n        message: this.debugMessage,\n      }\n    }\n\n    if (allInfo) {\n      Object.assign(dt.debug, {\n        details: this.debugDetails,\n        tags: this.tags,\n        errorLog: this.logText({details: false}),\n      })\n    }\n    return dt\n  }\n}\n","import {helpers} from '../routes/helpers'\nimport {asyncMiddleware} from './expressAsync'\nimport {RateLimit} from '../models/database/RateLimit'\nimport {RichError} from '../utils/RichError'\nimport onFinished from 'on-finished'\n\nexport function rateLimit({limit, expiresIn, lookup = (req, res) => req.ip, onBlocked=null, countIf=null}) {\n  return asyncMiddleware('rateLimit.rateLimit', async (req, res, next) => {\n    const limitObj = new RateLimit({limit, expiresIn})\n    const countAtBeginning = !countIf\n    const ids = lookup.apply(limitObj, [req, res])\n    const allowed = await limitObj.useSlotFrom(ids, countAtBeginning)\n    if (allowed) {\n      onFinished(res, function(err, res) {\n        if (!countAtBeginning && countIf.apply(limitObj, [req, res])) {\n          limitObj.manualCountFor(ids)\n        }\n      })\n    } else {\n      if (onBlocked) {\n        return onBlocked(req, res, next)\n      } else {\n        throw new RichError({\n          httpCode: 429,\n          id: 'too-many-requests',\n          subtype: 'rate-limit',\n          subtypeIsPublic: true,\n          publicMessage: 'Too Many Requests',\n          logLevel: 'debug',\n          tags: {'error:rate-limit': 'generic'},\n        })\n      }\n    }\n  })\n}\n","import {v4 as uuid} from 'uuid'\nimport {simpleCrypto} from '../../shared/simpleCrypto'\nimport {getNowInMillis} from '../../utils/time'\n\nconst MAX_TIMESTAMP = 9999999999999\n\nexport const idGenerator = new (class {\n    newOrderedId({uuidSize = 8} = {}) {\n        const reverseTimestamp = MAX_TIMESTAMP - getNowInMillis()\n        return simpleCrypto.urlSafeBase64(`${reverseTimestamp}${simpleCrypto.genericUUID(uuidSize)}`, {padding: false})\n    }\n\n    newSecret() {\n        return simpleCrypto.newSecret()\n    }\n})()\n","import fs from 'fs'\nimport {env} from '../../config/env'\nimport {logger} from '../../instrumentation/logger'\nimport {idGenerator} from '../../models/tools/idGenerator'\nimport {redisPubsub, buffersRedis, redisSubscribe} from \"../../config/redis\"\nimport {RichError} from \"../../utils/RichError\"\nimport {simpleCrypto} from \"../../shared/simpleCrypto\"\nimport {promisify} from \"util\"\n\nconst readfile = promisify(fs.readFile)\nconst redisGet = promisify(buffersRedis.get).bind(buffersRedis)\nconst redisSetex = promisify(buffersRedis.setex).bind(buffersRedis)\nconst redisDel = promisify(buffersRedis.del).bind(buffersRedis)\n\nconst redisGetSafe = (key) => !key ? undefined : redisGet(key)\nconst redisDelSafe = (key) => !key ? undefined : redisDel(key)\nconst PUBSUB_PREFIX = 'listener:pipeline-in-memory'\n\nexport class QuickSimulationClient {\n  static pubsubRequestKey() { return `${PUBSUB_PREFIX}:request` }\n  static pubsubResponseKey(id) { return `${PUBSUB_PREFIX}:${id}:response` }\n\n  async requestSimulation({id, photo, photoPath, expiresAt=0, options={}, safe=false}) {\n    if (!id) id = idGenerator.newOrderedId()\n    logger.verbose(`[${id}] Requesting Simulation (${JSON.stringify(options)})`)\n    const photoRedisKey = `pipeline:listener:${id}:photo`\n    if (!photo) photo = await readfile(photoPath)\n    const photoBuffer = Buffer.from(photo, 'binary')\n    await this.#publishRequest(id, photoBuffer, photoRedisKey, expiresAt, options)\n    const pubsubChannel = QuickSimulationClient.pubsubResponseKey(id)\n    const {result, before, morphed, error} = await this.#waitResponse({pubsubChannel, safe})\n    return {\n      id,\n      before,\n      result,\n      morphed,\n      error,\n      original: photo,\n      success: !error,\n    }\n  }\n\n  async #publishRequest(id, photoBuffer, photoRedisKey, expiresAt, options) {\n    const photoEncrypted = this.#encrypt(photoBuffer)\n    await redisSetex(photoRedisKey, 45, photoEncrypted)\n    var params = {\n      photo_redis_key: photoRedisKey,\n      expires_at: expiresAt,\n      ...options\n    }\n\n    const publishedMessage = JSON.stringify({\n      id: id,\n      params: params\n    })\n    redisPubsub.publish(QuickSimulationClient.pubsubRequestKey(), publishedMessage)\n    logger.verbose(`[${id}]: Params Published: ${publishedMessage}`)\n  }\n\n  async #waitResponse({pubsubChannel, safe}) {\n    const messageStr = await redisSubscribe(pubsubChannel)\n    logger.verbose(`Result Received ${pubsubChannel} - ${messageStr}`)\n    const message = JSON.parse(messageStr)\n\n    if (message['error']) {\n      return this.#throwError({message: message['error'], safe})\n    }\n\n    const resultRedisKey = message['data']['result_redis_key']\n    const beforeRedisKey = message['data']['before_redis_key']\n    const morphedRedisKey = message['data']['morphed_redis_key']\n    const [resultPhoto, beforePhoto, morphedMouth] = (await Promise.all([\n      redisGetSafe(resultRedisKey),\n      redisGetSafe(beforeRedisKey),\n      redisGetSafe(morphedRedisKey),\n    ]))\n    .map(content => this.#decrypt(content))\n\n    redisDelSafe(resultRedisKey)\n    redisDelSafe(beforeRedisKey)\n    redisDelSafe(morphedRedisKey)\n\n    const response = {\n      'result': resultPhoto,\n      'before': beforePhoto,\n      'morphed': morphedMouth,\n    }\n    if (!resultPhoto || !beforePhoto) {\n      const errorObj = this.#throwError({\n        message: \"Couldn't find simulation result recorded\",\n        safe,\n      })\n      Object.assign(response, errorObj)\n    }\n\n    return response\n  }\n\n  #decrypt(content) {\n    if (!content) return content\n    return simpleCrypto.decrypt(content, env.workerContentEncryptionSecret) || content\n  }\n\n  #encrypt(content) {\n    if (!content) return content\n    return simpleCrypto.encrypt(content, env.workerContentEncryptionSecret) || content\n  }\n\n  #throwError({message, safe}) {\n    if (!message) return\n    if (message.match(/timeout/i)) {\n      return this.#throwTimeoutError({message, safe})\n    }\n    let publicMessage = 'Error when executing simulation'\n    let errorTag = 'generic'\n    let subtype = undefined\n\n    if (message.match(/detect/i)) {\n      publicMessage = message\n      errorTag = 'no-face'\n      subtype = 'no-face'\n    } else if (message.match(/find.*result/)) {\n      errorTag = 'no-result-recorded'\n    }\n    const error = new RichError({\n      httpCode: 422,\n      id: 'simulation-error',\n      subtype,\n      subtypeIsPublic: true,\n      publicMessage,\n      debugMessage: message,\n      logLevel: 'error',\n      tags: {\n        'simulation:success': false,\n        'simulation:error': errorTag,\n      },\n    })\n\n    if (safe) return {error}\n    else throw error\n  }\n\n  #throwTimeoutError({message, safe}) {\n    const error = new RichError({\n      httpCode: 504,\n      id: 'timeout',\n      subtype: 'simulation-timeout',\n      publicMessage: 'Operation took too long',\n      debugMessage: message,\n      logLevel: 'error',\n      tags: {\n        'simulation:success': false,\n        'error:timeout': 'simulation-queue-wait',\n        'simulation:error': 'queue-wait',\n      },\n    })\n\n    if (safe) return {error}\n    else throw error\n  }\n}\n","import {env} from '../../config/env'\nimport {Storage} from '@google-cloud/storage'\n\nexport const storageFactory = ({projectKey}={}) => {\n  if (projectKey) {\n    const {credentialPath} = env.googleProjects[projectKey] || {}\n    if (credentialPath) {\n      return new Storage({\n        keyFilename: credentialPath,\n      })\n    }\n  }\n\n  return new Storage()\n}\n","import {env} from '../../config/env'\nimport {storageFactory} from './storageFactory'\nimport path from 'path'\n\nexport class GcloudPresignedCredentialsProvider {\n    constructor(bucket) {\n        this.bucket = bucket\n    }\n\n    static build({bucket=env.gcloudBucket}={}) {\n        return new GcloudPresignedCredentialsProvider(storageFactory().bucket(bucket))\n    }\n\n    async jsonToUpload({keyName, expiresInSeconds, contentType, contentMD5, maxSizeInMegabytes}) {\n        const extensionHeaders = {\n          'x-goog-content-length-range': `0,${maxSizeInMegabytes*1024*1024}`\n        }\n        const options = {\n            version: 'v4',\n            action: 'write',\n            contentType: contentType,\n            expires: Date.now() + expiresInSeconds * 1000,\n            contentMd5: contentMD5,\n            extensionHeaders: extensionHeaders,\n        }\n\n        const [url] = await this.bucket.file(keyName).getSignedUrl(options)\n\n        const uploadHeaders = Object.assign({\n          \"Content-MD5\": contentMD5,\n          \"Content-Type\": contentType,\n        }, extensionHeaders)\n        return this.#buildRequestDescriptor('put', url, uploadHeaders)\n    }\n\n    async urlToGet(keyName, {expiresInSeconds}) {\n        const options = {\n          version: 'v4',\n          action: 'read',\n          expires: Date.now() + expiresInSeconds * 1000,\n          virtualHostedStyle: true,\n        }\n        const [url] = await this.bucket.file(keyName).getSignedUrl(options)\n\n        return this.#buildRequestDescriptor('get', url)\n    }\n\n    #buildRequestDescriptor(verb, url, headers={}) {\n      return {\n        verb: verb,\n        url: url,\n        headers: headers,\n      }\n    }\n}\n","export class TimeoutManager {\n  constructor({externalTimedout=() => false, onTimeout=() => null}) {\n    this.timedout = false\n    this.externalTimedout = externalTimedout\n    this.blownTimeout = false\n    this.onTimeout = onTimeout\n  }\n\n  async exec(behavior, timeoutSecs) {\n    let result = undefined\n    let err = undefined\n    let timeoutId = null\n    await Promise.race([\n      new Promise((resolve, reject) => {\n        timeoutId = setTimeout(() => {\n          this.timedout = true\n          resolve()\n        }, timeoutSecs*1000)\n      }),\n      new Promise((resolve, reject) => {\n        try {\n          behavior()\n          .then(r => {\n            result = r\n            resolve()\n          })\n          .catch(e => {\n            err = e\n            resolve()\n          })\n        } catch (e) {\n          err = e\n          resolve()\n        }\n      }),\n    ])\n    if (timeoutId !== null) clearTimeout(timeoutId)\n\n    if (this.blownTimeout) return result\n    if (this.hasTimedout()) {\n      this.blownTimeout = true\n      this.onTimeout()\n      throw new Error('Timeout: Behavior took too long')\n    }\n    if (err) throw err\n    else return result\n  }\n\n  hasTimedout() {\n    return this.blownTimeout || this.timedout || this.externalTimedout()\n  }\n}\n","import {simpleCrypto} from \"./simpleCrypto\";\nimport {envShared} from \"./envShared\";\n\nconst TIME_SLICE = 30\n\nexport const otp = new (class {\n  create(epochTime, secret) {\n    const timeCounter = this.#counterFor(epochTime)\n    return this.#tokenFor(timeCounter, secret)\n  }\n\n  verify(token, epochTime, secret) {\n    const timeCounter = this.#counterFor(epochTime)\n    const currentToken = this.#tokenFor(timeCounter, secret)\n    const previousToken = this.#tokenFor(timeCounter-1, secret)\n    return token === currentToken || token === previousToken\n  }\n\n  #tokenFor(timeCounter, secret) {\n    return simpleCrypto.hmac(simpleCrypto.sha1(`&&%%95${timeCounter}23**@`), secret)\n  }\n\n  #counterFor(epochTimeSecs) {\n    return Math.round(epochTimeSecs) % TIME_SLICE\n  }\n})()\n","import stream from 'stream'\nimport path from 'path'\nimport fs from 'fs'\n\nimport axios from 'axios'\nimport formidable from 'formidable'\nimport {promisify} from \"util\"\nimport timeout from 'connect-timeout'\nimport express from 'express'\nconst router = express.Router()\n\nimport {i18n} from '../shared/i18n'\nimport {helpers} from './helpers'\nimport {asyncRoute} from '../middlewares/expressAsync'\nimport {rateLimit} from \"../middlewares/rateLimit\"\nimport {QuickSimulationClient} from \"../models/clients/QuickSimulationClient\"\nimport {GcloudPresignedCredentialsProvider} from '../models/storage/GcloudPresignedCredentialsProvider'\nimport {idGenerator} from \"../models/tools/idGenerator\"\nimport {storageFactory} from '../models/storage/storageFactory'\nimport {TimeoutManager} from '../models/tools/TimeoutManager'\nimport {logger} from '../instrumentation/logger'\nimport {env} from \"../config/env\"\nimport {envShared} from \"../shared/envShared\"\nimport {otp} from \"../shared/otp\"\nimport {getNowInMillis} from '../utils/time'\n\nconst readfile = promisify(fs.readFile)\nconst ROBOTS_PRODUCTION = `# https://www.robotstxt.org/robotstxt.html\nUser-agent: *\nDisallow: /terms\n\nUser-agent: *\nDisallow: /privacy`\n\nconst ROBOTS_DEV = `# https://www.robotstxt.org/robotstxt.html\nUser-agent: *\nDisallow: /`\n\nconst minutelyIpRateLimit = rateLimit({\n  limit: env.instSimIpRateLimitMinutely.amount,\n  expiresIn: env.instSimIpRateLimitMinutely.timeWindow,\n  lookup: (req, _) => `instant-simulation:minutely:${req.ip}`,\n  onBlocked: function(req, res, next) {\n    throw new Error('Exceeded minutely IP rate limit')\n  }\n})\n\nconst hourlySuccessIpRateLimit = rateLimit({\n  limit: env.instSimIpRateLimitHourly.amount,\n  expiresIn: env.instSimIpRateLimitHourly.timeWindow,\n  lookup: (req, _) => `instant-simulation:hourly:${req.ip}`,\n  countIf: (_, res) => {\n    return (res.statusCode >= 200 && res.statusCode <= 299) && !res.locals.dentInstSimIsErrorPage;\n  },\n  onBlocked: function(req, res, next) {\n    throw new Error('Exceeded hourly IP rate limit')\n  }\n})\n\nconst dailyIpRateLimit = rateLimit({\n  limit: env.instSimIpRateLimitDaily.amount,\n  expiresIn: env.instSimIpRateLimitDaily.timeWindow,\n  lookup: (req, _) => `instant-simulation:daily:${req.ip}`,\n  onBlocked: function(req, res, next) {\n    throw new Error('Exceeded daily IP rate limit')\n  }\n})\n\nrouter.get('/', asyncRoute(async (req, res) => {\n  setupCacheGet(res)\n  const synthTransform = !!req.query.transform || !!req.query.t\n  res.render('instant_simulations/index', buildParams({synthTransform: synthTransform}))\n}))\n\nrouter.get('/terms', asyncRoute(async (req, res) => {\n  setupCacheGet(res)\n  res.render('instant_simulations/terms', buildLayoutParams({subtitle: 'Terms of Service'}))\n}))\n\nrouter.get('/privacy', asyncRoute(async (req, res) => {\n  setupCacheGet(res)\n  res.render('instant_simulations/privacy', buildLayoutParams({subtitle: 'Privacy Policy'}))\n}))\n\nrouter.get('/epoch', asyncRoute(async (req, res) => {\n  res.json({epoch: getOtpEpoch()})\n}))\n\nrouter.get('/robots.txt', asyncRoute(async (req, res) => {\n  const content = env.isProduction() ? ROBOTS_PRODUCTION : ROBOTS_DEV\n  setupCacheGet(res)\n  res.setHeader('Content-Type', 'text/plain');\n  res.status(200).send(content)\n}))\n\nrouter.post('/',\ntimeout(`${env.instSimRouteTimeout + env.instSimUploadTimeout}s`),\nhourlySuccessIpRateLimit,\nminutelyIpRateLimit,\ndailyIpRateLimit,\nasyncRoute(async (req, res, next) => {\n  const form = formidable({\n    multiples: true,\n    maxFileSize: envShared.maxUploadSizeBytes,\n    maxFieldsSize: 1*1024*1024,\n    allowEmptyFiles: false\n  })\n  const timeoutManager = new TimeoutManager({externalTimedout: () => req.timedout, onTimeout: () => form.pause()})\n  const {files, fields} = await timeoutManager.exec(async () => {\n    const result = await helpers.parseForm(form, req)\n    return result\n  }, env.instSimUploadTimeout)\n  if (timeoutManager.hasTimedout()) return\n\n  const photo = files.photo\n\n  await timeoutManager.exec(async () => {\n    const nowMillis = getNowInMillis()\n    if (!photo || photo.size === 0) {\n      throw new Error(\"No photo was received\")\n    }\n\n    if (!tokenIsValid(fields.secret)) {\n      throw new Error('Non authorized token')\n    }\n\n    const recaptchaIsValid = await validateRecaptcha(fields.recaptchaToken)\n    if (!recaptchaIsValid) {\n      throw new Error('Invalid Recaptcha')\n    }\n\n    const photoExt = path.extname(photo.originalFilename).toLowerCase()\n    const photoPath = photo.filepath\n    const info = {ip: req.ip, timestamp: timenowStr()}\n    Object.assign(res.locals, {photoPath, photoExt, info})\n    if (!photoExt.match(env.supportedImagesFilepathRegex)) {\n      throw new Error(`Invalid extension ${photoExt}`)\n    }\n    const client = new QuickSimulationClient()\n    const expiresAt = Math.round(nowMillis + env.instSimGiveUpStartTimeout * 1000.0)\n    const simOpts = {\n      brightness: env.instSimBrightness,\n      whiten: env.instSimWhiten,\n      poisson: env.instSimPoisson,\n      ortho: false,\n    }\n    if (fields.synthTransform !== 'true') {\n      simOpts['mix_factor'] = env.instSimMixFactor\n    }\n    const simulation = await client.requestSimulation({\n      photoPath,\n      expiresAt: expiresAt,\n      options: simOpts\n    })\n    if (timeoutManager.hasTimedout()) return\n    const { getBeforeUrl, getResultUrl } = await uploadToFirestoreData({\n      originalExt: photoExt,\n      original: simulation.original,\n      before: simulation.before,\n      result: simulation.result,\n      morphed: simulation.morphed,\n      info: res.locals.info\n    })\n    if (timeoutManager.hasTimedout()) return\n    //const beforeDataUrl = helpers.toDataUrl(simulation.before, 'image/jpeg')\n    //const resultDataUrl = helpers.toDataUrl(simulation.result, 'image/jpeg')\n    const simulationParams = {\n      success: true,\n      beforeUrl: getBeforeUrl,\n      resultUrl: getResultUrl,\n      //beforeDataUrl: beforeDataUrl,\n      //resultDataUrl: resultDataUrl,\n      originalExt: photoExt\n    }\n    return res.render('instant_simulations/index', buildParams({subtitle: 'Result', simulation: simulationParams}))\n  }, env.instSimRouteTimeout)\n}))\n\nasync function errorHandler(error, req, res, next) {\n  logger.error(error)\n  const errorInfo = getErrorInfo(error)\n  if (errorInfo.isSimulationError) {\n    const info = res.locals.info\n    info.errorFullMessage = errorInfo.fullMessage\n    info.errorPrettyMessage = errorInfo.prettyMessage\n    const original = await readfile(res.locals.photoPath)\n    const originalExt = res.locals.photoExt\n    await uploadToFirestoreData({original, originalExt, info})\n  }\n  const simulationParams = {success: false, error_message: errorInfo.prettyMessage, error_code: errorInfo.errorCode, is_simulation_error: errorInfo.isSimulationError}\n  res.locals.dentInstSimIsErrorPage = true\n  return res.render('instant_simulations/index', buildParams({subtitle: 'Try Again', simulation: simulationParams}))\n}\n\nasync function uploadToFirestoreData({originalExt, original, before=null, result=null, morphed=null, info}) {\n  const success = result !== null\n  const id = idGenerator.newOrderedId()\n  const folder = `.instant-simulations/${(success ? 'success' : 'fail')}/${id}/`\n  const originalKey = path.join(folder, 'original' + originalExt)\n  const resultKey = path.join(folder, 'result.jpg')\n  const beforeKey = path.join(folder, 'before.jpg')\n  const morphedKey = path.join(folder, 'morphed.jpg')\n  const uploads = []\n  if (success) {\n    uploads.push(upload(result, resultKey))\n    uploads.push(upload(before, beforeKey))\n    if (morphed) {\n      uploads.push(upload(morphed, morphedKey))\n    }\n  }\n  uploads.push(upload(original, originalKey))\n  uploads.push(upload(prettyJSON(info), path.join(folder, 'info.json')))\n  await Promise.all(uploads)\n  if (success) {\n    const signedUrls = []\n    const gcloudSigner = GcloudPresignedCredentialsProvider.build()\n    signedUrls.push(gcloudSigner.urlToGet(beforeKey, {expiresInSeconds: 15 * 60}))\n    signedUrls.push(gcloudSigner.urlToGet(resultKey, {expiresInSeconds: 15 * 60}))\n    let [{url: getBeforeUrl}, {url: getResultUrl}] = await Promise.all(signedUrls)\n    return {getBeforeUrl, getResultUrl}\n  } else {\n    return {}\n  }\n}\n\nasync function upload(data, filekey) {\n  const bucket = env.gcloudBucket\n  await new Promise((resolve, reject) => {\n    const file = storageFactory()\n    .bucket(bucket)\n    .file(filekey)\n    const passthroughStream = new stream.PassThrough()\n    passthroughStream.write(data)\n    passthroughStream.end()\n    passthroughStream\n    .pipe(file.createWriteStream())\n    .on('finish', function() {\n      logger.info(`[SUCCESS] Upload: (${bucket}) ${filekey}`)\n      resolve()\n    })\n    .on('error', function(err) {\n      logger.error(`[FAILED] Upload: (${bucket}) ${filekey}`)\n      reject(err)\n    })\n  })\n}\n\nfunction buildLayoutParams({subtitle=null}) {\n  return {\n    title: 'Free Smiles Simulation' + (subtitle ? ` - ${subtitle}` : ''),\n    measurementId: envShared.instSimFirebaseMeasurementId,\n  }\n}\n\nfunction buildParams({subtitle=null, simulation=null, synthTransform=false}={}) {\n  let params = buildLayoutParams({subtitle})\n  params = Object.assign(params, {\n    i18n: i18n,\n    maxFileSize: envShared.maxUploadSizeBytes,\n    recaptchaClientKey: envShared.instSimRecaptchaClientKey,\n    synthTransform: synthTransform,\n  })\n  if (simulation !== null) {\n    params = Object.assign(params, {simulation: simulation})\n  }\n  return params\n}\n\nfunction getErrorInfo(error) {\n  const fullErrorMessage = error.message || error.error || prettyJSON(error)\n  const info = {fullMessage: fullErrorMessage, isSimulationError: false}\n  const rateLimitPattern = /exceeded.*rate limit/i\n  let prettyMessage = null\n  let errorCode = null\n  if (fullErrorMessage.match(rateLimitPattern) && fullErrorMessage.match(/minute/i)) {\n    errorCode = 'errors:simulations-minutely-limit'\n    prettyMessage = i18n(errorCode)\n  } else if (fullErrorMessage.match(rateLimitPattern) && fullErrorMessage.match(/hour/i)) {\n    errorCode = 'errors:simulations-hourly-limit'\n    prettyMessage = i18n(errorCode)\n  } else if (fullErrorMessage.match(rateLimitPattern) && fullErrorMessage.match(/da(il)?y/i)) {\n    errorCode = 'errors:simulations-daily-limit'\n    prettyMessage = i18n(errorCode)\n  } else if (fullErrorMessage.match(/invalid.*recaptcha/i)) {\n    errorCode = 'errors:invalid-recaptcha'\n    prettyMessage = i18n(errorCode)\n  } else if (fullErrorMessage.match(/maxFileSize exceeded/i)) {\n    errorCode = 'errors:upload:image-size-limit'\n    prettyMessage = i18n(errorCode, {maxSize: envShared.maxUploadSizeMb})\n  } else if (fullErrorMessage.match(/no photo.*received/i)) {\n    errorCode = 'errors:upload:no-file'\n    prettyMessage = i18n(errorCode)\n  } else if (fullErrorMessage.match(/invalid.*extension/i)) {\n    errorCode = 'errors:upload:wrong-image-format'\n    prettyMessage = i18n(errorCode)\n  } else if (fullErrorMessage.match(/((response|error).*timeout|timeout:)/i)) {\n    errorCode = 'errors:timeout'\n    prettyMessage = i18n(errorCode)\n  } else if (fullErrorMessage.match(/Couldn.*t detect face/i)) {\n    errorCode = 'errors:no-face'\n    prettyMessage = i18n(errorCode)\n    info.isSimulationError = true\n  } else if (fullErrorMessage.match(/error.*simulation/i)) {\n    errorCode = 'errors:simulation-error'\n    prettyMessage = i18n(errorCode)\n    info.isSimulationError = true\n  } else {\n    errorCode = 'errors:unknown-processing-error'\n    prettyMessage = i18n(errorCode)\n  }\n  info.prettyMessage = prettyMessage\n  info.errorCode = errorCode\n  return info\n}\n\nfunction tokenIsValid(otpToken) {\n  if (env.instSimTokenDisabled) return true\n  return otp.verify(otpToken, getOtpEpoch(), envShared.instSimSecretToken)\n}\n\nasync function validateRecaptcha(token) {\n  const {data} = await axios.post(`https://www.google.com/recaptcha/api/siteverify?secret=${env.instSimRecaptchaSecretKey}&response=${token}`)\n  return data.success && data.score >= 0.75\n}\n\nfunction timenowStr() {\n  return new Date().toLocaleString('en-US', {hour12: false});\n}\n\nfunction prettyJSON(info) {\n  const identation = 4\n  return JSON.stringify(info, null, identation)\n}\n\nfunction getOtpEpoch() {\n  return Math.round(new Date().getTime() / 1000)\n}\n\nfunction setupCacheGet(res) {\n  if (!env.isProduction()) return;\n  res.set('Cache-Control', \"public, max-age=3600, must-revalidate\")\n}\n\nexport default {\n  router: router,\n  errorHandler: errorHandler\n}\n","import path from 'path'\nimport admin from 'firebase-admin'\nimport {env} from '../../config/env'\n\nconst SOURCE_NAME_KEY = '__source'\nexport class Database {\n    constructor({connection, name}) {\n        this.connection = connection\n        this.name = name\n    }\n\n    static build({app, name = 'default'}) {\n        if (env.isTest() && (!app.options.databaseURL || !app.options.databaseURL.includes('localhost'))) {\n            throw `Invalid firestore options. Test environment can connect on localhost only. Options: ${JSON.stringify(app.options)}`\n        }\n        return new Database({\n            connection: app.firestore(),\n            name,\n        })\n    }\n\n    static setInstance({database}) {\n        if (!this.instances) this.instances = {}\n        this.instances[database.name] = database\n    }\n\n    static instance({name}={}) {\n      if (!this.instances) return null\n      name = name || 'default'\n      let instance = this.instances[name]\n      if (!instance) throw new Error(`Couldn't find database named ${name}`)\n      return instance\n    }\n\n    static toTimestamp(date) {\n        return admin.firestore.Timestamp.fromDate(date)\n    }\n\n    static sourceOf(obj) {\n      return obj[SOURCE_NAME_KEY] || 'default'\n    }\n\n    save(obj, objPath, overwrite=false, attrs=undefined) {\n        obj[SOURCE_NAME_KEY] = this.name\n        return this.#getRef(objPath).set(adaptObj(obj, {attrs}), {merge: !overwrite})\n    }\n\n    startQuery(collectionName) {\n        return this.connection.collection(collectionName)\n    }\n\n    async getResults(constructor, query) {\n        const rawResults = await query.get()\n        let results = []\n        rawResults.forEach(raw => {\n            const obj = this.#firebaseObjToModelObj(constructor, raw)\n            results.push(obj)\n        })\n        return results\n    }\n\n    async get(constructor, objsPath) {\n        const fullPath = path.join(constructor.COLLECTION_NAME, String(objsPath))\n        const ref = this.#getRef(normalizePath(fullPath))\n        const got = await ref.get()\n        if (!got.exists) return null\n        return this.#firebaseObjToModelObj(constructor, got)\n    }\n\n    #firebaseObjToModelObj(constructor, firebaseObj) {\n        const attrs = {\n            id: firebaseObj.id,\n            ...firebaseObj.data(),\n        }\n        const obj = new constructor(attrs)\n        obj[SOURCE_NAME_KEY] = this.name\n        return obj\n    }\n\n    set(objPath, value) {\n        return this.#getRef(objPath).set(value)\n    }\n\n    async delete(objPath, allow_root = false) {\n        if (!allow_root && (objPath === '/' || objPath === '' || !objPath)) throw new Error(\"Can't delete root\")\n        return this.#getRef(objPath).delete()\n    }\n\n    #getRef(objPath) {\n        return this.connection.doc(objPath)\n    }\n}\n\nfunction adaptObj(value, {attrs}={}) {\n    if (typeof(value) !== 'object') return value\n    const obj = {}\n    if (!attrs) {\n      Object.assign(obj, value)\n    } else {\n      attrs.forEach(attr => {\n        obj[attr] = value[attr]\n      })\n    }\n    Object.keys(obj).forEach(key => {\n        if (obj[key] instanceof admin.firestore.Timestamp) {\n            obj[key] = obj[key].toDate()\n        }\n    })\n    delete obj.id\n    delete obj[SOURCE_NAME_KEY]\n    return obj\n}\n\nfunction normalizePath(objPath) {\n    let parts = []\n    objPath.split('/').forEach(part => {\n        const trimmed = part.trim()\n        if (trimmed !== '') parts.push(part)\n    })\n    return parts.join('/')\n}\n","export const sanitizer = new (class {\n    onlyKeys(obj, allowedKeys) {\n        var sanitized = {}\n        Object.keys(obj).forEach(key => {\n          if (allowedKeys.includes(key)) {\n            sanitized[key] = obj[key]\n          }\n        })\n        return sanitized\n    }\n})()\n","import {Database} from '../database/Database'\nimport {idGenerator} from '../tools/idGenerator'\nimport {sanitizer} from '../tools/sanitizer'\nimport {Enum} from '../tools/Enum'\nimport * as path from 'path'\n\nconst UPLOADED_IMAGE_FILENAME = 'smile.jpg'\nconst RESULT_IMAGE_FILENAME = 'smile_after.jpg'\nconst PREPROCESSED_IMAGE_FILENAME = 'smile_before.jpg'\nconst SIDEBYSIDE_IMAGE_FILENAME = 'smile_sidebyside.jpg'\nconst SIDEBYSIDE_SMALL_IMAGE_FILENAME = 'smile_sidebyside_small.jpg'\nconst UPLOADED_TO_REVIEW_NAME = 'smile_review_pending'\n\nconst RequesterType = new Enum([\n    'patient',\n    'inhouseClient',\n])\n\nconst REQUESTER_METADATA = {\n  [RequesterType.patient()]: {\n    fields: ['ip', 'accessPointId', 'origin', 'email', 'name', 'phone'],\n    pathPattern: 'ml-images/{clientId}/{id}/{filename}',\n  },\n  [RequesterType.inhouseClient()]: {\n    fields: ['ip'],\n    pathPattern: '{userId}/on_demand/{id}/{filename}',\n  },\n}\n\nconst METADATA_WHITELIST = [\n  'mode', 'blend',\n  'mix_factor', 'style_mode', 'whiten', 'brightness',\n  'feedback_score', 'capture_type', 'external_customer_id',\n]\n\nexport class SmileTask {\n  static get COLLECTION_NAME() { return 'smile_tasks' }\n  static get RequesterType() { return RequesterType }\n  static get UPLOADED_TO_REVIEW_NAME() { return UPLOADED_TO_REVIEW_NAME }\n\n  constructor(attrs = {}) {\n    this.id = attrs.id\n    this.createdAt = attrs.createdAt\n\n    this.imageMD5 = attrs.imageMD5\n    this.userId = attrs.userId\n    this.clientId = attrs.clientId\n    this.contentType = attrs.contentType\n    this.status = attrs.status || 'pending'\n    this.filepathUploaded = attrs.filepathUploaded\n    this.filepathResult = attrs.filepathResult\n    this.filepathPreprocessed = attrs.filepathPreprocessed\n    this.filepathSideBySide = attrs.filepathSideBySide\n    this.filepathSideBySideSmall = attrs.filepathSideBySideSmall\n    this.metadata = {}\n\n    this.requester = attrs.requester\n  }\n\n  static build(requesterType, attrs) {\n    const finalAttrs = SmileTask.#prepareBuildAttrs(requesterType, attrs)\n    return new SmileTask(finalAttrs)\n  }\n\n  hasFinished() {\n    return this.status === 'finished'\n  }\n\n  async save({attrs}={}) {\n    return Database.instance().save(this, `${SmileTask.COLLECTION_NAME}/${this.id}`, false, attrs)\n  }\n\n  addMetadata(metadata) {\n    metadata = sanitizer.onlyKeys(metadata, METADATA_WHITELIST)\n    Object.assign(this.metadata, metadata)\n  }\n\n  uploadsDir() {\n    return path.join(path.dirname(this.filepathUploaded), '/')\n  }\n\n  resultsDirectory() {\n    return path.join(path.dirname(this.filepathResult), '/')\n  }\n\n  filepathUploadedToReview() {\n    const imageExtension = path.extname(this.filepathUploaded)\n    const filename = UPLOADED_TO_REVIEW_NAME + imageExtension\n    return path.join(this.uploadsDir(), filename)\n  }\n\n  static async get(id) {\n    const db = Database.instance()\n    return await db.get(SmileTask, id)\n  }\n\n  static async all() {\n    const db = Database.instance()\n    const query = db.startQuery(SmileTask.COLLECTION_NAME)\n    return await db.getResults(SmileTask, query)\n  }\n\n  static newId(createdAt) {\n    return idGenerator.newOrderedId()\n  }\n\n  static #prepareBuildAttrs(requesterType, attrs) {\n    const metadata = REQUESTER_METADATA[requesterType]\n    const id = attrs.id || SmileTask.newId()\n    attrs = Object.assign({\n      id: id,\n      createdAt: attrs.createdAt || Database.toTimestamp(new Date()),\n      requester: {\n        type: requesterType,\n        info: sanitizer.onlyKeys(attrs, metadata.fields),\n      },\n    }, attrs)\n    return Object.assign({\n      filepathUploaded:        SmileTask.#buildPath(metadata.pathPattern, attrs, UPLOADED_IMAGE_FILENAME),\n      filepathResult:          SmileTask.#buildPath(metadata.pathPattern, attrs, RESULT_IMAGE_FILENAME),\n      filepathPreprocessed:    SmileTask.#buildPath(metadata.pathPattern, attrs, PREPROCESSED_IMAGE_FILENAME),\n      filepathSideBySide:      SmileTask.#buildPath(metadata.pathPattern, attrs, SIDEBYSIDE_IMAGE_FILENAME),\n      filepathSideBySideSmall: SmileTask.#buildPath(metadata.pathPattern, attrs, SIDEBYSIDE_SMALL_IMAGE_FILENAME),\n    }, attrs)\n  }\n\n  static #buildPath(pattern, attrs, filename) {\n    let path = pattern.replace('{filename}', filename)\n    Object.keys(attrs).forEach(k => {\n      path = path.replace('{'+k+'}', attrs[k])\n    })\n    return path\n  }\n}\n","export class Enum {\n    constructor(properties) {\n        this._properties = properties\n        properties.forEach(property => {\n          this[property] = () => property\n        })\n    }\n}\n","import {simpleCrypto} from \"./simpleCrypto\";\nimport {envShared} from \"./envShared\";\n\nexport const signer = new (class {\n    sign (obj, key) {\n        const text = this.serialize(obj)\n        const pass = this.serialize(key)\n        return simpleCrypto.hmac(text, pass)\n    }\n\n    verify (obj, key, signature) {\n        return this.sign(obj, key) === signature\n    }\n\n    apiSign(userId, imageMD5, clientSecret) {\n        return this.sign([userId, imageMD5], [clientSecret, envShared.apiSecretToken])\n    }\n\n    apiVerify(userId, imageMD5, clientSecret, signature) {\n        return this.verify([userId, imageMD5], [clientSecret, envShared.apiSecretToken], signature)\n    }\n\n    serialize (obj) {\n        if (typeof(obj) === 'string') return obj\n        else if (typeof(obj) === 'number') return obj.toString()\n        else if (Array.isArray(obj)) {\n          return obj.map(v => this.serialize(v)).join(':')\n        } else {\n            let pairs = []\n            for(let k in obj) {\n                pairs.push([k.toString(), obj[k]])\n            }\n            pairs.sort((a,b) => a[0] > b[0] ? 1 : (a[0] == b[0] ? 0 : -1))\n            let serialized = ''\n            pairs.forEach(([k, v]) => serialized += `\"${k}\":${this.serialize(v)},`)\n            return `{${serialized}}`\n        }\n    }\n})()\n","import {helpers} from '../routes/helpers'\nimport {signer} from '../shared/signer'\n\nexport const smileTaskSecurity = new (class {\n  getSignature(req, res, next) {\n    const signature = helpers.getSignature(req)\n    if (!signature) {\n      return helpers.respondError(res, 403, \"Not Authorized\")\n    }\n\n    const parts = signature.split(':')\n    if (parts.length !== 2 || !parts[0] || !parts[1]) {\n      return helpers.respondError(res, 403, \"Not Authorized\")\n    }\n    res.locals.dentClientId = parts[0]\n    res.locals.dentSignature = parts[1]\n    return next()\n  }\n\n  getImageMD5(req, res, next) {\n    const imageMD5 = req.body.imageMD5\n    if (!imageMD5) {\n      return helpers.respondError(res, 422, 'imageMD5 is mandatory')\n    }\n    res.locals.dentImageMD5 = imageMD5\n    return next()\n  }\n\n  getContentType(req, res, next) {\n    const contentType = req.body.contentType\n    if (!contentType) {\n      return helpers.respondError(res, 422, 'contentType is mandatory')\n    }\n    res.locals.dentImageContentType = contentType\n    return next()\n  }\n\n  verifySignature(req, res, next) {\n    const receivedSignature = res.locals.dentSignature\n    const userId = res.locals.dentUser.id\n    const imageMD5 = res.locals.dentImageMD5\n    const clientSecret = res.locals.dentClient.secret\n    if (!signer.apiVerify(userId, imageMD5, clientSecret, receivedSignature)) {\n      return helpers.respondError(res, 403, \"Not Authorized\")\n    }\n    return next();\n  }\n})()\n","import {logger} from '../instrumentation/logger'\nimport NodeCache from 'node-cache'\n\nimport {timeInSeconds} from '../utils/time'\nconst {SECONDS, MINUTES, HOURS, DAYS} = timeInSeconds\n\nconst allInstances = []\nexport class InMemory {\n  constructor({cache, cacheTTL, staleTTL}) {\n    this.cache = cache\n    this.cacheTTL = cacheTTL\n    this.staleTTL = staleTTL\n    allInstances.push(this)\n  }\n\n  static clear() {\n    for (let instance of allInstances) {\n      if (typeof(instance.clear) === 'function') {\n        instance.clear()\n      }\n    }\n  }\n\n  static build(params) {\n    const {cacheTTL} = params\n    const nodeCache = new NodeCache({\n      stdTTL: cacheTTL,\n      useClones: false,\n      checkperiod: 10.0 * MINUTES,\n      deleteOnExpire: true,\n      maxKeys: 5000\n    })\n    return new InMemory({\n      ...params,\n      cache: nodeCache,\n    })\n  }\n\n  delete(key, {keepCache=false, keepStale=false}={}) {\n    const cacheKey = this.#cacheKey(key)\n    const staleKey = this.#staleKey(key)\n    if (!keepCache) this.cache.del(cacheKey)\n    if (!keepStale) this.cache.del(staleKey)\n  }\n\n  clear() {\n    this.cache.flushAll()\n  }\n\n  async wrap({key, op, skipCache=false}) {\n    if (skipCache) {\n      logger.verbose(`Cache SKIP: ${key}`)\n    } else {\n      const cKey = this.#cacheKey(key)\n      const cached = this.cache.get(cKey)\n      if (typeof(cached) !== 'undefined') {\n        logger.verbose(`cache.InMemory: Return Cached ${key}`)\n        return cached\n      }\n    }\n\n    return this.#execAndStore({op, key})\n  }\n\n  async #store(key, result) {\n    if (this.#validToStore(result)) {\n      logger.warn(`cache.InMemory (silent fail): Invalid result for key ${key}: ${result}`)\n    }\n    const setCommands = []\n    const cKey = this.#cacheKey(key)\n    setCommands.push({key: cKey, val: result, ttl: this.cacheTTL})\n\n    if (this.#isStaleOn()) {\n      const sKey = this.#staleKey(key)\n      setCommands.push({key: sKey, val: result, ttl: this.staleTTL})\n    }\n    const success = this.cache.mset(setCommands)\n    if (success) {\n      logger.verbose(`cache.InMemory: Stored ${key}`)\n    } else {\n      logger.warn(`cache.InMemory (silent fail): Couldn't store ${key} with: ${result}`)\n    }\n    return Promise.resolve(result)\n  }\n\n  async #handleError(key, error) {\n    const sKey = this.#staleKey(key)\n    const staled = this.#isStaleOn() ? this.cache.get(sKey) : undefined\n    if (typeof(staled) === 'undefined') {\n      return Promise.reject(error)\n    } else {\n      logger.warn(`cache.InMemory: Failed to execute behaviour of ${key}, returning stale instead: ${staled}`)\n      return Promise.resolve(staled)\n    }\n  }\n\n  async #exec(obj) {\n    if (typeof(obj) === 'function') {\n      const f = async () => obj()\n      obj = f()\n    }\n    if (obj instanceof Error) {\n      return Promise.reject({error: obj})\n    } else if (!!obj.error) {\n      return Promise.reject(obj)\n    } else {\n      return Promise.resolve(obj)\n    }\n  }\n\n  async #execAndStore({op, key}) {\n    return this.#exec(op)\n      .then((result) => {\n        this.#store(key, result)\n        return Promise.resolve(result)\n      })\n      .catch((error) => {\n        return this.#handleError(key, error)\n      })\n  }\n\n  #validToStore(result) {\n    const isInvalid = (\n      typeof(obj) === 'undefined'\n      || obj === null\n      || obj instanceof Error\n      || 'error' in obj\n      || (typeof(obj) === 'object' && Object.keys(obj).length === 0)\n    )\n    return !isInvalid\n  }\n  #isStaleOn() { return typeof(this.staleTTL) === 'number' && this.staleTTL > 0 }\n  #cacheKey(key) { return `cache:${key}` }\n  #staleKey(key) { return `stale:${key}` }\n}\n","import {idGenerator} from '../tools/idGenerator'\nimport {Database} from './Database'\nimport {InMemory as Cache} from '../../cache/InMemory'\n\nimport {timeInSeconds} from '../../utils/time'\nconst {SECONDS, MINUTES, HOURS, DAYS} = timeInSeconds\n\nconst API_CONFIG_ENABLED = 'enabled'\nconst API_CONFIG_ALLOWED_HOSTS = 'allowedHosts'\nconst API_CONFIG_RATE_LIMIT = 'rateLimit'\nconst API_CONFIG_RECAPTCHA = 'recaptcha'\nconst API_CONFIG_CUSTOM_BUCKET = 'customBucket'\nconst API_CONFIG_CUSTOM_GOOGLE_PROJECT = 'customGoogleProject'\nconst NEW_API_CONFIG_DEFAULT = () => {\n  return {\n    [API_CONFIG_ENABLED]: true,\n    [API_CONFIG_ALLOWED_HOSTS]: null,\n    [API_CONFIG_RATE_LIMIT]: null,\n    [API_CONFIG_RECAPTCHA]: {},\n    [API_CONFIG_CUSTOM_BUCKET]: null,\n    [API_CONFIG_CUSTOM_GOOGLE_PROJECT]: null,\n  }\n}\n\nconst cache = Cache.build({\n  cacheTTL: 5.0 * MINUTES,\n  staleTTL: 3.0 * DAYS,\n})\n\nexport class ApiClient {\n    static get COLLECTION_NAME() {return 'api_clients'}\n    static get CACHE() {return cache}\n\n    constructor({id, secret, exposedSecret, createdAt = null, updatedAt = null, revoked=false, apisConfig = null}) {\n        this.id = id\n        this.secret = secret\n        this.exposedSecret = exposedSecret\n        this.createdAt = createdAt || Database.toTimestamp(new Date())\n        this.updatedAt = updatedAt || this.createdAt\n        this.revoked = revoked\n        this.apisConfig = apisConfig || {\n          default: NEW_API_CONFIG_DEFAULT(),\n        }\n    }\n\n    addApiAllowedHost({api='default', host}) {\n      const hosts = this.#rawGetApiConfig({api, config: API_CONFIG_ALLOWED_HOSTS}) || []\n      hosts.push(host)\n      this.#setApiConfig({api, config: API_CONFIG_ALLOWED_HOSTS, value: hosts})\n      return hosts\n    }\n\n    clearApiAllowedHosts({api='default'}) {\n      this.#setApiConfig({api, config: API_CONFIG_ALLOWED_HOSTS, value: null})\n    }\n\n    apiAllowedHosts({api='default', host}) {\n      return this.#getApiConfig({api, config: API_CONFIG_ALLOWED_HOSTS}) || []\n    }\n\n    apiIsEnabled({api='default'}) {\n      const configValue = this.#getApiConfig({api, config: API_CONFIG_ENABLED})\n      if (typeof(configValue) === 'undefined') return true\n      return configValue\n    }\n    enableApi({api='default'}) {\n      return this.#setApiConfig({api, config: API_CONFIG_ENABLED, value: true})\n    }\n    disableApi({api='default', value}) {\n      return this.#setApiConfig({api, config: API_CONFIG_ENABLED, value: false})\n    }\n\n    customBucket({api='default'}) {\n      return this.#getApiConfig({api, config: API_CONFIG_CUSTOM_BUCKET})\n    }\n    setCustomBucket({api='default', bucket}) {\n      return this.#setApiConfig({api, config: API_CONFIG_CUSTOM_BUCKET, value: bucket})\n    }\n\n    customGoogleProject({api='default'}) {\n      return this.#getApiConfig({api, config: API_CONFIG_CUSTOM_GOOGLE_PROJECT})\n    }\n    setCustomGoogleProject({api='default', projectKey}) {\n      return this.#setApiConfig({api, config: API_CONFIG_CUSTOM_GOOGLE_PROJECT, value: projectKey})\n    }\n\n    isRevoked() {\n      return this.revoked === true\n    }\n\n    static async all({skipCache=false}={}) {\n      return cache.wrap({\n        key: 'ApiClient.all',\n        skipCache,\n        op: async () => {\n          const db = Database.instance()\n          const query = db.startQuery(ApiClient.COLLECTION_NAME)\n          return db.getResults(ApiClient, query)\n        }\n      })\n    }\n\n    static async getAllAllowedHosts({api: apiId}) {\n      return cache.wrap({\n        key: `ApiClient.getAllAllowedHosts:${apiId}`,\n        op: async () => {\n          const clients = await ApiClient.all({skipCache: true})\n          return clients.flatMap((c) => c.apiAllowedHosts({api: apiId}))\n        }\n      })\n    }\n\n    apiMaxSuccessesPerSecond({api='default'}) {\n      const rateLimitCfg = this.#getApiConfig({api, config: API_CONFIG_RATE_LIMIT}) || {}\n      return rateLimitCfg.maxSuccessesPerSecond\n    }\n    setMaxSuccessesPerSecond({api='default', value}) {\n      const rateLimitCfg = this.#rawGetApiConfig({api, config: API_CONFIG_RATE_LIMIT}) || {}\n      rateLimitCfg.maxSuccessesPerSecond = value\n      this.#setApiConfig({api, config: API_CONFIG_RATE_LIMIT, value: rateLimitCfg})\n    }\n\n    apiRecaptcha({api='default'}) {\n      const recaptchaCfg = this.#getApiConfig({api, config: API_CONFIG_RECAPTCHA}) || {}\n      return recaptchaCfg\n    }\n\n    setApiRecaptcha({api='default'}, {secret, minScore}) {\n      const recaptchaCfg = this.#rawGetApiConfig({api, config: API_CONFIG_RECAPTCHA}) || {}\n      if (secret) recaptchaCfg.secret = secret\n      if (minScore) recaptchaCfg.minScore = minScore\n      this.#setApiConfig({api, config: API_CONFIG_RECAPTCHA, value: recaptchaCfg})\n    }\n\n    save() {\n        const db = Database.instance()\n        this.updatedAt = Database.toTimestamp(new Date())\n        this.createdAt = this.createdAt || this.updatedAt\n        return db.save(this, `${ApiClient.COLLECTION_NAME}/${this.id}`)\n    }\n\n    #setApiConfig({api, config, value}) {\n      if (!this.apisConfig) {\n        this.apisConfig = {}\n      }\n      if (!this.apisConfig[api]) {\n        this.apisConfig[api] = {}\n      }\n      this.apisConfig[api][config] = value\n    }\n\n    #rawGetApiConfig({api, config}) {\n      if (!this.apisConfig) return null\n      if (!(api in this.apisConfig)) return null\n      return this.apisConfig[api][config]\n    }\n\n    #getApiConfig({api, config}) {\n      let value = this.#rawGetApiConfig({api, config})\n      if (typeof(value) === 'undefined' || value == null) {\n        value = this.#rawGetApiConfig({api: 'default', config})\n      }\n      return value\n    }\n\n    static async get(id, skipCache=false) {\n      return await cache.wrap({\n        key: `ApiClient:${id}`,\n        skipCache,\n        op: async () => {\n          const db = Database.instance()\n          return db.get(ApiClient, id)\n        }\n      })\n    }\n\n    static destroy(id) {\n        if (id === '/' || id === '' || !id) throw new Error(\"Can't delete root\")\n        return Database.instance().delete(`/${ApiClient.COLLECTION_NAME}/${id}`)\n    }\n\n    static build({idSuffix}={}) {\n        let id = this.newId()\n        if (idSuffix) {\n          id = `${id}_${idSuffix}`\n        }\n        return new ApiClient({\n            id,\n            secret: this.newSecret(),\n            exposedSecret: this.newSecret(),\n        })\n    }\n\n    static newId() {\n        return idGenerator.newOrderedId()\n    }\n\n    static newSecret() {\n        return idGenerator.newSecret()\n    }\n}\n","import {Database} from './Database'\nimport {env} from '../../config/env'\n\nexport class User {\n  static get COLLECTION_NAME() {return 'users'}\n\n  constructor({id, email, fullName, company}) {\n    this.id = id\n    this.email = email\n    this.fullName = fullName\n    this.company = company\n  }\n\n  static async get(id) {\n    const db = Database.instance()\n    return await db.get(User, id)\n  }\n\n  static async getByEmail(email) {\n    const db = Database.instance()\n    const query = db.startQuery(User.COLLECTION_NAME)\n      .where('email', '==', email)\n    return await db.getResults(User, query)[0]\n  }\n\n  async save() {\n    if (!env.isLocal()) throw new Error(`Save only in development. This application shouldn't change users`)\n    const db = Database.instance()\n    return db.save(this, `${User.COLLECTION_NAME}/${this.id}`)\n  }\n}\n","import {ApiClient} from '../models/database/ApiClient'\nimport {User} from '../models/database/User'\nimport {SmileTask} from '../models/database/SmileTask'\nimport {RichError} from \"../utils/RichError\"\n\nimport {helpers} from '../routes/helpers'\nimport {asyncMiddleware} from './expressAsync'\n\nexport const getModel = new (class {\n  get client() {\n    return asyncMiddleware('getModel.client', async (req, res, next) => {\n      const clientId = res.locals.dentClientId\n      const client = await ApiClient.get(clientId)\n      if (!client) {\n        throw new RichError({\n          httpCode: 403,\n          id: 'not-authorized',\n          subtype: 'bad-token',\n          debugMessage: `Unauthorized: Could not find client \"${clientId}\"`,\n          debugDetails: {clientId},\n          publicMessage: 'Not Authorized',\n          logLevel: 'debug',\n        })\n      }\n      res.locals.dentClient = client\n    })\n  }\n\n  get user() {\n    return asyncMiddleware('getModel.user', async (req, res, next) => {\n      const userId = req.params['userId']\n      const user = await User.get(userId)\n      if (!user) {\n        throw new RichError({\n          httpCode: 404,\n          id: 'not-found',\n          subtype: 'user-not-found',\n          subtypeIsPublic: true,\n          publicMessage: 'User not found',\n          debugDetails: {userId},\n          logLevel: 'debug',\n        })\n      }\n      res.locals.dentUser = user\n    })\n  }\n\n  get smileTask() {\n    return asyncMiddleware('getModel.smileTask', async (req, res, next) => {\n      const smileTaskId = req.params['smileTaskId']\n      const smileTask = await SmileTask.get(smileTaskId)\n      if (!smileTask) {\n        throw new RichError({\n          httpCode: 404,\n          id: 'not-found',\n          subtype: 'smiletask-not-found',\n          subtypeIsPublic: true,\n          publicMessage: 'SmileTask not found',\n          debugDetails: {smileTaskId},\n          logLevel: 'debug',\n        })\n      }\n      res.locals.dentSmileTask = smileTask\n    })\n  }\n})()\n","import {GcloudPresignedCredentialsProvider} from './GcloudPresignedCredentialsProvider'\nimport {envShared} from '../../shared/envShared'\n\nconst EXPIRATION_IN_SECONDS = 10 * 60\nexport class SmileResourcesGuide {\n    constructor(credentialsProvider) {\n        this.credentialsProvider = credentialsProvider\n    }\n\n    static build() {\n        return new SmileResourcesGuide(GcloudPresignedCredentialsProvider.build())\n    }\n\n    async uploadDescriptor(smileTask, {overwriteImageName=false}={}) {\n        let keyName = smileTask.filepathUploaded\n        if (overwriteImageName) {\n          keyName = keyName.replace(/[^\\/]+(\\..*)$/, `${overwriteImageName}$1`)\n        }\n        return await this.credentialsProvider.jsonToUpload({\n            keyName: keyName,\n            contentType: smileTask.contentType,\n            contentMD5: smileTask.imageMD5,\n            maxSizeInMegabytes: envShared.maxUploadSizeMb,\n            expiresInSeconds: EXPIRATION_IN_SECONDS,\n        })\n    }\n\n    async uplodedDescriptorGet(smileTask) {\n        return await this.credentialsProvider.urlToGet(\n            smileTask.filepathUploaded,\n            {\n                expiresInSeconds: EXPIRATION_IN_SECONDS\n            }\n        )\n    }\n\n    async resultDescriptorGet(smileTask) {\n        return await this.credentialsProvider.urlToGet(\n            smileTask.filepathResult,\n            {\n                expiresInSeconds: EXPIRATION_IN_SECONDS\n            }\n        )\n    }\n}\n","import express from 'express';\nconst router = express.Router();\n\nimport {SmileTask} from \"../../models/database/SmileTask\"\nimport {smileTaskSecurity as security} from \"../../middlewares/smileTaskSecurity\"\nimport {asyncRoute} from '../../middlewares/expressAsync'\nimport {getModel} from \"../../middlewares/getModel\"\nimport {rateLimit} from \"../../middlewares/rateLimit\"\nimport {SmileResourcesGuide} from \"../../models/storage/SmileResourcesGuide\"\nimport {env} from \"../../config/env\"\nimport {helpers} from '../helpers'\n\nconst userRateLimit = rateLimit({\n  limit: env.userRateLimit.amount,\n  expiresIn: env.userRateLimit.timeWindow,\n  lookup: (_, res) => res.locals.dentUser.id,\n})\n\nconst ipRateLimit = rateLimit({\n  limit: env.ipRateLimit.amount,\n  expiresIn: env.ipRateLimit.timeWindow,\n  lookup: (req, _) => req.ip,\n})\n\nconst clientRateLimit = rateLimit({\n  limit: env.clientRateLimit.amount,\n  expiresIn: env.clientRateLimit.timeWindow,\n  lookup: (_, res) => res.locals.dentClient.id,\n})\n\nrouter.post('/solicitation',\nsecurity.getContentType,\nsecurity.getSignature,\nsecurity.getImageMD5,\ngetModel.client,\nsecurity.verifySignature,\nuserRateLimit,\nipRateLimit,\nclientRateLimit,\nasyncRoute(async (req, res) => {\n  const manualReview = req.body.manualReview\n\n  const smileTask = SmileTask.build(SmileTask.RequesterType.inhouseClient(), {\n    ip: req.ip,\n    userId: res.locals.dentUser.id,\n    clientId: res.locals.dentClient.id,\n    imageMD5: res.locals.dentImageMD5,\n    contentType: res.locals.dentImageContentType,\n  })\n\n  const resources = SmileResourcesGuide.build()\n  let uploadDescriptorTask\n  if (manualReview) {\n    uploadDescriptorTask = resources.uploadDescriptor(smileTask, {overwriteImageName: 'smile_review_pending'})\n  } else {\n    uploadDescriptorTask = resources.uploadDescriptor(smileTask)\n  }\n  let [_, uploadDescriptor] = await Promise.all([\n    smileTask.save(),\n    uploadDescriptorTask,\n  ])\n\n  let response = {\n    uploadDescriptor: uploadDescriptor,\n    originalPath: smileTask.filepathUploaded,\n    resultPath: smileTask.filepathResult,\n    preprocessedPath: smileTask.filepathPreprocessed,\n    sideBySidePath: smileTask.filepathSideBySide,\n    sideBySideSmallPath: smileTask.filepathSideBySideSmall,\n    smileTaskId: smileTask.id,\n  }\n\n  if (!manualReview) {\n    response.progressWebsocket = `/ws/smile-tasks/${smileTask.id}`\n  }\n\n  return res.json(response)\n}))\n\nexport default router\n","import path from 'path'\nimport stream from 'stream'\n\nimport {storageFactory} from './storageFactory'\nimport {GcloudPresignedCredentialsProvider} from './GcloudPresignedCredentialsProvider'\nimport {idGenerator} from \"../tools/idGenerator\"\nimport {logger} from '../../instrumentation/logger'\nimport {env} from \"../../config/env\"\nimport {timeInSeconds, nowReadable} from '../../utils/time'\nimport FileType from 'file-type'\nconst {SECONDS, MINUTES, HOURS, DAYS} = timeInSeconds\n\nconst me = new (class {\n  async upload({googleProjectKey, bucket, simulation, uploadsConfig, info, clientId, root='.api-simulations/'}) {\n    const success = simulation.success\n    const folderpath = path.join(root, (success ? 'success' : 'fail'), `${simulation.id}SIM_${clientId}CLI`)\n    const rawUploadsConfig = [{\n      filename: 'info.json',\n      content: me.#prettyJSON({\n        id: simulation.id,\n        success: success,\n        timestamp: nowReadable,\n        clientId: clientId,\n        ...info,\n      }),\n    }]\n    for (let cfgKey of Object.keys(uploadsConfig)) {\n      const content = simulation[cfgKey]\n      if (!content) continue\n      const cfg = uploadsConfig[cfgKey]\n      let {ext: extension} = (await FileType.fromBuffer(content)) || {}\n      extension = extension || cfg.extensionPlaceholder || 'unknown'\n      const filename = cfgKey + `.${extension}`\n      cfg.rawCfg = {\n        filename,\n        content,\n        getUrl: cfg.getUrl,\n        isPublic: cfg.isPublic,\n      }\n      rawUploadsConfig.push(cfg.rawCfg)\n    }\n    await me.rawUpload({\n      googleProjectKey,\n      bucket,\n      uploads: rawUploadsConfig,\n      folderpath,\n    })\n\n    const results = {}\n    Object.keys(uploadsConfig).forEach((cfgKey) => {\n      const {rawCfg} = uploadsConfig[cfgKey]\n      results[cfgKey] = rawCfg || {}\n    })\n    return {\n      results,\n      folderpath,\n    }\n  }\n\n  async rawUpload({googleProjectKey, bucket, uploads = [], folderpath}) {\n    uploads.forEach((up) => {\n      up.filepath = path.join(folderpath, up.filename)\n    })\n\n    const uploadTasks = uploads.map((up) => me.#upload({googleProjectKey, bucket}, up))\n    await Promise.all(uploadTasks)\n\n    const gcloudSigner = GcloudPresignedCredentialsProvider.build({bucket})\n    const urlPromises = uploads.map(async (up) => {\n      if (!up.getUrl) return\n\n      let url = null\n      if (up.isPublic) {\n        url = this.#getPublicUrl({bucket, ...up})\n      } else {\n        url = await gcloudSigner\n          .urlToGet(up.filepath, {expiresInSeconds: 15 * MINUTES})\n          .then(({url}) => url)\n      }\n      up.getUrlSigned = url\n    })\n\n    await Promise.all(urlPromises)\n\n    return uploads\n  }\n\n  async #upload({googleProjectKey, bucket}, {content, filepath, isPublic=false}) {\n    await new Promise((resolve, reject) => {\n      const file = this.#getFile({googleProjectKey, bucket, filepath})\n      const passthroughStream = new stream.PassThrough()\n      passthroughStream.write(content)\n      passthroughStream.end()\n      passthroughStream\n      .pipe(file.createWriteStream({\n        predefinedAcl: isPublic ? 'publicRead' : 'authenticatedRead',\n      }))\n      .on('finish', function() {\n        logger.verbose(`[SUCCESS] Upload: (${bucket}) ${filepath}`)\n        resolve()\n      })\n      .on('error', function(err) {\n        logger.error(`[FAILED] Upload: (${bucket}) ${filepath}`)\n        reject(err)\n      })\n    })\n  }\n\n  #getFile({googleProjectKey, bucket, filepath}) {\n    return storageFactory({projectKey: googleProjectKey})\n      .bucket(bucket)\n      .file(filepath)\n  }\n\n  #getPublicUrl({bucket, filepath}) {\n    return this.#getFile({bucket, filepath}).publicUrl()\n  }\n\n  #prettyJSON(info) {\n    const identation = 4\n    return JSON.stringify(info, null, identation)\n  }\n})()\n\nexport const simulationResultsUploader = me\n","const FLOAT_REGEXP = /^-?[0-9]+(\\.[0-9]+)?$/\n\nexport const normalizer = new (class {\n  toChoicesString(val) {\n    if (typeof(val) === 'undefined' || val === null) return null\n    return val.toString().trim().toLowerCase()\n  }\n\n  toFloat(val) {\n    if (typeof(val) === 'undefined' || val === null) return null\n    if (typeof(val) === 'number') return val\n    val = val.toString()\n    if (val.match(FLOAT_REGEXP)) {\n      return parseFloat(val)\n    }\n    return val\n  }\n})()\n","export const validator = new (class {\n  validateNumber(options) {\n    const errors = []\n    if (validator.#baseChecks({options, addTo: errors})) {\n      return validator.#addErrors({errors, options})\n    }\n    if (validator.#checkType({options, type: 'number', addTo: errors})) {\n      return validator.#addErrors({errors, options})\n    }\n    if (validator.#checkMinMax({options, addTo: errors})) {\n      return validator.#addErrors({errors, options})\n    }\n    return []\n  }\n\n  validateChoices(options) {\n    const errors = []\n    if (validator.#baseChecks({options, addTo: errors})) {\n      return validator.#addErrors({errors, options})\n    }\n    if (validator.#checkType({options, type: 'string', addTo: errors})) {\n      return validator.#addErrors({errors, options})\n    }\n    if (validator.#checkChoices({options, addTo: errors})) {\n      return validator.#addErrors({errors, options})\n    }\n    return []\n  }\n\n  #baseChecks({options, addTo: errors}) {\n    if (validator.#checkCondition({options, addTo: errors})) {\n      validator.#addErrors({errors, options})\n      return true\n    }\n    if (validator.#checkPresence({options, addTo: errors})) {\n      validator.#addErrors({errors, options})\n      return true\n    }\n    return false\n  }\n\n  #checkCondition({options: {condition, value}, addTo: errors}) {\n    if (!condition) return false\n    return !condition()\n  }\n\n  #checkPresence({options: {optional, value, fieldName}, addTo: errors}) {\n    if (optional || validator.#isPresent(value)) return false\n    errors.push({message: `${fieldName} is not present`})\n    return true\n  }\n\n  #checkType({options: {value, fieldName}, type, addTo: errors}) {\n    if (!validator.#isPresent(value)) return false\n    if (typeof(value) === type) return false\n    errors.push({message: `${fieldName} must be of type ${type} (received ${value})`})\n    return true\n  }\n\n  #checkMinMax({options: {value, min, max, fieldName}, addTo: errors}) {\n    if (!validator.#isPresent(value)) return false\n    const vmin = typeof(min) === 'undefined' ? Number.MIN_VALUE : min\n    const vmax = typeof(max) === 'undefined' ? Number.MAX_VALUE : max\n    if ((value-vmin) >= -0.0001 && (vmax-value) >= -0.0001) {\n      return false\n    }\n    const hasMin = typeof(min) !== 'undefined'\n    const hasMax = typeof(max) !== 'undefined'\n    if (hasMin && hasMax) {\n      errors.push({message: `${fieldName} must be between ${min} and ${max} (received ${value})`})\n    } else if (hasMin) {\n      errors.push({message: `${fieldName} must be greather than ${min} (received ${value})`})\n    } else if (hasMax) {\n      errors.push({message: `${fieldName} must be less than ${max} (received ${value})`})\n    }\n    return true\n  }\n\n  #checkChoices({options: {value, choices, fieldName}, addTo: errors}) {\n    if (!validator.#isPresent(value)) return false\n    if (choices.includes(value)) return false\n    errors.push({message: `${fieldName} must be one of the options: ${choices.join(', ')} (received ${value})`})\n    return true\n  }\n\n  #addErrors({errors: newErrors, options: {addTo: allErrors}}) {\n    if (typeof(allErrors) === 'undefined') return newErrors\n    allErrors.push(...newErrors)\n    return allErrors\n  }\n\n  #isPresent(value) {\n    return typeof(value) !== 'undefined' && value !== null\n  }\n})()\n","import {Database} from '../database/Database'\nimport {idGenerator} from '../tools/idGenerator'\nimport {sanitizer} from '../tools/sanitizer'\nimport {normalizer} from '../tools/normalizer'\nimport {validator} from '../tools/validator'\nimport {Enum} from '../tools/Enum'\nimport * as path from 'path'\n\n// Params Constants\nconst PARAM_KEY_STYLE_MODE = 'styleMode'\nconst PARAM_KEY_MIX_FACTOR = 'mixFactor'\nconst PARAM_KEY_MODE = 'mode'\nconst PARAM_KEY_BLEND = 'blend'\nconst PARAM_KEY_BRIGHTNESS = 'brightness'\nconst PARAM_KEY_WHITEN = 'whiten'\nconst ALL_PARAM_KEYS = [\n  PARAM_KEY_STYLE_MODE,\n  PARAM_KEY_MIX_FACTOR,\n  PARAM_KEY_MODE, PARAM_KEY_BLEND,\n  PARAM_KEY_BRIGHTNESS,\n  PARAM_KEY_WHITEN,\n]\n\nconst PARAM_VALUE_STYLE_MODE_AUTO = 'auto'\nconst PARAM_VALUE_STYLE_MODE_MIX = 'mix_manual'\nconst PARAM_VALUE_DEFAULT_STYLE_MODE = PARAM_VALUE_STYLE_MODE_AUTO\nconst STYLE_PARAM_MODE_VALUES = [\n  PARAM_VALUE_STYLE_MODE_AUTO,\n  PARAM_VALUE_STYLE_MODE_MIX,\n]\n\nconst PARAM_VALUE_MODE_COSMETIC = 'cosmetic'\nconst PARAM_VALUE_MODE_ORTHO = 'ortho'\nconst PARAM_VALUE_DEFAULT_MODE = PARAM_VALUE_MODE_COSMETIC\nconst PARAM_MODE_VALUES = [\n  PARAM_VALUE_MODE_COSMETIC,\n  PARAM_VALUE_MODE_ORTHO,\n]\n\nconst PARAM_VALUE_BLEND_POISSON = 'poisson'\nconst PARAM_VALUE_BLEND_REPLACE = 'replace'\nconst PARAM_VALUE_DEFAULT_BLEND = PARAM_VALUE_BLEND_POISSON\nconst PARAM_BLEND_VALUES = [\n  PARAM_VALUE_BLEND_POISSON,\n  PARAM_VALUE_BLEND_REPLACE,\n]\n\nconst PARAM_VALUE_DEFAULT_BRIGHTNESS = 0.0\nconst PARAM_VALUE_DEFAULT_WHITEN = 0.0\n\n// Metadata Constants\nconst MDATA_KEY_SCORE = 'feedbackScore'\nconst MDATA_KEY_CAPTURE = 'captureType'\nconst MDATA_KEY_CUSTOMER_ID = 'externalCustomerId'\nconst ALL_MDATA_KEYS = [\n  MDATA_KEY_SCORE,\n  MDATA_KEY_CAPTURE,\n  MDATA_KEY_CUSTOMER_ID,\n]\n\nconst MDATA_VALUE_CAPTURE_FILE = 'file'\nconst MDATA_VALUE_CAPTURE_CAMERA = 'camera'\nconst MDATA_VALUE_DEFAULT_MODE = null\nconst MDATA_CAPTURE_VALUES = [\n  MDATA_VALUE_CAPTURE_FILE,\n  MDATA_VALUE_CAPTURE_CAMERA,\n]\n\n\n// Attributes Whitelists\nconst PARAMS_WHITELIST = ALL_PARAM_KEYS\nconst METADATA_WHITELIST = ALL_MDATA_KEYS\nconst STORAGE_WHITELIST = [\n  'bucket',\n  'directoryPath',\n  'beforePath',\n  'originalPath',\n  'resultPath',\n]\n\nexport class QuickSimulation {\n  static get COLLECTION_NAME() { return 'quick_simulations' }\n\n  constructor({id, createdAt, clientId, storage={}, params={}, metadata={}} = {}) {\n    this.id = id\n    this.createdAt = createdAt\n    this.clientId = clientId\n    this.storage = storage\n    this.params = params\n    this.metadata = metadata\n  }\n\n  static build({id, createdAt, clientId, storage, params, metadata}={}) {\n    const simulation = new QuickSimulation({\n      id: id || QuickSimulation.newId(),\n      createdAt: createdAt || Database.toTimestamp(new Date()),\n      clientId,\n    })\n    simulation.addStorageData(storage)\n    simulation.addMetadata(metadata)\n    simulation.addParams(params)\n    return simulation\n  }\n\n  async save({attrs, skipNormalization, skipValidation, source}={}) {\n    const db = Database.instance({name: source || Database.sourceOf(this)})\n    if (!skipNormalization) {\n      this.normalizeData()\n    }\n    if (!skipValidation) {\n      const errors = this.validationErrors()\n      if (errors.length > 0) {\n        return {errors}\n      }\n    }\n    const result = await db.save(this, `${QuickSimulation.COLLECTION_NAME}/${this.id}`, false, attrs)\n    return {result}\n  }\n\n  addMetadata(metadata) {\n    if (!metadata) return\n    metadata = sanitizer.onlyKeys(metadata, METADATA_WHITELIST)\n    Object.assign(this.metadata, metadata)\n  }\n\n  addStorageData(storage) {\n    if (!storage) return\n    storage = sanitizer.onlyKeys(storage, STORAGE_WHITELIST)\n    Object.assign(this.storage, storage)\n  }\n\n  addParams(params) {\n    if (!params) return\n    params = sanitizer.onlyKeys(params, PARAMS_WHITELIST)\n    Object.assign(this.params, params)\n  }\n\n  normalizeData() {\n    // Params\n    this.params[PARAM_KEY_MODE] = normalizer.toChoicesString(this.params[PARAM_KEY_MODE] || PARAM_VALUE_DEFAULT_MODE)\n    this.params[PARAM_KEY_BLEND] = normalizer.toChoicesString(this.params[PARAM_KEY_BLEND] || PARAM_VALUE_DEFAULT_BLEND)\n    this.params[PARAM_KEY_BRIGHTNESS] = normalizer.toFloat(this.params[PARAM_KEY_BRIGHTNESS] || PARAM_VALUE_DEFAULT_BRIGHTNESS)\n    this.params[PARAM_KEY_WHITEN] = normalizer.toFloat(this.params[PARAM_KEY_WHITEN] || PARAM_VALUE_DEFAULT_WHITEN)\n    this.params[PARAM_KEY_STYLE_MODE] = normalizer.toChoicesString(this.params[PARAM_KEY_STYLE_MODE] || PARAM_VALUE_DEFAULT_STYLE_MODE)\n    if (this.params[PARAM_KEY_STYLE_MODE] == PARAM_VALUE_STYLE_MODE_MIX) {\n      this.params[PARAM_KEY_MIX_FACTOR] = normalizer.toFloat(this.params[PARAM_KEY_MIX_FACTOR])\n    } else {\n      this.params[PARAM_KEY_MIX_FACTOR] = null\n    }\n\n    // Metadata\n    if (typeof(this.metadata[MDATA_KEY_SCORE]) !== 'undefined') {\n      this.metadata[MDATA_KEY_SCORE] = normalizer.toFloat(this.metadata[MDATA_KEY_SCORE])\n    }\n    if (typeof(this.metadata[MDATA_KEY_CAPTURE]) !== 'undefined') {\n      this.metadata[MDATA_KEY_CAPTURE] = normalizer.toChoicesString(this.metadata[MDATA_KEY_CAPTURE])\n    }\n  }\n\n  validationErrors() {\n    const errors = []\n    validator.validateChoices({\n      fieldName: PARAM_KEY_MODE,\n      value: this.params[PARAM_KEY_MODE],\n      choices: PARAM_MODE_VALUES,\n      addTo: errors,\n    })\n\n    validator.validateChoices({\n      fieldName: PARAM_KEY_BLEND,\n      value: this.params[PARAM_KEY_BLEND],\n      choices: PARAM_BLEND_VALUES,\n      addTo: errors,\n    })\n\n    validator.validateChoices({\n      fieldName: PARAM_KEY_STYLE_MODE,\n      value: this.params[PARAM_KEY_STYLE_MODE],\n      choices: STYLE_PARAM_MODE_VALUES,\n      addTo: errors,\n    })\n\n    validator.validateNumber({\n      fieldName: PARAM_KEY_BRIGHTNESS,\n      value: this.params[PARAM_KEY_BRIGHTNESS],\n      min: -1.0,\n      max: 1.0,\n      addTo: errors,\n    })\n\n    validator.validateNumber({\n      fieldName: PARAM_KEY_WHITEN,\n      value: this.params[PARAM_KEY_WHITEN],\n      min: 0.0,\n      max: 1.0,\n      addTo: errors,\n    })\n\n    validator.validateNumber({\n      fieldName: PARAM_KEY_MIX_FACTOR,\n      value: this.params[PARAM_KEY_MIX_FACTOR],\n      min: 0.0,\n      max: 1.0,\n      condition: () => this.params[PARAM_KEY_STYLE_MODE] == PARAM_VALUE_STYLE_MODE_MIX,\n      addTo: errors,\n    })\n\n    validator.validateNumber({\n      fieldName: MDATA_KEY_SCORE,\n      value: this.metadata[MDATA_KEY_SCORE],\n      min: 0.0,\n      max: 5.0,\n      optional: true,\n      addTo: errors,\n    })\n\n    validator.validateChoices({\n      fieldName: MDATA_KEY_CAPTURE,\n      value: this.metadata[MDATA_KEY_CAPTURE],\n      choices: MDATA_CAPTURE_VALUES,\n      optional: true,\n      addTo: errors,\n    })\n\n    return errors\n  }\n\n  buildJobOptions() {\n    const options = {\n      whiten: this.params[PARAM_KEY_WHITEN],\n      brightness: 1.0 + this.params[PARAM_KEY_BRIGHTNESS],\n      ortho: this.params[PARAM_KEY_MODE] === PARAM_VALUE_MODE_ORTHO,\n      poisson: this.params[PARAM_KEY_BLEND] === PARAM_VALUE_BLEND_POISSON,\n    }\n    if (this.params[PARAM_KEY_STYLE_MODE] === PARAM_VALUE_STYLE_MODE_MIX) {\n      options.mix_factor = this.params[PARAM_KEY_MIX_FACTOR]\n    }\n    return options\n  }\n\n  static async get(id, {source}={}) {\n    const db = Database.instance({name: source})\n    return await db.get(QuickSimulation, id)\n  }\n\n  static async list({orderBy='id', orderAsc=false, filters={}, source}) {\n    const db = Database.instance({name: source})\n    let query = db.startQuery(QuickSimulation.COLLECTION_NAME)\n\n    Object.entries(filters).forEach(([field, value]) => {\n      query = query.where(field, '==', value)\n    })\n\n    query = query\n      .orderBy(orderBy, (orderAsc ? 'asc' : 'desc'))\n      .limit(100)\n    return await db.getResults(QuickSimulation, query)\n  }\n\n  static newId(createdAt) {\n    return idGenerator.newOrderedId()\n  }\n\n  static #prepareBuildAttrs({storage={}, params={}, metadata={}}) {\n    const id = attrs.id || QuickSimulation.newId()\n    const createdAt = attrs.createdAt || Database.toTimestamp(new Date())\n    storage = sanitizer.onlyKeys(storage, STORAGE_WHITELIST)\n    params = sanitizer.onlyKeys(params, PARAMS_WHITELIST)\n    metadata = sanitizer.onlyKeys(metadata, METADATA_WHITELIST)\n    return {\n      id,\n      createdAt,\n      storage,\n      params,\n      metadata,\n    }\n  }\n}\n","import newrelic from 'newrelic'\n\nexport const metrics = new (class {\n  addTag({label, value}) {\n    newrelic.addCustomAttribute(label, value)\n  }\n\n  stopwatch(metricName, func) {\n    return newrelic.startSegment(metricName, true, func)\n  }\n\n  addRequestBytesMeasure({env, apiId, bytes}) {\n    metrics.#addMeasure({\n      name: metrics.#composeName({env, apiId, name: 'RequestBytes'}),\n      value: bytes,\n    })\n  }\n\n  addImageBytesMeasure({env, apiId, bytes}) {\n    metrics.#addMeasure({\n      name: metrics.#composeName({env, apiId, name: 'ImageBytes'}),\n      value: bytes,\n    })\n  }\n\n  addImageDimensionsMeasure({env, apiId, dimensions: {width, height, area, areaSqrt}}) {\n    metrics.#addMeasure({\n      name: metrics.#composeName({env, apiId, name: 'ImageWidth'}),\n      value: width,\n    })\n    metrics.#addMeasure({\n      name: metrics.#composeName({env, apiId, name: 'ImageHeight'}),\n      value: height,\n    })\n    metrics.#addMeasure({\n      name: metrics.#composeName({env, apiId, name: 'ImageArea'}),\n      value: area,\n    })\n    metrics.#addMeasure({\n      name: metrics.#composeName({env, apiId, name: 'ImageAreaSqrt'}),\n      value: areaSqrt,\n    })\n  }\n\n  #addMeasure({name, value}) {\n    newrelic.recordMetric(name, value)\n  }\n\n  #composeName({apiId, env, name}) {\n    return `${apiId}:${env}/${name}`\n  }\n})()\n","import {logger} from '../instrumentation/logger'\nimport {metrics} from '../instrumentation/metrics'\nimport {RichError} from '../utils/RichError'\nimport {TagSet} from '../utils/TagSet'\nimport {env} from '../config/env'\n\nexport const api = new (class {\n  #callbacks = null\n\n  setId({apiId, clientIsFrontend=false}) {\n    if (clientIsFrontend) {\n      apiId = `public-${apiId}`\n    }\n    return (req, res, next) => {\n      res.locals.dentApiId = apiId\n      res.locals.dentIsFrontendRoute = clientIsFrontend\n      this.#setup(req, res)\n      next()\n    }\n  }\n\n  addCallback(callbackId, func) {\n    if (!this.#callbacks) this.#callbacks = {}\n    if (!this.#callbacks[callbackId]) this.#callbacks[callbackId] = []\n    this.#callbacks[callbackId].push(func)\n  }\n\n  corsOnError() {\n    return (req, res, next) => {\n      res.locals.dentCorsOnError = true\n      next()\n    }\n  }\n\n  newNotFoundError() {\n    return new RichError({\n      httpCode: 404,\n      id: 'not-found',\n      publicMessage: 'Not Found',\n      logLevel: undefined,\n    })\n  }\n\n  newServerError({httpCode=500, id='internal-server-error', publicMessage='Internal Server Error', debugMessage}={}) {\n    return new RichError({\n      httpCode,\n      id,\n      publicMessage,\n      debugMessage: debugMessage || publicMessage,\n      logLevel: 'error',\n    })\n  }\n\n  getTags(res) {\n    if (!res.locals.dentApiTags) {\n      res.locals.dentApiTags = new TagSet()\n    }\n    return res.locals.dentApiTags\n  }\n\n  addTags(res, newTags) {\n    const allTags = api.getTags(res)\n    allTags.add(newTags)\n    this.#callCallbacks('tags.add', {\n      allTags: allTags.tags,\n      addedTags: new TagSet(newTags).tags,\n    })\n  }\n\n  getId(res) {\n    return res.locals.dentApiId\n  }\n\n  getInfo(res) {\n    return res.locals.dentApiInfo || {}\n  }\n\n  addInfo(res, extraInfo) {\n    const info = api.getInfo(res)\n    res.locals.dentApiInfo = Object.assign(info, extraInfo)\n    this.#callCallbacks('info.add', {addedInfo: extraInfo, allInfo: info})\n  }\n\n  convertToRichError(err, req, res, next) {\n    const richError = RichError.fromError(err)\n    if (!richError) {\n      logger.warn(\"Can't convert it to RichError\", err)\n      return next(err)\n    }\n    const info = api.getInfo(res)\n    richError.addDebugDetails(info)\n    api.addTags(res, richError.tags)\n    return next(richError)\n  }\n\n  #setup(req, res) {\n    const {dentIsFrontendRoute: isFrontEndRoute} = res.locals\n    const apiId = this.getId(res)\n    const requestInfo = this.#getReqInfo(req)\n    const envInfo = this.#getEnvInfo()\n    this.addInfo(res, {\n      api: {\n        id: apiId,\n        isFrontEndRoute,\n      },\n      request: requestInfo,\n      env: envInfo,\n    })\n\n    const reqSize = req.headers['content-length']\n    if (typeof(reqSize) !== 'undefined') {\n      metrics.addRequestBytesMeasure({apiId, env: env.name, bytes: reqSize})\n    }\n    this.addTags(res, this.#tagsFor({req, res, reqSize}))\n  }\n\n  #tagsFor({req, res, reqSize}) {\n    const {dentIsFrontendRoute: isFrontEndRoute} = res.locals\n    const apiId = this.getId(res)\n    const originalTags = {\n      'api:id': apiId,\n      \"api:isFrontEndRoute\": String(isFrontEndRoute),\n      'req:method': req.method,\n      'req:protocol': req.protocol,\n      \"env:name\": env.name,\n    }\n    if (typeof(reqSize) !== 'undefined') {\n      originalTags['req:content:megabytes'] = (reqSize/1024.0/1024.0).toFixed(3)\n    }\n    return new TagSet(originalTags)\n  }\n\n  #getReqInfo(req) {\n    return api.#pick(req, ['method', 'headers', 'protocol', 'query', 'baseurl', 'ip', 'originalurl', 'path'])\n  }\n\n  #getEnvInfo() {\n    return {\n      name: env.name,\n    }\n  }\n\n  #pick(obj, keys) {\n    return keys.reduce((o,k) => Object.assign(o, {[k]: obj[k]}), {})\n  }\n\n  #callCallbacks(callbackId, params) {\n    if (!this.#callbacks || !this.#callbacks[callbackId]) return\n    for (let callback of this.#callbacks[callbackId]) {\n      callback(params)\n    }\n  }\n})()\n","import {helpers} from '../routes/helpers'\nimport {asyncMiddleware} from './expressAsync'\nimport {envShared} from \"../shared/envShared\"\nimport {Uri} from '../models/tools/Uri'\nimport {api} from './api'\nimport {RichError} from '../utils/RichError'\n\nexport const cors = new (class {\n  enforceCors({hosts, methods, headers, skipValidation=false}) {\n    return asyncMiddleware('cors.enforceCors', async (req, res, next) => {\n      if (skipValidation) {\n        helpers.setAllowingCors(req, res)\n        return\n      }\n      const origin = helpers.normalizedOriginForCors(req)\n      if (!origin || !hosts || !hosts.length) {\n        throw cors.#newCorsError({\n          message: \"Couldn't get origin or allowed origins aren't configured\",\n          details: {\n            originNormalized: origin,\n            allowed: {hosts, methods, headers,},\n          }\n        })\n      }\n      const normalizedAllowedHosts = []\n      for (let i = 0; i < hosts.length; i++) {\n        const allowedHost = helpers.normalizeOrigin(hosts[i], 'https')\n        normalizedAllowedHosts.push(allowedHost)\n      }\n      if (!normalizedAllowedHosts.includes(origin)) {\n        throw cors.#newCorsError({\n          message: \"Origin on header doesn't match the allowed ones for this client\",\n          details: {\n            originNormalized: origin,\n            allowed: {hosts, methods, headers,},\n          },\n        })\n      }\n      helpers.setAllowingCors(req, res)\n    })\n  }\n\n  #newCorsError({message, details={}}) {\n    return new RichError({\n      httpCode: 403,\n      id: 'not-authorized',\n      subtype: 'cors-block',\n      debugMessage: message,\n      debugDetails: details,\n      publicMessage: 'Not Authorized',\n      logLevel: 'debug',\n    })\n  }\n})()\n","import FileType from 'file-type'\nimport imageSize from 'image-size'\nimageSize.disableFS(true)\nimageSize.disableTypes(['tiff', 'ico', 'gif', 'psd', 'svg', 'tga', 'icns'])\n\nconst EXIF_ROTATING_ORIENTATIONS = [3, 5, 6, 7, 8]\n\nexport const imgHelpers = new (class {\n  getDimensions(imgBuffer) {\n    const dimensions = imgHelpers.#safeImageSize(imgBuffer)\n    if (!dimensions) return\n    let {width, height, orientation} = dimensions\n    const isExifRotated = EXIF_ROTATING_ORIENTATIONS.includes(dimensions.orientation)\n    if (isExifRotated) {\n      width = dimensions.height\n      height = dimensions.width\n    }\n\n    return {width, height}\n  }\n\n  async getExtension(imgBuffer) {\n    if (!imgBuffer) return\n    const {ext: extension} = (await FileType.fromBuffer(imgBuffer)) || {}\n    return extension\n  }\n\n  #safeImageSize(imgBuffer) {\n    if (!imgBuffer) return\n    try {\n      return imageSize(imgBuffer)\n    } catch (err) {\n      if (err instanceof TypeError) {\n        return undefined\n      } else {\n        throw err\n      }\n    }\n  }\n})()\n","import { Writable } from 'stream'\n\nexport class BufferWritable extends Writable {\n  constructor(options) {\n    super(options);\n    this.content = []\n  }\n  _write(chunk, encoding, callback) {\n    this.content.push(chunk)\n    callback()\n  }\n  _final(callback) {\n    this.content = Buffer.concat(this.content)\n    callback()\n  }\n}\n","import fs from 'fs'\nimport path from 'path'\nimport {promisify} from \"util\"\nimport multer from 'multer'\nimport axios from 'axios'\n\nimport {cors} from './cors'\nimport {api} from './api'\nimport {rateLimit} from \"./rateLimit\"\n\nimport {env} from \"../config/env\"\nimport {simpleCrypto} from \"../shared/simpleCrypto\"\nimport {RichError} from \"../utils/RichError\"\nimport {imgHelpers} from \"../utils/imgHelpers\"\nimport {logger} from '../instrumentation/logger'\nimport {metrics} from '../instrumentation/metrics'\nimport {ApiClient} from \"../models/database/ApiClient\"\nimport {QuickSimulation} from \"../models/database/QuickSimulation\"\n\nimport {helpers} from '../routes/helpers'\nimport {asyncMiddleware, invokeMiddleware, invokeMiddlewares} from './expressAsync'\n\nimport {timeInSeconds} from \"../utils/time\"\nconst {SECONDS, MINUTES, HOURS, DAYS} = timeInSeconds\n\nimport {BufferWritable} from \"../utils/BufferWritable\"\n\nconst readfile = promisify(fs.readFile)\n\nconst SIGNATURE_HEADER = 'Authorization'\n\n// Claims Constants\nconst CLAIM_CLIENT_ID = 'clientId'\nconst CLAIM_PARAMS_HASHED = 'paramsHashed'\nconst CLAIM_RECAPTCHA_TOKEN = 'recaptchaToken'\nconst ALL_CLAIMS = [CLAIM_CLIENT_ID, CLAIM_RECAPTCHA_TOKEN, CLAIM_PARAMS_HASHED]\nconst MANDATORY_CLAIMS = [CLAIM_CLIENT_ID, CLAIM_PARAMS_HASHED]\n\nconst multerUpload = multer({\n  storage: multer.memoryStorage(),\n  limits: {\n    fieldSize: 1*1024*1024,\n    fileSize: env.quickApiMaxUploadSizeBytes+1024,\n    files: 1,\n  }\n})\n\nexport const quickApi = new (class {\n  get enforceCors() {\n    return asyncMiddleware('quickApi.enforceCors', async (req, res, next) => {\n      const {dentApiId: apiId, dentClient: client} = res.locals\n      const hosts = client.apiAllowedHosts({api: apiId})\n      const enforce = cors.enforceCors({\n        hosts,\n        methods: ['POST'],\n        headers: [SIGNATURE_HEADER],\n        skipValidation: !hosts || hosts.length === 0,\n      })\n      return await invokeMiddleware(enforce, req, res)\n    })\n  }\n\n  get enforcePreflightCors() {\n    return asyncMiddleware('quickApi.enforcePreflightCors', async (req, res, next) => {\n      const {dentApiId: apiId} = res.locals\n      const allowedHosts = await ApiClient.getAllAllowedHosts({api: apiId})\n      const enforce = cors.enforceCors({\n        hosts: allowedHosts,\n        methods: ['OPTIONS'],\n      })\n      return await invokeMiddleware(enforce, req, res)\n    })\n  }\n\n  get validateApiVisibility() {\n    return asyncMiddleware('quickApi.validateApiVisibility', async (req, res, next) => {\n      const {dentApiId: apiId, dentClient: client} = res.locals\n      if (!client.apiIsEnabled({api: apiId})) {\n        throw quickApi.#newAuthorizationError({\n          subtype: 'no-access-to-route',\n          message: \"The client aren't authorized to access this route\",\n        })\n      }\n    })\n  }\n\n  get validateClient() {\n    return asyncMiddleware('quickApi.validateClient', async (req, res, next) => {\n      const {dentClient: client} = res.locals\n      if (client.isRevoked()) {\n        throw quickApi.#newAuthorizationError({\n          subtype: 'token-revoked',\n          message: \"This client access was revoked\",\n        })\n      }\n    })\n  }\n\n  rateLimit({ip: ipLimiting=true, client: clientLimiting=true}={}) {\n    return asyncMiddleware('quickApi.rateLimit', async (req, res, next) => {\n      const {dentApiId: apiId, dentClient: client} = res.locals\n      const timeWindowMillis = env.quickApiRateLimit_timeWindowSeconds * 1000.0\n\n      const ipLimitRequestsPerSecond = rateLimit({\n        limit: env.quickApiRateLimit_ipRequestsPerTimeWindow,\n        expiresIn: timeWindowMillis,\n        lookup: (req, _) => `rlimit:ip:${req.ip}:requests`,\n        onBlocked: function(req, res, next) {\n          throw quickApi.#newRateLimitError({\n            message: 'Exceeded IP requests rate',\n            tags: {'error:rate-limit': 'ip-requests'},\n          })\n        }\n      })\n      const clientLimitRequestsPerSecond = rateLimit({\n        limit: env.quickApiRateLimit_clientRequestsPerTimeWindow,\n        expiresIn: timeWindowMillis,\n        lookup: (req, _) => `rlimit:client:${client.id}:requests`,\n        onBlocked: function(req, res, next) {\n          throw quickApi.#newRateLimitError({\n            message: 'Exceeded client requests rate',\n            tags: {'error:rate-limit': 'client-requests'},\n          })\n        }\n      })\n\n      const ipLimitSimulationsPerSecond = rateLimit({\n        limit: env.quickApiRateLimit_ipSimulationsPerTimeWindow,\n        expiresIn: timeWindowMillis,\n        lookup: (req, _) => `rlimit:ip:${req.ip}:simulations`,\n        countIf: (_, res) => quickApi.hasStartedSimulation(res),\n        onBlocked: function(req, res, next) {\n          throw quickApi.#newRateLimitError({\n            message: 'Exceeded IP simulations rate',\n            tags: {'error:rate-limit': 'ip-simulations'},\n          })\n        }\n      })\n      const clientLimitSimulationsPerSecond = rateLimit({\n        limit: env.quickApiRateLimit_clientSimulationsPerTimeWindow,\n        expiresIn: timeWindowMillis,\n        lookup: (req, _) => `rlimit:client:${client.id}:simulations`,\n        countIf: (_, res) => quickApi.hasStartedSimulation(res),\n        onBlocked: function(req, res, next) {\n          throw quickApi.#newRateLimitError({\n            message: 'Exceeded client simulations rate',\n            tags: {'error:rate-limit': 'client-simulations'},\n          })\n        }\n      })\n\n\n      const all = []\n      // Limiting any requests\n      if (ipLimiting) all.push(ipLimitRequestsPerSecond)\n      if (clientLimiting) all.push(clientLimitRequestsPerSecond)\n\n      // Limiting simulations\n      if (ipLimiting) all.push(ipLimitSimulationsPerSecond)\n      if (clientLimiting) all.push(clientLimitSimulationsPerSecond)\n\n      return await invokeMiddlewares(all, req, res)\n    })\n  }\n\n  get parseRequestBody() {\n    return asyncMiddleware('quickApi.parseRequestBody', async (req, res, next) => {\n      const {fields, files} = await quickApi.#readBody(req, res)\n      const {data: dataJson} = fields\n      const data = quickApi.#parseJson(dataJson) || {}\n      const images = {}\n      for (let fileKey in files) {\n        if (fileKey.startsWith('img')) {\n          images[fileKey] = files[fileKey]\n        }\n      }\n      res.locals.dentParsedBody = {\n        data,\n        dataJson,\n        images,\n      }\n    })\n  }\n\n  async #readBody(req, res) {\n    if (req.rawBodyJson) {\n      return {\n        fields: {data: req.rawBodyJson},\n        files: {},\n      }\n    } else {\n      return quickApi.#readBodyForm(req, res)\n    }\n  }\n\n  async #readBodyForm(req, res) {\n    await invokeMiddleware(multerUpload.any(), req, res)\n    const fields = req.body || {}\n    const allFiles = req.files || []\n    const files = {}\n    allFiles.forEach((file) => {\n      file.originalFilename = file.originalname\n      file.content = file.buffer\n      delete file.buffer\n      file.filenameExtension = path.extname(file.originalFilename)\n      files[file.fieldname] = file\n\n      const {dentApiId: apiId} = res.locals\n      metrics.addImageBytesMeasure({apiId, env: env.name, bytes: file.size})\n      api.addTags(res, {\n        \"simulation:params:image:megabytes\": (file.size/1024.0/1024.0).toFixed(3),\n      })\n\n      if (file.size >= env.quickApiMaxUploadSizeBytes) {\n        file.content = '[HIDDEN]'\n        throw quickApi.#newBadParamsError({\n          subtype: 'size-limit-exceeded',\n          message: `${file.fieldname} is too big`,\n          details: {\n            receivedFile: file,\n          }\n        })\n      }\n    })\n\n    api.addInfo(res, {multipartData: {files, fields}})\n    return {fields, files}\n  }\n\n  dataToQuickSimulation({customizable, force={}}={}) {\n    return asyncMiddleware('quickApi.dataToSimulationOptions', async (req, res, next) => {\n      const clientId = res.locals.dentClientId\n      const {data: bodyData, images: bodyImages} = res.locals.dentParsedBody\n      await quickApi.#processImageFields({\n        res,\n        images: bodyImages,\n        imgFields: ['imgPhoto'],\n      })\n\n      const params = Object.assign({}, bodyData, force)\n      if (typeof(customizable) !== 'undefined') {\n        Object.keys(params).forEach((key) => {\n          if (!customizable.includes(key) && !(key in force)) {\n            delete params[key]\n          }\n        })\n      }\n\n      const quickSimulation = QuickSimulation.build({\n        clientId,\n        params,\n        metadata: bodyData,\n      })\n      quickSimulation.normalizeData()\n      const errors = quickSimulation.validationErrors()\n      if (errors.length > 0) {\n        const {message} = errors[0]\n        throw quickApi.#newBadParamsError({\n          subtype: 'body-validation-error',\n          message,\n        })\n      }\n      for (const [key, value] of Object.entries(quickSimulation.params)) {\n        api.addTags(res, {\n          [`simulation:params:${key}`]: String(value),\n        })\n      }\n      res.locals.dentQuickSimulation = quickSimulation\n    })\n  }\n\n  /**\n   * Validate the existence of required images in the request and \n   * get the extension and dimension info of them.\n   * \n   * @param {object} param\n   * @param[0] {object (images) } - Image list\n   * @param[1] {array (imgFields) } - List of image fields\n   * @param[2] {object (res) } - Response object\n   */\n  async #processImageFields({images, imgFields, res}) {\n    for (var i = 0; i < imgFields.length; i++) {\n      const field = imgFields[i]\n      const photo = images[field]\n\n      if (!photo || !photo.content || photo.size === 0) {\n        throw quickApi.#newBadParamsError({\n          subtype: 'no-photo',\n          message: `${field} is mandatory`,\n          details: {\n            imgParamsReceived: Object.keys(images)\n          }\n        })\n      }\n\n      const extension = await imgHelpers.getExtension(photo.content)\n      if (extension) {\n        api.addTags(res, {\n          \"simulation:params:image:extension\": extension,\n        })\n      }\n\n      if (!extension || !extension.match(env.supportedImagesFilepathRegex)) {\n        throw quickApi.#newBadParamsError({\n          subtype: 'unknown-format',\n          message: `${field} format is unknown`,\n          details: {\n            receivedPhotoType: extension\n          }\n        })\n      }\n\n      const dimensions = await imgHelpers.getDimensions(photo.content)\n      if (dimensions) {\n        const {width, height} = dimensions\n        const area = width * height\n        const areaSqrt = Math.round(Math.sqrt(area))\n        api.addTags(res, {\n          \"simulation:params:image:width\": String(width),\n          \"simulation:params:image:height\": String(height),\n          \"simulation:params:image:area\": String(area),\n          \"simulation:params:image:areaSqrt\": String(areaSqrt),\n        })\n        const {dentApiId: apiId} = res.locals\n        metrics.addImageDimensionsMeasure({apiId, env: env.name, dimensions: {width, height, area, areaSqrt}})\n      }\n    }\n  }\n\n  get parseAuthToken() {\n    return asyncMiddleware('quickApi.parseAuthToken', async (req, res) => {\n      const token = quickApi.#getToken(req)\n      const queryClientId = req.query.clientId\n      delete req.query.clientId\n      if (!token && !queryClientId) {\n        throw quickApi.#newAuthorizationError({\n          subtype: 'no-token',\n          message: \"Didn't received token\",\n        })\n      }\n\n      let clientId = undefined\n      let parsedToken = {}\n      if (token) {\n        const tokenProcessed = quickApi.#parseToken(token)\n        clientId = tokenProcessed.clientId\n        parsedToken = tokenProcessed.parsedToken\n      } else {\n        clientId = queryClientId\n      }\n      api.addInfo(res, {\n        \"security\": {\n          \"client-id\": clientId,\n          \"signature\": parsedToken.signature,\n        },\n      })\n\n      res.locals.dentClientId = clientId\n      res.locals.dentParsedToken = parsedToken\n    })\n  }\n\n  #parseToken(token) {\n    if (token.includes(':')) {\n      return quickApi.#parseSignedClaims(token)\n    } else {\n      return quickApi.#parseSimpleClaims(token)\n    }\n  }\n\n  #parseSimpleClaims(b64Claims) {\n    const {claims, claimsJson} = quickApi.#decodeClaimsJson(b64Claims)\n    const clientId = claims[CLAIM_CLIENT_ID]\n    const parsedToken = {\n      claims,\n      claimsJson,\n    }\n    return {\n      clientId,\n      parsedToken,\n    }\n  }\n\n  #parseSignedClaims(token) {\n    const parts = token.split(':')\n    if (parts.length !== 2 || !parts[0] || !parts[1]) {\n      throw quickApi.#newAuthorizationError({\n        message: `Token invalid \"${token}\"`,\n        details: {\n          receivedToken: token,\n        }\n      })\n    }\n\n    const b64Claims = parts[0]\n    const signature = parts[1]\n\n    const {claims, claimsJson} = quickApi.#decodeClaimsJson(b64Claims)\n    MANDATORY_CLAIMS.forEach((claimKey) => {\n      if (!claims[claimKey]) {\n        throw quickApi.#newAuthorizationError({\n          subtype: 'missing-claim',\n          message: `Missing '${claimKey}' on claims - \"${token}`,\n          details: {\n            receivedToken: token,\n            receivedClaims: claimsJson,\n            mandatoryClaims: MANDATORY_CLAIMS,\n          }\n        })\n      }\n    })\n\n    const clientId = claims[CLAIM_CLIENT_ID]\n    const parsedToken = {\n      claimsJson,\n      claims,\n      signature,\n    }\n\n    return {clientId, parsedToken}\n  }\n\n  #decodeClaimsJson(b64Claims) {\n    const claimsJson = simpleCrypto.base64Decode(b64Claims)\n    if (!claimsJson) {\n      throw quickApi.#newAuthorizationError({\n        message: `Couldn't decode claims json \"${b64Claims}\"`,\n        details: {\n          receivedToken: token,\n          receivedClaimsInBase64: b64Claims,\n        }\n      })\n    }\n\n    const claims = quickApi.#parseJson(claimsJson)\n    if (!claims) {\n      throw quickApi.#newAuthorizationError({\n        message: `claims is not a valid json - ${claimsJson}`,\n        details: {\n          receivedToken: token,\n          receivedClaims: claimsJson,\n        }\n      })\n    }\n    return {claims, claimsJson}\n  }\n\n  get validateRecaptcha() {\n    return asyncMiddleware('quickApi.validateRecaptcha', async (req, res) => {\n      const {dentApiId: apiId, dentClient: client} = res.locals\n      const {claims} = res.locals.dentParsedToken\n      const {secret, minScore=0.75} = client.apiRecaptcha({api: apiId}) || {}\n      if (!secret) {\n        quickApi.#addRecaptchaTag(res, 'skipped')\n        return\n      }\n      const token = claims[CLAIM_RECAPTCHA_TOKEN]\n\n      const data = await quickApi.#requestRecaptcha({secret, token, ip: req.ip})\n      const isValid = data && data.success && data.score >= minScore\n      if (isValid) {\n        quickApi.#addRecaptchaTag(res, 'accepted')\n      } else if (env.recaptchaIgnore) {\n        quickApi.#addRecaptchaTag(res, 'ignored')\n      } else {\n        quickApi.#addRecaptchaTag(res, 'refused')\n        throw quickApi.#newAuthorizationError({\n          subtype: 'failed-recaptcha',\n          message: `Failed on recaptcha validation`,\n          details: {\n            googleResponse: data,\n            minScore,\n          }\n        })\n      }\n    })\n  }\n\n  #addRecaptchaTag(res, tagValue) {\n    api.addTags(res, {'recaptcha:validation': tagValue})\n  }\n\n  async #requestRecaptcha({secret, token, ip}) {\n    const {data} = await axios.post(`https://www.google.com/recaptcha/api/siteverify?secret=${secret}&response=${token}&remoteip=${ip}`)\n    return data\n  }\n\n  #parseJson(str) {\n    try {\n      return JSON.parse(str)\n    } catch {\n      return null;\n    }\n  }\n\n  validateAuthToken({secretKey}) {\n    return asyncMiddleware('quickApi.validateAuthToken', async (req, res) => {\n      const {dentClient: client, dentIsFrontendRoute: isFrontEndRoute} = res.locals\n      if (!isFrontEndRoute) return\n      const {claimsJson, signature} = res.locals.dentParsedToken\n      const isValid = claimsJson && simpleCrypto.verifySignatureHmac(signature, claimsJson, client[secretKey])\n      if (!isValid) {\n        throw quickApi.#newAuthorizationError({\n          message: `Claims JSON signature doesn't match it`,\n          details: {\n            signatureReceived: signature,\n            claimsJsonReceived: claimsJson,\n          }\n        })\n      }\n    })\n  }\n\n\n  get validateBodyData() {\n    return asyncMiddleware('quickApi.validateBodyData', async (req, res) => {\n      if (!res.locals.dentIsFrontendRoute) {\n        return\n      }\n      const {claims} = res.locals.dentParsedToken\n      const {dataJson: bodyDataJson, images} = res.locals.dentParsedBody\n\n      const paramsHashed = claims[CLAIM_PARAMS_HASHED]\n      const hashesKeys = Object.keys(paramsHashed)\n      const keys = Object.keys(images)\n      if (bodyDataJson) keys.push('data')\n      if (!quickApi.#hasSameValues(hashesKeys, keys)) {\n        throw quickApi.#newAuthorizationError({\n          message: `Request data does not match token claims - ${keys} - ${hashesKeys}`,\n          details: {\n            hashedParamsOnTokenClaims: hashesKeys,\n            keysReceivedOnBody: keys,\n          }\n        })\n      }\n\n      const keysLength = keys.length\n      for (let i = 0; i < keysLength; i++) {\n        const key = keys[i]\n        const val = (key === 'data' ? bodyDataJson : images[key].content)\n        const hash = paramsHashed[key]\n        const verificationHash = simpleCrypto.md5(val)\n        if (hash !== verificationHash) {\n          throw quickApi.#newAuthorizationError({\n            message: `Hashed param \"${key}\" does not match claims received on token`,\n            details: {\n              paramHashReceived: paramsHashed,\n              paramHashExpected: verificationHash,\n              originalValue: val,\n            }\n          })\n        }\n      }\n    })\n  }\n\n  setSimulationStarted(res) {\n    res.locals.dentSimulationWasStarted = true\n  }\n\n  hasStartedSimulation(res) {\n    const {dentSimulationWasStarted} = res.locals\n    return !!dentSimulationWasStarted\n  }\n\n  #hasSameValues(a, b) {\n    const len = a.length\n    if (len !== b.length) return false;\n    a = Array.prototype.concat(a)\n    b = Array.prototype.concat(b)\n    a.sort()\n    b.sort()\n    for (let i = 0; i < len; i++) {\n      if (a[i] !== b[i]) return false;\n    }\n    return true;\n  }\n\n  #getToken(req) {\n    const signatureHeader = helpers.normalizeParamValue(req.get(SIGNATURE_HEADER))\n    if (!signatureHeader) return null\n\n    const match = signatureHeader.match(/^Bearer\\s+(.*)\\s*$/)\n    if (!match) return null;\n    return match[1]\n  }\n\n  #newRateLimitError({message, tags}) {\n    return new RichError({\n      httpCode: 429,\n      id: 'too-many-requests',\n      subtype: 'rate-limit',\n      subtypeIsPublic: true,\n      publicMessage: 'Too Many Requests',\n      debugMessage: message,\n      logLevel: 'debug',\n      tags,\n    })\n  }\n\n  #newBadParamsError({subtype, message, details={}}) {\n    return new RichError({\n      id: 'bad-params',\n      subtype,\n      subtypeIsPublic: true,\n      httpCode: 422,\n      debugDetails: details,\n      publicMessage: message,\n      logLevel: 'debug',\n    })\n  }\n\n  #newAuthorizationError({subtype='bad-token', message, details={}}) {\n    return new RichError({\n      id: 'not-authorized',\n      subtype,\n      httpCode: 403,\n      debugMessage: message,\n      debugDetails: details,\n      publicMessage: 'Not Authorized',\n      logLevel: 'debug',\n    })\n  }\n})()\n","import {getNowInSecs} from '../../utils/time'\n\nexport class TimeoutManager {\n  constructor({onTimeout, onBlow}={}) {\n    this.timedout = false\n    this.expiredTimeout = null\n    this.timeouts = {}\n    this.onBlowCb = onBlow || ((data) => {\n      throw new Error(`Timeout: Operation took too long timeoutId:${data.id}`)\n    })\n    this.callbacks = []\n    this.onTimeout(onTimeout)\n  }\n\n  async exec(timeoutSecs, operation, {id, onTimeout, onBlow, extraData}={}) {\n    if (this.hasTimedout()) {\n      this.#asPromise(onTimeout)\n      return await this.blowIfTimedout()\n    }\n    id = this.start(timeoutSecs, {id, onTimeout, onBlow, extraData})\n    const result = await Promise.race([\n      this.#asPromise(operation),\n      this.#blowOnTimeout({onBlow, extraData})\n    ])\n    this.clear(id)\n    await this.blowIfTimedout()\n    return result\n  }\n\n  start(timeoutSecs, {id, onTimeout, onBlow, extraData}={}) {\n    if (this.hasTimedout()) {\n      this.#asPromise(onTimeout)\n      return\n    }\n    const nowSecs = getNowInSecs()\n    const timeoutObj = {\n      onBlowCb: onBlow,\n      extraData: extraData || {},\n      startedAt: nowSecs,\n      duration: timeoutSecs,\n    }\n    const clearId = setTimeout(async () => {\n      if (!this || this.timedout) return\n      this.timedout = true\n      this.expiredTimeout = timeoutObj\n      this.clearAll()\n      await Promise.all([\n        this.#asPromise(onTimeout),\n        this.#callCallbacks(),\n      ])\n    }, timeoutSecs * 1000.0)\n\n    if (!id) id = clearId\n    Object.assign(timeoutObj, {\n      id,\n      clearId,\n    })\n    this.timeouts[id] = timeoutObj\n    return id\n  }\n\n  clear(id) {\n    const timeout = this.timeouts[id]\n    if (!timeout) return\n    clearTimeout(timeout.clearId)\n    delete this.timeouts[id]\n  }\n\n  clearAll() {\n    Object.keys(this.timeouts).forEach(() => this.clear())\n  }\n\n  onTimeout(op) {\n    if (this.hasTimedout()) {\n      this.#asPromise(op)\n      return\n    }\n    if (op) this.callbacks.push(op)\n  }\n\n  missingSecondsToExpire() {\n    const expiresAtSecs = this.nextExpiresAtInSeconds()\n    const nowSecs = getNowInSecs()\n    return max(0.0, expiresAtSecs - nowSecs)\n  }\n\n  nextExpiresAtInSeconds() {\n    if (this.timedout) return 0\n    const ids = Object.keys(this.timeouts)\n    if (!ids.length) return 0\n    let minExpiresAt = null\n    ids.forEach((id) => {\n      const timeout = this.timeouts[id]\n      if (timeout) {\n        const expiresAt = timeout.startedAt + timeout.duration\n        if (minExpiresAt !== null && expiresAt < minExpiresAt) {\n          minExpiresAt = expiresAt\n        }\n      }\n    })\n    return minExpiresAt || 0\n  }\n\n  hasTimedout() {\n    return this.timedout\n  }\n\n  async blowIfTimedout() {\n    return this.blowIfTimedoutSync()\n  }\n\n  blowIfTimedoutSync() {\n    if (this.hasTimedout()) {\n      const timeout = this.expiredTimeout\n      this.clearAll()\n      return (timeout.onBlowCb || this.onBlowCb)(timeout)\n    }\n  }\n\n  async waitForTimeout() {\n    return new Promise((resolve, reject) => {\n      this.onTimeout(() => resolve())\n    })\n  }\n\n  async #blowOnTimeout() {\n    await this.waitForTimeout()\n    return await this.blowIfTimedout()\n  }\n\n  async #callCallbacks() {\n    return Promise.all(this.callbacks.map((cb) => this.#asPromise(cb)))\n  }\n\n  async #asPromise(obj) {\n    if (typeof(obj) === 'function') {\n      const f = async () => obj()\n      obj = f()\n    }\n    return Promise.resolve(obj)\n  }\n}\n","import onFinished from 'on-finished'\nimport onHeaders from 'on-headers'\n\nimport {helpers} from '../routes/helpers'\nimport {TimeoutManager} from '../models/tools/TimeoutManagerV2'\nimport {asyncMiddleware, invokeMiddleware} from './expressAsync'\nimport {RichError} from '../utils/RichError'\n\nexport const timeout = new (class {\n  getManager(res) {\n    let manager = res.locals.dentTimeout\n    if (!manager) {\n      res.locals.dentTimeout = manager = new TimeoutManager({\n        onBlow: ({id, extraData: {overrideHttpCode}}) => {\n          const httpCode = overrideHttpCode || 504\n          throw new RichError({\n            id: 'timeout',\n            httpCode,\n            publicMessage: 'Operation took too long',\n            debugMessage: `Operation id:${id} took too long.`,\n            logLevel: 'debug',\n            tags: {\n              'error:timeout': id,\n            },\n          })\n        }\n      })\n      onFinished(res, () => manager.clearAll())\n      onHeaders(res, () => manager.clearAll())\n    }\n    return manager\n  }\n\n  ensure({id, timeoutSecs, overrideHttpCode}, middlewares=null) {\n    if (middlewares) return timeout.#localEnsure({id, timeoutSecs, overrideHttpCode}, middlewares)\n    else return timeout.#globalEnsure({id, timeoutSecs, overrideHttpCode})\n  }\n\n  get blowIfTimedout() {\n    return asyncMiddleware('timeout.blowIfTimedout', async (req, res) => {\n      const manager = timeout.getManager(res)\n      await manager.blowIfTimedout()\n    })\n  }\n\n  #globalEnsure({id, timeoutSecs, overrideHttpCode}) {\n    return asyncMiddleware('timeout.#globalEnsure', async (req, res) => {\n      const manager = timeout.getManager(res)\n      await manager.blowIfTimedout()\n      manager.start(timeoutSecs, {id, extraData: {overrideHttpCode}})\n    })\n  }\n\n  #localEnsure({id, timeoutSecs, overrideHttpCode}, middlewares) {\n    return asyncMiddleware('timeout.#localEnsure', async (req, res) => {\n      const manager = timeout.getManager(res)\n      await manager.blowIfTimedout()\n\n      await manager.exec(timeoutSecs, async () => {\n        for(let i = 0; i < middlewares.length; i++) {\n          const middleware = middlewares[i]\n          await invokeMiddleware(middleware, req, res)\n        }\n      }, {id, extraData: {overrideHttpCode}})\n    })\n  }\n\n  async #asPromise(obj) {\n    if (typeof(obj) === 'function') {\n      const f = async () => obj()\n      obj = f()\n    }\n    return Promise.resolve(obj)\n  }\n})()\n","import {metrics} from '../instrumentation/metrics'\nimport {asyncMiddleware, invokeMiddlewares} from './expressAsync'\n\nexport const metricsMid = new (class {\n  stopwatch(metricName, middlewares) {\n    return asyncMiddleware(`metrics.${metricName}`, async (req, res) => {\n      return metrics.stopwatch(metricName, async () => invokeMiddlewares(middlewares, req, res))\n    })\n  }\n})()\n\n","import express from 'express'\r\n\r\n\r\nexport class BasicRouter {\r\n  name = \"Basic\"\r\n  #mhandlers = []\r\n  #routeIdKey = \"id\"\r\n\r\n  constructor() {\r\n    this.router = express.Router()\r\n  }\r\n\r\n  #conditionalHandlers(handlers, ...kwargs) {\r\n    return handlers\r\n  }\r\n\r\n  #fHandlers(handlers, ...kwargs) {\r\n    return [...this.#mhandlers, ...this.#conditionalHandlers(handlers, ...kwargs)]\r\n  }\r\n\r\n  get(path, handlers, ...kwargs) {\r\n    this.router.get(path, this.#fHandlers(handlers, ...kwargs))\r\n    return this\r\n  }\r\n\r\n  post(path, handlers, ...kwargs) {\r\n    this.router.post(path, this.#fHandlers(handlers, ...kwargs))\r\n    return this\r\n  }\r\n\r\n  put(path, handlers, ...kwargs) {\r\n    this.router.put(path, this.#fHandlers(handlers, ...kwargs))\r\n    return this\r\n  }\r\n\r\n  delete(path, handlers, ...kwargs) {\r\n    this.router.delete(path, this.#fHandlers(handlers, ...kwargs))\r\n    return this\r\n  }\r\n\r\n  options(path, handlers, ...kwargs) {\r\n    this.router.options(path, this.#fHandlers(handlers, ...kwargs))\r\n    return this\r\n  }\r\n}\r\n","import {quickApi} from \"../../middlewares/quickApi\"\r\nimport {api} from '../../middlewares/api'\r\nimport {timeout} from \"../../middlewares/timeout\"\r\nimport {asyncRoute} from '../../middlewares/expressAsync'\r\nimport { BasicRouter } from \"./base\"\r\n\r\n\r\nexport class CorsRouter extends BasicRouter {\r\n  name = \"Cors\"\r\n\r\n  get(path, handlers, ...kwargs) {\r\n    this.#cors(path, ...kwargs)\r\n    return super.get(path, handlers, ...kwargs)\r\n  }\r\n\r\n  post(path, handlers, ...kwargs) {\r\n    this.#cors(path, ...kwargs)\r\n    return super.post(path, handlers, ...kwargs)\r\n  }\r\n\r\n  put(path, handlers, ...kwargs) {\r\n    this.#cors(path, ...kwargs)\r\n    return super.put(path, handlers, ...kwargs)\r\n  }\r\n\r\n  delete(path, handlers, ...kwargs) {\r\n    this.#cors(path, ...kwargs)\r\n    return super.delete(path, handlers, ...kwargs)\r\n  }\r\n\r\n  options(path, handlers, ...kwargs) {\r\n    this.#cors(path, ...kwargs)\r\n    return super.options(path, handlers, ...kwargs)\r\n  }\r\n\r\n  #cors(path, ...kwargs) {\r\n    apiId = kwargs[this.routeIdKey]\r\n    this.router.options(path,\r\n      api.setId(apiId),\r\n      timeout.ensure({id: 'full-route', timeoutSecs: 1.0}),\r\n      quickApi.enforcePreflightCors,\r\n      asyncRoute(async (req, res) => {\r\n        res.status(200).end()\r\n      }),\r\n    )\r\n  }\r\n}\r\n","import {quickApi} from \"../../middlewares/quickApi\"\r\nimport {api} from '../../middlewares/api'\r\nimport {timeout} from \"../../middlewares/timeout\"\r\nimport {getModel} from \"../../middlewares/getModel\"\r\nimport {env} from \"../../config/env\"\r\nimport {asyncRoute} from '../../middlewares/expressAsync'\r\nimport {metricsMid} from \"../../middlewares/metrics\"\r\nimport { CorsRouter } from \"./cors\"\r\n\r\n\r\nexport class QuickRouter extends CorsRouter {\r\n\r\n  name = \"Quick\"\r\n\r\n  #mhandlers = [\r\n    quickApi.parseAuthToken,\r\n    getModel.client,\r\n    quickApi.validateClient,\r\n    quickApi.validateApiVisibility,\r\n    quickApi.validateBodyData,\r\n  ]\r\n\r\n\r\n  #conditionalHandlers(handlers, ...kwargs) {\r\n    isFront = kwargs[\"isFront\"]\r\n    apiId = kwargs[\"apiId\"]\r\n\r\n    commonMiddlewares = [      \r\n      api.setId({apiId, clientIsFrontend: isFront}),\r\n      timeout.ensure({id: 'full-route', timeoutSecs: env.quickApiRouteTimeout}),\r\n      metricsMid.stopwatch('api:parseRequestBody', [\r\n        timeout.ensure({httpCodeOverride: 408, id: 'parse-body', timeoutSecs: env.quickApiInputUploadTimeout}, [\r\n          quickApi.parseRequestBody,\r\n        ]),\r\n      ]),\r\n      ...handlers,\r\n    ]\r\n\r\n    publicMiddlewares = [\r\n      api.corsOnError,\r\n      quickApi.enforceCors,\r\n      quickApi.validateAuthToken({secretKey: 'exposedSecret'}),\r\n      quickApi.rateLimit(),\r\n      timeout.blowIfTimedout,\r\n      metricsMid.stopwatch('api:validateRecaptcha', [\r\n        timeout.ensure({id: 'recaptcha-validation', timeoutSecs: env.quickApiRecaptchaTimeout}, [\r\n          quickApi.validateRecaptcha,\r\n        ]),\r\n      ]),\r\n      timeout.blowIfTimedout,\r\n    ]\r\n\r\n    privateMiddlewares = [\r\n      quickApi.validateAuthToken({secretKey: 'secret'}),\r\n      quickApi.rateLimit({ip: false}),\r\n    ]\r\n    if (isFront) {\r\n      return [\r\n        ...commonMiddlewares,\r\n        ...publicMiddlewares,\r\n      ]\r\n    }\r\n    return [\r\n      ...commonMiddlewares,\r\n      ...privateMiddlewares,\r\n    ]\r\n  }\r\n}\r\n\r\n\r\n\r\n","import {QuickSimulationClient} from \"../../models/clients/QuickSimulationClient\"\nimport {simulationResultsUploader} from \"../../models/storage/simulationResultsUploader\"\nimport {QuickSimulation} from \"../../models/database/QuickSimulation\"\nimport {metrics} from '../../instrumentation/metrics'\nimport {env} from \"../../config/env\"\nimport {asyncRoute} from '../../middlewares/expressAsync'\nimport {quickApi} from '../../middlewares/quickApi'\nimport {api} from '../../middlewares/api'\nimport {timeout} from \"../../middlewares/timeout\"\nimport {getNowInMillis} from '../../utils/time'\nimport { QuickRouter } from \"../router/quick\"\n\nconst router = QuickRouter()\n\nexport const synthRouter = router.\npost(\n  '/cosmetic',\n  handlers=[\n    quickApi.dataToQuickSimulation({\n      force: {\n        mode: 'cosmetic',\n        blend: 'poisson',\n      },\n      customizable: ['mixFactor', 'styleMode', 'whiten', 'brightness'],\n    }),\n    newQuickSimulationRoute(),\n  ],\n  id='cosmetic-simulations',\n).\npost(\n  '/ortho',\n  handlers=[\n    quickApi.dataToQuickSimulation({\n      force: {\n        mode: 'ortho',\n        blend: 'poisson',\n        styleMode: 'mix_manual',\n        mixFactor: 0,\n      },\n      customizable: [],\n    }),\n    newQuickSimulationRoute(),\n  ],\n  id='ortho-simulations',\n).\npath(\n  path='/:id',\n  handlers=[\n    patchSimulationRoute(),\n  ],\n  id='patch-simulation',\n)\n\n\nfunction newQuickSimulationRoute() {\n  return asyncRoute(async (req, res) => {\n    const timeoutManager = timeout.getManager(res)\n    const dbSimulation = res.locals.dentQuickSimulation\n    const photo = res.locals.dentParsedBody.images['imgPhoto']\n    const {dentClient: apiClient, dentApiId: apiId} = res.locals\n    const bucket = apiClient.customBucket({api: apiId}) || env.gcloudBucket\n    const googleProjectKey = apiClient.customGoogleProject({api: apiId}) || 'default'\n\n    const simulation = await metrics.stopwatch('api:quickSimulations:runSimulation', async () => {\n      return await timeoutManager.exec(env.quickApiSimulationTimeout, async () => {\n        const client = new QuickSimulationClient()\n        const nextTimeout = Math.round(timeoutManager.nextExpiresAtInSeconds() * 1000.0)\n        const queueTimeout = Math.round(getNowInMillis() + env.quickApiSimulationQueueTimeout * 1000.0)\n        const expiresAt = Math.min(nextTimeout, queueTimeout)\n        quickApi.setSimulationStarted(res)\n        return await client.requestSimulation({\n          id: dbSimulation.id,\n          photo: photo.content,\n          options: dbSimulation.buildJobOptions(),\n          expiresAt,\n          safe: true,\n        })\n      }, {id: 'wait-simulation'})\n    })\n\n    if (!simulation.id) {\n      throw api.newServerError({\n        debugMessage: `Simulation response should have id but got ${simulation}`,\n      })\n    }\n\n    const uploadResults = await metrics.stopwatch('api:quickSimulations:uploadResults', async () => {\n      return await timeoutManager.exec(env.quickApiResultsUploadTimeout, async () => {\n        return await simulationResultsUploader.upload({\n          googleProjectKey,\n          bucket,\n          clientId: apiClient.id,\n          simulation,\n          uploadsConfig: {\n            original: {extensionPlaceholder: photo.filenameExtension},\n            before: {getUrl: true, isPublic: true},\n            result: {getUrl: true, isPublic: true},\n            morphed: {getUrl: false},\n          },\n          info: {\n            ip: req.ip,\n            metadata: dbSimulation.metadata,\n          },\n        })\n      }, {id: 'wait-firestorage-upload'})\n    })\n\n    Object.entries(uploadResults.results).forEach(([resultName, result]) => {\n      if (result.filepath) {\n        dbSimulation.addStorageData({[`${resultName}Path`]: result.filepath})\n      }\n    })\n    dbSimulation.addStorageData({\n      bucket,\n      directoryPath: uploadResults.folderpath,\n    })\n\n    await dbSimulation.save({source: googleProjectKey})\n\n    if (simulation.error) {\n      throw simulation.error\n    }\n\n    const {\n      before: {getUrlSigned: beforeUrl},\n      result: {getUrlSigned: resultUrl},\n    } = uploadResults.results\n\n    res.status(201).json({\n      success: true,\n      simulation: {\n        ...simulationAsJson(dbSimulation),\n        storage: {\n          beforeUrl,\n          resultUrl,\n        }\n      }\n    })\n  })\n}\n\nfunction getSimulationRoute() {\n  return asyncRoute(async (req, res) => {\n    const simulationId = req.params.id\n    const {dentClient: apiClient, dentApiId: apiId, dentClientId: clientId} = res.locals\n    const googleProjectKey = apiClient.customGoogleProject({api: apiId}) || 'default'\n    const dbSimulation = await QuickSimulation.get(simulationId, {source: googleProjectKey})\n    if (!dbSimulation || dbSimulation.clientId !== clientId) {\n      throw api.newNotFoundError()\n    }\n\n    res.status(200).json({\n      success: true,\n      simulation: simulationAsJson(dbSimulation),\n    })\n  })\n}\n\nfunction patchSimulationRoute() {\n  return asyncRoute(async (req, res) => {\n    const simulationId = req.params.id\n    const {dentClient: apiClient, dentApiId: apiId, dentClientId: clientId} = res.locals\n    const googleProjectKey = apiClient.customGoogleProject({api: apiId}) || 'default'\n    const dbSimulation = await QuickSimulation.get(simulationId, {source: googleProjectKey})\n    if (!dbSimulation || dbSimulation.clientId !== clientId) {\n      throw api.newNotFoundError()\n    }\n\n    const {data} = res.locals.dentParsedBody\n    dbSimulation.addMetadata(data)\n    const {errors} = await dbSimulation.save({attrs: ['metadata']})\n\n    res.status(200).json({\n      success: true,\n      simulation: simulationAsJson(dbSimulation),\n    })\n  })\n}\n\nfunction listSimulationsRoute() {\n  return asyncRoute(async (req, res) => {\n    const {dentClient: apiClient, dentApiId: apiId, dentClientId: clientId} = res.locals\n    const googleProjectKey = apiClient.customGoogleProject({api: apiId}) || 'default'\n    const params = Object.assign({}, req.query)\n    params.clientId = clientId\n    const listParams = {filters: params}\n    const dbSimulations = await QuickSimulation.list(listParams, {source: googleProjectKey})\n\n    res.status(200).json({\n      success: true,\n      simulations: dbSimulations.map(s => simulationAsJson(s)) // TODO: Paginate\n    })\n  })\n}\n\nfunction simulationAsJson(dbSimulation) {\n  return {\n    id: dbSimulation.id,\n    createdAt: dbSimulation.createdAt.toDate(),\n    metadata: dbSimulation.metadata,\n    // params: dbSimulation.params,\n  }\n}\n","import {env} from '../../config/env'\nimport {storageFactory} from './storageFactory'\nimport {logger} from '../../instrumentation/logger'\nimport {simpleCrypto} from '../../shared/simpleCrypto'\nimport * as path from 'path'\n\nexport const smileTaskStorage = new (class {\n  async renameReviewedImage(smileTask) {\n    const temporaryFilepath = smileTask.filepathUploadedToReview()\n    const permanentFilepath = smileTask.filepathUploaded\n    return await this.#move(temporaryFilepath, permanentFilepath)\n  }\n\n  async renameUploadedImageToForceRerun(smileTask) {\n    const temporaryFilepath = smileTask.filepathUploadedToReview()\n    const permanentFilepath = smileTask.filepathUploaded\n    try {\n      await this.#move(permanentFilepath, temporaryFilepath)\n    } catch { /* ignore */ }\n    return await this.#move(temporaryFilepath, permanentFilepath)\n  }\n\n  async listResultCandidates(smileTask) {\n    const [items] = await storageFactory()\n    .bucket(env.gcloudBucket)\n    .getFiles({\n      prefix: smileTask.resultsDirectory(),\n      delimiter: \"/\"\n    })\n\n    let results = []\n    items.forEach((storageObj) => {\n      const resultPath = storageObj.name\n      const resultName = path.basename(resultPath)\n      const match = resultName.match(/_after(_.*\\.)(jpe?g|png)/)\n      if (match) {\n        const isTransformed = resultName.includes('_transformed')\n        const brightnessMatch = match[1].match(/[_.]b(\\d+\\.\\d+)[_.]/)\n        const mixFactorMatch = match[1].match(/([_.]mf|[_.])(\\d+\\.\\d+)[_.]/)\n        const whitenMatch = match[1].match(/[_.]w(\\d+\\.\\d+)[_.]/)\n        const blendMatch = match[1].match(/[_.]blend([^_]+)[_.]/)\n        const synthBrightness = brightnessMatch ? Math.round(parseFloat(brightnessMatch[1])*100.0)/100.0 : 1.0\n        const synthMixFactor = mixFactorMatch ? Math.round(parseFloat(mixFactorMatch[2])*100.0)/100.0 : null\n        const synthWhiten = whitenMatch ? Math.round(parseFloat(whitenMatch[1])*100.0)/100.0 : 0.0\n        const blending = blendMatch ? blendMatch[1] : 'replace'\n        results.push({\n          id: this.#resultNameToId(resultName),\n          path: resultPath,\n          synthType: (isTransformed ? 'transformed' : 'interpolated'),\n          brightness: synthBrightness,\n          luminance: synthMixFactor,\n          mixFactor: synthMixFactor,\n          whiten: synthWhiten,\n          blending: blending,\n        })\n      }\n    })\n    results.sort((a,b) => a.mixFactor - b.mixFactor)\n    return results\n  }\n\n  async renameChosenResult(smileTask, resultId) {\n    const resultName = this.#resultIdToName(resultId)\n    const temporaryFilepath = path.join(smileTask.resultsDirectory(), resultName)\n    const permanentFilepath = smileTask.filepathResult\n    return await this.#move(temporaryFilepath, permanentFilepath)\n  }\n\n  #resultNameToId(resultName) {\n    return simpleCrypto.urlSafeBase64(resultName)\n  }\n\n  #resultIdToName(resultId) {\n    return simpleCrypto.urlSafeBase64Decode(resultId)\n  }\n\n  async #move(filepath, newFilepath) {\n    return await new Promise((resolve, reject) => {\n      storageFactory()\n      .bucket(env.gcloudBucket)\n      .file(filepath)\n      .move(newFilepath)\n      .then(() => resolve({exist: true}))\n      .catch(error => {\n        logger.warn(`Couldn't rename ${filepath} to ${newFilepath}. ${error}`)\n        if (error.code === 404) {\n          resolve({exist: false})\n        } else {\n          reject({source: `smileTaskStorage.move(\"${filepath}\",\"${newFilepath}\")`, error: error})\n        }\n      })\n    })\n  }\n})()\n","import express from 'express';\nconst router = express.Router();\n\nimport {SmileTask} from \"../../models/database/SmileTask\"\nimport {smileTaskStorage} from \"../../models/storage/smileTaskStorage\"\nimport {helpers} from '../helpers'\nimport {asyncRoute} from '../../middlewares/expressAsync'\nimport {env} from \"../../config/env\"\n\nrouter.put('/promote-uploaded', asyncRoute(async (req, res) => {\n  const smileTask = res.locals.dentSmileTask\n\n  const {exist} = await smileTaskStorage.renameReviewedImage(smileTask)\n  if (!exist) {\n    return helpers.respondError(res, 404, \"Couldn't find the image to promote\")\n  }\n\n  return res.status(200).json({\"promoted\": true})\n}))\n\nrouter.put('/rerun', asyncRoute(async (req, res) => {\n  const smileTask = res.locals.dentSmileTask\n\n  const {exist} = await smileTaskStorage.renameUploadedImageToForceRerun(smileTask)\n  if (!exist) {\n    return helpers.respondError(res, 404, \"Couldn't find the image to rerun\")\n  }\n\n  return res.status(200).json({\"success\": true})\n}))\n\nrouter.get('/result-candidates', asyncRoute(async (req, res) => {\n  const smileTask = res.locals.dentSmileTask\n  if (!smileTask.hasFinished()) {\n      return helpers.respondError(res, 423, \"The simulation haven't finished yet.\")\n  }\n\n  const candidates = await smileTaskStorage.listResultCandidates(smileTask)\n\n  return res.status(200).json({\"candidates\": candidates})\n}))\n\nrouter.put('/result-candidates/:resultId/promote', asyncRoute(async (req, res) => {\n  const smileTask = res.locals.dentSmileTask\n  if (!smileTask.hasFinished()) {\n      return helpers.respondError(res, 423, \"The simulation haven't finished yet.\")\n  }\n  const resultId = req.params['resultId']\n\n  const {exist} = await smileTaskStorage.renameChosenResult(smileTask, resultId)\n  if (!exist) {\n    return helpers.respondError(res, 404, \"Couldn't find the result candidate\")\n  }\n\n\n  return res.status(200).json({\"promoted\": true})\n}))\n\nexport default router\n","import express from 'express';\nconst router = express.Router();\n\nimport {SmileTask} from \"../../models/database/SmileTask\"\nimport {env} from \"../../config/env\"\n\nrouter.post('/status-update', async (req, res) => {\n  const message = req.body\n  const smileTask = await SmileTask.get(message.smileTaskId)\n  smileTask.status = statusFromMessage(message)\n  await smileTask.save()\n  return res.status(200).send('SUCCESS')\n})\n\nfunction statusFromMessage(message) {\n  const evt = message.event\n  if (evt === 'processing_step') {\n    return message.step\n  }\n  else if (evt === 'error') {\n    return 'error'\n  }\n  else if (evt === 'finished') {\n    return 'finished'\n  }\n}\n\nexport default router\n","import {metrics} from '../instrumentation/metrics'\nimport {api} from '../middlewares/api'\n\n//api.addCallback('info.add', ({addedInfo}) => {\n//})\n\napi.addCallback('tags.add', ({addedTags}) => {\n  for (const label of Object.keys(addedTags)) {\n    const value = addedTags[label]\n    metrics.addTag({label, value})\n  }\n})\n","import './metrics'\nimport {Database} from '../models/database/Database'\nimport Handlebars from 'hbs'\nimport {i18n} from '../shared/i18n'\nimport {env} from './env'\nimport admin from 'firebase-admin'\n\nHandlebars.registerHelper('i18n', key => i18n(key))\n\nlet databaseURL = env.firestoreEmulatorDatabaseUrl\nif (env.isTest() && !databaseURL) databaseURL = 'http://localhost:8080'\n\nfor (const {projectKey, projectId, credentialCfg} of Object.values(env.googleProjects)) {\n  const config = {\n    projectId: projectId || 'dentrino-local',\n  }\n  if (databaseURL) Object.assign(config, {databaseURL})\n  if (credentialCfg) Object.assign(config, {credential: admin.credential.cert(credentialCfg)})\n  setupProject({\n    app: admin.initializeApp(config, projectKey),\n    name: projectKey,\n  })\n}\n\nfunction setupProject(databaseConfig) {\n  const database = Database.build(databaseConfig)\n  Database.setInstance({database})\n}\n","import morgan from 'morgan'\nimport util from 'util'\n\nimport {api} from './api'\n\nmorgan.token('client_id', (req, res) => {\n  const info = api.getInfo(res) || {}\n  const security = info['security'] || {}\n  return security['client-id'] || ''\n})\n\nmorgan.token('params', (req, res) => {\n  const parsedBody = res.locals.dentParsedBody || {}\n  const data = parsedBody.data || {}\n  const imgs = parsedBody.images || {}\n  const dataTokens = Object.keys(data).map((key) => {\n    let valstr = util.inspect(data[key])\n    valstr = truncateEnd(valstr, 15)\n    const keyTruncated = truncateEnd(key, 15)\n    return `${keyTruncated}:${valstr}`\n  })\n  const imgTokens = Object.keys(imgs).map((key) => {\n    const {size, mimetype, originalFilename, extension} = imgs[key]\n    const sizeMb = (size / 1024.0 / 1024.0).toFixed(2)\n    const filename = truncateMiddle(String(originalFilename), 20)\n    const keyTruncated = truncateEnd(key, 20)\n    return `${keyTruncated}:{${filename} ${mimetype} ${(extension || '')} ${sizeMb}mb}`\n  })\n  const dataDesc = truncateEnd(dataTokens.join(' '), 250, '(...)')\n  const imgDesc = truncateEnd(imgTokens.join(' '), 100, '(...)')\n  return `${dataDesc} ${imgDesc}`\n})\n\nmorgan.token('ip', (req, res) => {\n  return req.ip\n})\n\nfunction truncateEnd(str, maxSize, token='...') {\n  if (str.length > maxSize) {\n    str = str.slice(0, maxSize-token.length) + token\n  }\n  return str\n}\n\nfunction truncateMiddle(str, maxSize) {\n  if (str.length > maxSize) {\n    let initSize = Math.floor(maxSize/2.0)\n    let endSize = maxSize - initSize\n    initSize -= 1\n    endSize -= 2\n    str = str.slice(0, initSize) + '...' + str.slice(-endSize-1, -1)\n  }\n  return str\n}\n\nexport const morganLogger = morgan(':date[iso] :method :url :status :response-time ms HTTP/:http-version :ip :client_id [:params]')\n","import createError from 'http-errors'\nimport express from 'express'\nimport path from 'path'\nimport cookieParser from 'cookie-parser'\nimport compression from 'compression'\nimport helmet from 'helmet'\nimport buildStaticify from 'staticify'\nimport Handlebars from 'hbs'\nconst app = express()\n\nimport indexRouter from './routes/index'\nimport instantSimulations from './routes/instant_simulations'\nimport apiSmileTasks from './routes/api/smile_tasks'\nimport apiQuickSimulations from './routes/api/quick_simulations'\nimport internalApiSmileTasks from './routes/internal_api/smile_tasks'\nimport webhooksSmileTasks from './routes/webhooks/smile_tasks'\nimport {logger} from './instrumentation/logger'\nimport {env} from './config/env'\nimport {helpers} from './routes/helpers'\nimport './config/config'\nimport {getModel} from './middlewares/getModel'\nimport {morganLogger} from './middlewares/morganLogger'\nimport {api} from './middlewares/api'\nimport {RichError} from './utils/RichError'\nimport * as Sentry from '@sentry/node'\nimport * as Tracing from '@sentry/tracing'\n\nif (env.isNonLocal()) {\n  Sentry.init({\n    dsn: env.sentryDsn,\n    env: env.name,\n    integrations: [\n      // enable HTTP calls tracing\n      new Sentry.Integrations.Http({ tracing: true }),\n      // enable Express.js middleware tracing\n      new Tracing.Integrations.Express({\n        // to trace all requests to the default router\n        app,\n        // alternatively, you can specify the routes you want to trace:\n        // router: someRouter,\n      }),\n    ],\n  });\n}\n\napp.enable('trust proxy')\n\n// view engine setup\napp.set('views', path.join(__dirname, 'views'));\napp.set('view engine', 'hbs');\n\napp.use(function(req, res, next) {\n  if (env.disableXForwardedForCheck || env.isLocal()) return next();\n  const xForwardedFor = req.header('x-forwarded-for') || ''\n  const ipsCountOnHeader = xForwardedFor.split(',').length\n  if (ipsCountOnHeader !== 2) {\n    const err = new RichError({\n      httpCode: 400,\n      id: 'bad-request',\n      subtype: 'bad-x-forwarded-for',\n      publicMessage: 'Bad Request',\n      debugMessage: `X-Forwarded-For has suspecious value.`,\n      logLevel: 'debug',\n    })\n    return next(err)\n  } else {\n    return next()\n  }\n});\napp.use(Sentry.Handlers.requestHandler());\napp.use(morganLogger);\napp.use(express.urlencoded({ extended: false }));\napp.use(express.json({\n  limit: '2mb',\n  verify: (req, res, buf, encoding) => {\n    req.rawBodyJson = buf.toString(encoding || 'utf8')\n  },\n}));\napp.use(compression());\napp.use(helmet({\n  contentSecurityPolicy: false,\n  crossOriginEmbedderPolicy: false,\n}));\napp.use(cookieParser());\n\nif (env.instSimRouter) {\n  const publicDirPath = path.join(__dirname, '../public')\n  const staticify = buildStaticify(publicDirPath)\n  Handlebars.registerHelper('getVersionedPath', staticify.getVersionedPath)\n  app.use(staticify.middleware)\n  //app.use('/', express.static(publicDirPath));\n  app.use(redirectWwwToNonWww)\n  app.use('/', instantSimulations.router, Sentry.Handlers.errorHandler(), instantSimulations.errorHandler);\n} else {\n  app.use('/', indexRouter);\n  app.use('/api/users/:userId/smile-tasks/', getModel.user, apiSmileTasks);\n  app.use('/public-api/simulations/', apiQuickSimulations({clientIsFrontend: true}));\n  app.use('/api/simulations/', apiQuickSimulations({clientIsFrontend: false}));\n  app.use('/api/67a4abe/smile-tasks/:smileTaskId/', getModel.smileTask, internalApiSmileTasks);\n  app.use('/webhooks/828ffbc/smile-tasks/', webhooksSmileTasks);\n  app.use(Sentry.Handlers.errorHandler());\n}\n\n// catch 404 and forward to error handler\napp.use(function(req, res, next) {\n  const err = api.newNotFoundError()\n  return next(err)\n});\n\napp.use(api.convertToRichError);\n\n// error handler\napp.use(function(err, req, res, next) {\n  let statusCode = 500\n  let data = null\n  if (err instanceof RichError) {\n    const errLogLevel = err.logLevel\n    if (errLogLevel) {\n      logger[errLogLevel](err.logText())\n    }\n    statusCode = err.httpCode\n    data = err.data({isDebug: !env.isProduction(), allInfo: env.isLocal() || env.apiResponsesWithAllDebugData});\n  } else {\n    const message = err.message || err.error || `Unexpected Error: ${JSON.stringify(err)}`\n    statusCode = err.status || 500\n    logger.error(err)\n    data = message\n  }\n\n  if (res.locals.dentCorsOnError) {\n    helpers.setAllowingCors(req, res)\n  }\n  return res.status(statusCode).json({success: false, error: data});\n});\n\nfunction redirectWwwToNonWww(req, res, next) {\n  const host = req.header('host') || ''\n  if (host.match(/^www\\..*/i)) {\n    const nonWwwHost = host.replace(/^www\\./i, '')\n    const protocol = req.protocol\n    const hostAndPath = path.join(nonWwwHost + req.url)\n    return res.redirect(301, `${protocol}://${hostAndPath}`)\n  } else {\n    return next()\n  }\n}\n\nexport default app\n","export class Timeout {\n  constructor(timeout) {\n    this.timeout = timeout\n    this.canceled = false\n    this.onexpiration = null\n    this.restart()\n  }\n\n  restart() {\n    if (this.canceled) return\n    this.expired = false\n    this.executed = false\n    this.scheduleExpiration()\n  }\n\n  onExpiration(func) {\n    if (this.canceled) return\n    if (this.expired && !this.executed) {\n      this.executed = true\n      func()\n    }\n    if (!this.expired) {\n      this.onexpiration = func\n    }\n  }\n\n  scheduleExpiration() {\n    if (this.timeoutid !== undefined) clearTimeout(this.timeoutid)\n    this.timeoutid = setTimeout(() => {\n      this.expires()\n    }, this.timeout)\n  }\n\n  expires() {\n    if (this.canceled) return;\n    this.expired = true\n\n    if (!this.executed && this.onexpiration) {\n      this.executed = true\n      this.onexpiration()\n    }\n\n    if (!this.executed) {\n      this.scheduleExpiration()\n    }\n  }\n\n  cancel() {\n    this.canceled = true\n    if (this.timeoutid !== undefined) clearTimeout(this.timeoutid)\n  }\n}","import WebSocket from 'ws'\nimport {Timeout} from './Timeout'\nimport {logger} from '../instrumentation/logger'\nimport {redisFactory} from '../models/redisFactory'\n\nexport class LocalWebsocketServer {\n  constructor(socket, key, {onTerminate = null, onReceive = null, inactiveTimeout = 30}) {\n    this.onTerminate = onTerminate\n    this.socket = socket\n    this.key = key\n    this.onTerminate = onTerminate\n    this.onReceive = onReceive\n\n    this.server = this.setupWebsocketServer()\n    this.redis = this.setupRedisPubSub()\n    this.timeout = this.setupInactiveTimeout(inactiveTimeout)\n  }\n\n  upgradeRequestToWSConnection(request, head) {\n    this.server.handleUpgrade(request, this.socket, head, (ws) => {\n      this.server.emit('connection', ws, request)\n    })\n  }\n\n  terminate() {\n    if (this.onTerminate) this.onTerminate()\n    this.redis.unsubscribe()\n    this.redis.quit()\n    this.server.close()\n    this.socket.destroy()\n    this.timeout.cancel()\n  }\n\n  setupWebsocketServer() {\n    return new WebSocket.Server({ noServer: true })\n  }\n\n  setupRedisPubSub() {\n    let redis = redisFactory.newRedisPubsub()\n    redis.on('error', () => this.terminate())\n    const pubsubKey = `worker-progress:${this.key}`\n    redis.subscribe(pubsubKey)\n    redis.on('message', (channel, message) => {\n      logger.info(`WebsocketServer ${this.key} - Received message from redis ${channel} ${message}`)\n      if (message === '#QUIT#') {\n        this.terminate()\n        return\n      }\n\n      if (this.onReceive) this.onReceive(JSON.parse(message))\n      this.sendToClients(message)\n      this.timeout.restart()\n    })\n    return redis\n  }\n\n  setupInactiveTimeout(inactiveTimeout) {\n    let timeout = new Timeout(inactiveTimeout * 1000)\n    timeout.onExpiration(() => {\n      logger.info(`WebsocketServer ${this.key} - Timed out (Too long without messages)`)\n      let msg = JSON.stringify({\n        event: 'error',\n        code: 'timeout',\n        message: 'Server are waiting too much for progress.'\n      })\n      this.sendToClients(msg)\n      this.terminate()\n    })\n    return timeout\n  }\n\n  sendToClients(message) {\n    this.server.clients.forEach((client) => {\n      if (client.readyState === WebSocket.OPEN) {\n        client.send(message)\n      }\n    })\n  }\n}\n","import url from 'url'\nimport {redisFactory} from '../models/redisFactory'\nimport {SmileTask} from '../models/database/SmileTask'\nimport {LocalWebsocketServer} from './LocalWebsocketServer'\nimport {logger} from '../instrumentation/logger'\n\nexport class WebsocketServer {\n  static instance() {\n    if (this.singleton === undefined) {\n      this.singleton = new WebsocketServer()\n    }\n    return this.singleton\n  }\n  \n  constructor() {\n    this.localServers = {}\n    this.generalRedis = redisFactory.newRedisPubsub()\n    this.onReceive = null\n  }\n\n  static upgradeRequestsOn(server) {\n    server.on('upgrade', (request, socket, head) => {\n      WebsocketServer.instance().onUpgrade(request, socket, head);\n    });\n  }\n\n  async onUpgrade(request, socket, head) {\n    const pathname = url.parse(request.url).pathname\n\n    const match = pathname.match(/^\\/ws\\/smile-tasks\\/(.*)$/)\n    if (match === null) {\n      socket.destroy()\n      return\n    }\n\n    const taskId = match[1]\n    logger.info(`taskId: ${taskId}`)\n\n    const task = await SmileTask.get(taskId)\n    if (!task) {\n      logger.warn(`WebSocket [DENIED] ${pathname} - SmileTask ${taskId} not found`)\n      socket.destroy()\n      return\n    }\n    const key = task.filepathUploaded\n    logger.info(`SmileTask ${taskId} found`)\n    logger.info(`key: ${key}`)\n\n    if (!this.generalRedis.isOnline) {\n      logger.warn(`WebSocket [DENIED] ${pathname} - Redis is offline`)\n      socket.destroy()\n      return\n    }\n\n    const wsServer = this.findOrCreateLocalServer(socket, key, task)\n    wsServer.upgradeRequestToWSConnection(request, head)\n    logger.info(`WebSocket [SUCCESS] ${pathname}`)\n  }\n\n  findOrCreateLocalServer(socket, key, task) {\n    let wsServer = this.localServers[key]\n    if (wsServer !== undefined) {\n      return wsServer\n    }\n\n    wsServer = new LocalWebsocketServer(socket, key, {\n      onTerminate: () => {\n        delete this.localServers[key]\n      },\n      onReceive: (message) => {\n        if (this.onReceive) this.onReceive(message, task)\n      }\n    })\n    this.localServers[key] = wsServer\n    return wsServer\n  }\n}\n\nexport default WebsocketServer\n","/**\n * Module dependencies.\n */\n\nimport app from './app'\nimport build_debug from 'debug'\nimport http from 'http'\nimport { createTerminus, HealthCheckError } from '@godaddy/terminus'\nimport {WebsocketServer} from './websockets/WebsocketServer'\nimport {env} from './config/env'\nconst debug = build_debug('dentrino-web:server')\n\n/**\n * Get port from environment and store in Express.\n */\n\napp.set('port', env.port);\napp.set('host', env.host);\n\n/**\n * Create HTTP server.\n */\n\nconst server = http.createServer(app);\n\n/**\n * Listen on provided port, on all network interfaces.\n */\n\ncreateTerminus(server, {\n  healthChecks: {\n    '/healthz': async function() {\n      // throw new HealthCheckError('healthcheck failed', ['error1', 'error2', 'error3'])\n      return undefined\n    }\n  }\n});\nserver.listen(env.port, env.host);\nserver.on('error', onError);\nserver.on('listening', onListening);\nWebsocketServer.upgradeRequestsOn(server)\n\n/**\n * Event listener for HTTP server \"error\" event.\n */\n\nfunction onError(error) {\n  if (error.syscall !== 'listen') {\n    throw error;\n  }\n\n  var bind = typeof env.port === 'string'\n    ? 'Pipe ' + env.port\n    : 'Port ' + env.port;\n\n  // handle specific listen errors with friendly messages\n  switch (error.code) {\n    case 'EACCES':\n      console.error(bind + ' requires elevated privileges');\n      process.exit(1);\n      break;\n    case 'EADDRINUSE':\n      console.error(bind + ' is already in use');\n      process.exit(1);\n      break;\n    default:\n      throw error;\n  }\n}\n\n/**\n * Event listener for HTTP server \"listening\" event.\n */\n\nfunction onListening() {\n  var addr = server.address();\n  var bind = typeof addr === 'string'\n    ? 'pipe ' + addr\n    :  addr.address + ':' + addr.port;\n  console.log('Listening on ' + bind);\n}\n"],"sourceRoot":""}